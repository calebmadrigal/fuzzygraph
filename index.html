<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuzzy Graph</title>
    <!-- Alpine.js -->
    <!--<script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>-->
    <script defer src="js/alpine.min.js"></script>
    <!-- Tailwind CSS -->
    <!--<script src="https://cdn.tailwindcss.com"></script>-->
    <script src="js/tailwind.js"></script>
    <script src="js/fuzzygraph.js"></script>
    <!-- <script src="https://unpkg.com/mathjs@14.5.3/lib/browser/math.js"></script> -->
    <script src="js/math.js"></script>
    <script src="js/js-colormaps.js"></script>

    <style>
    .coords {
      position: absolute; right: 6px; bottom: 6px;
      padding: 4px 8px; border-radius: 6px;
      background: rgba(0,0,0,0.6); color: #fff;
      font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      pointer-events: none;
      user-select: none;
    }
    </style>
</head>

<body class="min-h-screen" x-data>
    <!-- Header -->
    <header class="bg-gray-800 text-white h-16 fixed w-full top-0 left-0 z-50">
        <div class="flex items-center justify-between h-full px-4">
            <div class="flex items-center">

                <!-- Logo -->
                <div class="ml-1 w-52">
                    <svg xmlns="http://www.w3.org/2000/svg" width="68.92mm" height="12.21mm" viewBox="0 0 69.92 12.21"
                        preserveAspectRatio="xMidYMid meet" class="w-full h-full">
                        <text x="0.42" y="8.78" font-family="Arial Black" font-size="10.58" stroke="white" fill="white"
                            stroke-width="0.26" style="filter: blur(0.5px);">Fuzzy</text>
                        <text x="34.83" y="8.86" font-family="Arial Black" font-size="10.58" stroke="white" fill="white"
                            stroke-width="0.26">Graph</text>
                    </svg>
                </div>

            </div>
            <div class="flex items-center space-x-4">
                <!-- Desktop Navigation -->
                <nav class="hidden md:flex space-x-4">
                    <div x-data="{shareOpen: false}" class="relative">

                        <button
                            class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700"
                            @click="shareOpen = !shareOpen">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                            </svg>
                            <span>Share</span>
                        </button>

                        <div
                            x-show="shareOpen"
                            @click.outside="shareOpen = false"
                            x-transition.opacity
                            class="absolute left-1/2 -translate-x-1/2 mt-3 w-96 rounded-lg shadow-lg bg-white border border-gray-200 p-4 text-sm text-gray-700 z-50">
                    
                            <!-- Arrow -->
                            <div class="absolute -top-2 left-1/2 -translate-x-1/2 w-3 h-3 rotate-45 bg-white border-l border-t border-gray-200"></div>
                    
                            <p class="font-medium mb-2">Share</p>
                            <p>Share this URL to share this graph</p>

                            <div x-data="{
                                url: window.location.search,
                                copied: false,
                                copyToClipboard() {
                                    navigator.clipboard.writeText(this.url).then(() => {
                                        this.copied = true;
                                        setTimeout(() => this.copied = false, 2000);
                                    });
                                },
                                init() {
                                    const update = () => this.url = window.location.href;
                                    window.addEventListener('popstate', update);
                                    window.addEventListener('hashchange', update);
                                }
                            }" class="w-full max-w-md p-4">
                                <div class="relative">
                                    <input
                                        type="text"
                                        x-model="url"
                                        readonly
                                        class="w-full p-2 pr-20 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                    >
                                    <button
                                        @click="copyToClipboard"
                                        class="absolute right-1 top-1/2 -translate-y-1/2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-200"
                                    >
                                        <span x-show="!copied">Copy</span>
                                        <span x-show="copied">Copied!</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700"
                        @click="$store.ephemeral.showSaveModal = !$store.ephemeral.showSaveModal"
                        >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                        <span>Save</span>
                    </button>

                    <button
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700"
                        @click="$store.ephemeral.showHelpModal = !$store.ephemeral.showHelpModal"
                        >
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M12 21a9 9 0 110-18 9 9 0 010 18z" />
                        </svg>
                        <span>Help</span>
                    </button>

                </nav>


                <!-- Mobile menu button -->
                <button @click="$store.app.mobileMenuOpen = !$store.app.mobileMenuOpen" class="md:hidden p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
        <!-- Mobile Navigation Menu -->
        <div x-show="$store.app.mobileMenuOpen" x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform -translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100 transform translate-y-0"
            x-transition:leave-end="opacity-0 transform -translate-y-2"
            class="absolute top-16 right-0 w-48 bg-gray-800 shadow-lg md:hidden rounded-bl-lg">
            <div class="px-2 py-3 space-y-2">
                <button class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded"
                        @click="$store.ephemeral.showShareModal = !$store.ephemeral.showShareModal">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                    </svg>
                    <span>Share</span>
                </button>
                <button class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded"
                        @click="$store.ephemeral.showSaveModal = !$store.ephemeral.showSaveModal">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                    <span>Save</span>
                </button>
                <button class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded"
                        @click="$store.ephemeral.showHelpModal = !$store.ephemeral.showHelpModal">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M12 21a9 9 0 110-18 9 9 0 010 18z" />
                    </svg>
                    <span>Help</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="flex flex-col md:flex-row pt-16 bg-gray-300">
        <!-- Main Content -->
        <main class="flex-1 order-1 md:order-2 transition-all duration-300 relative"
            :class="{ 'md:ml-64': $store.app.sidebarOpen, 'md:ml-0': !$store.app.sidebarOpen }">
            <!-- Zoom Controls -->
            <div class="absolute top-4 right-4 z-10 flex flex-col gap-0.5">
                <button @click="$store.app.yHeight = $store.app.yHeight * (1/ZOOM_RATE); updateGraph();"
                    class="p-1.5 bg-gray-800 bg-opacity-75 hover:bg-opacity-100 text-white rounded-t-lg shadow-lg transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
                <button @click="$store.app.yHeight = $store.app.yHeight * ZOOM_RATE; updateGraph();"
                    class="p-1.5 bg-gray-800 bg-opacity-75 hover:bg-opacity-100 text-white rounded-b-lg shadow-lg transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                    </svg>
                </button>
            </div>
            <!-- Sidebar Show Button (Desktop) -->
            <button @click="$store.app.sidebarOpen = true"
                class="hidden md:flex items-center justify-center w-6 h-12 bg-gray-800 bg-opacity-50 hover:bg-opacity-75 text-white rounded-r fixed left-0 top-1/2 transform -translate-y-1/2 transition-opacity duration-300"
                :class="{ 'opacity-0 pointer-events-none': $store.app.sidebarOpen, 'opacity-100': !$store.app.sidebarOpen }">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>
            <canvas id="mainCanvas"
                    x-ref="c"
                    class="w-full h-[calc(100vh-4rem)] md:h-[calc(100vh-4rem)] bg-white"
                    @mousedown="$store.app.startDrag($event)"
                    @mouseup="$store.app.endDrag($event)"
                    @mouseleave="$store.app.endDrag($event); $store.app.showError=false"
                    @mouseenter="$store.app.showError=true"
                    @mousemove="const r = $refs.c.getBoundingClientRect();
                                const sx = $refs.c.width / r.width, sy = $refs.c.height / r.height;
                                const windowBounds = calcWindowBounds($store.app.xCenter, $store.app.yCenter, $store.app.yHeight, $refs.c.width, $refs.c.height)
                                var pixelToXMapper = makeLinearMapper([0, $refs.c.width], [windowBounds['xMin'], windowBounds['xMax']], false);
                                var pixelToYMapper = makeLinearMapper([$refs.c.height, 0], [windowBounds['yMin'], windowBounds['yMax']], false);
                                const xPixel = (event.clientX - r.left) * sx;
                                const yPixel = (event.clientY - r.top)  * sy;
                                const x = pixelToXMapper(xPixel);
                                const y = pixelToYMapper(yPixel);
                                const xStr = x.toFixed(3);
                                const yStr = y.toFixed(3);
                                //const pixelValOffset = yPixel * $refs.c.width + xPixel;
                                //const errorStr = $store.app.pixelValues[pixelValOffset];
                                //$store.app.hoverMsg = `(${xStr}, ${yStr}): error = ${errorStr}`;
                                $store.app.hoverMsg = `(${xStr}, ${yStr})`; ">
            </canvas>
            <div class="coords" x-show="$store.app.showError" x-transition>
                <span x-text="$store.app.hoverMsg"></span>
            </div>
        </main>

        <!-- Sidebar - Fixed to bottom on mobile, left side on desktop -->
        <aside
            class="bg-gray-300 text-gray-800 w-full md:w-64 fixed transition-all duration-300 order-2 md:order-1 z-40"
            :class="{
                'bottom-0 md:bottom-auto md:top-16 md:left-0': $store.app.sidebarOpen,
                'bottom-[-1000px] md:bottom-auto md:top-16 md:left-[-1000px]': !$store.app.sidebarOpen
            }">
            <!-- Top Control Bar -->
            <div class="bg-gray-400 text-white p-2 flex justify-between items-center">
                <button @click="$store.app.sidebarOpen = false" class="p-1 hover:bg-gray-700 rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"
                        :class="{ 'rotate-90 md:rotate-180': true }">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19l7-7-7-7" />
                    </svg>
                </button>
            </div>
            <!-- Sidebar Content -->
            <div class="p-4 flex flex-col space-y-8 max-h-[50vh] md:max-h-[calc(100vh-7rem)] overflow-y-auto">
                <!-- Equations Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200">Equation</h3>
                    <div class="space-y-2">
                        <textarea class="w-full h-16 p-2 border border-gray-300 rounded-md resize-y"
                                    :value="$store.app.equations[0]"
                                    @input.debounce.1000ms="$store.app.updateEquation(0, $event.target.value)"
                        placeholder="y=x">
                        </textarea>
                        <!-- For now, only allow one equation for simplicity -->
                        <!-- Dynamic Text Boxes -->
                        <!-- <template x-for="(equation, index) in $store.app.equations" :key="index">
                            <div class="flex items-center space-x-2">
                                <input type="text" @keydown.enter="$store.app.addEquation()"
                                    @input.debounce.1000ms="$store.app.updateEquation(index, $event.target.value)"
                                    :value="$store.app.equations[index]" :id="'eq-' + index"
                                    class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                                    placeholder="Enter equation...">
                                <button @click="$store.app.removeEquation(index)"
                                    class="text-gray-500 hover:text-red-500 focus:outline-none"
                                    :disabled="$store.app.equations.length === 1">
                                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        >
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M6 18L18 6M6 6l12 12" />
                                    </svg>
                                </button>
                            </div>
                        </template> -->
                    </div>
                </div>

                <!-- Controls Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200">Controls</h3>
                    <!-- Fuzzy Level Slider -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Fuzzy Level: <span x-text="parseInt(($store.app.fuzzyLevel / 200) * 100) + '%'"></span>
                        </label>
                        <input type="range" x-model="$store.app.fuzzyLevel" min="0" max="200"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <!-- Axis Toggle Switch -->
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-sm font-medium text-gray-700">Show Axis</span>
                        <button type="button"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                            :class="$store.app.showAxes ? 'bg-blue-600' : 'bg-gray-200'"
                            @click="$store.app.showAxes = !$store.app.showAxes" role="switch"
                            :aria-checked="$store.app.showAxes">
                            <span
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                                :class="$store.app.showAxes ? 'translate-x-5' : 'translate-x-0'">
                            </span>
                        </button>
                    </div>
                </div>

                <!-- Color Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200">Color Map</h3>
                    <!-- Color Map Dropdown -->
                    <div class="relative inline-block max-w-full sm:w-64 w-full">
                        <select x-model="$store.app.colorMap" name="colors"
                          class="block w-full min-w-0 truncate appearance-none rounded-lg border border-gray-300 bg-white py-2 pl-3 pr-10 text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"
                        >
                            <template x-for="c in getColorMapList()" :key="c">
                                <option :value="c" :selected="c === $store.app.colorMap" x-text="c"></option>
                            </template>
                        </select>
                        <!-- Dropdown arrow -->
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                          <svg
                            class="h-4 w-4 text-gray-400"
                            xmlns="http://www.w3.org/2000/svg"
                            fill="none"
                            viewBox="0 0 24 24"
                            stroke="currentColor"
                          >
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                              d="M19 9l-7 7-7-7" />
                          </svg>
                        </div>
                    </div>

                    <!-- Invert Color Switch -->
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-sm font-medium text-gray-700">Invert Color</span>
                        <button type="button"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                            :class="$store.app.invertColor ? 'bg-blue-600' : 'bg-gray-200'"
                            @click="$store.app.invertColor = !$store.app.invertColor" role="switch"
                            :aria-checked="$store.app.invertColor">
                            <span
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out"
                                :class="$store.app.invertColor ? 'translate-x-5' : 'translate-x-0'">
                            </span>
                        </button>
                    </div>

                    <!-- Colormap Cycles -->
                    <!-- <div class="flex items-center justify-between mt-4">
                        <span class="text-sm font-medium text-gray-700">Colormap cycles</span>
                        <input type="number" x-model="$store.app.colorCycles" min="1" step="1"
                            class="w-20 px-2 py-1 border bg-gray-300 rounded-md border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-right">
                    </div> -->

                    <!-- Color Start Offset -->
                    <!-- <div class="flex items-center justify-between mt-4">
                        <span class="text-sm font-medium text-gray-700">Color start offset</span>
                        <input type="number" x-model="$store.app.colorOffset" min="0" max="1" step="0.1"
                            class="w-20 px-2 py-1 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 focus:border-transparent text-right">
                    </div> -->

                    <div class="mt-16 text-center">
                        ~ Built by <a href="https://gods.art" class="text-blue-600 underline hover:text-blue-800 transition-colors duration-200">
                            Caleb Madrigal
                        </a>
                        ~
                    </div>

                </div>

            </div>
    </div>
    </aside>

    <!-- Mobile Show Button (when panel is hidden) -->
    <button @click="$store.app.sidebarOpen = true"
        class="md:hidden fixed bottom-0 left-1/2 transform -translate-x-1/2 bg-gray-800 bg-opacity-50 hover:bg-opacity-75 text-white px-4 py-2 rounded-t transition-all duration-300"
        :class="{ 'opacity-0 pointer-events-none': $store.app.sidebarOpen, 'opacity-100': !$store.app.sidebarOpen }">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
    </button>
    </div>

    <!-- Share modal background -->
    <div
      x-show="$store.ephemeral.showShareModal"
      x-transition.opacity
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center"
      @click="open = false">

      <!-- Modal content -->
      <div
        @click.stop
        x-transition
        class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

        <!-- X button -->
        <button
          @click="$store.ephemeral.showShareModal= false"
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
          &times;
        </button>

        <h2 class="text-xl font-semibold mb-4">Share</h2>
        <div x-data="{
            url: window.location.search,
            copied: false,
            copyToClipboard() {
                navigator.clipboard.writeText(this.url).then(() => {
                    this.copied = true;
                    setTimeout(() => this.copied = false, 2000);
                });
            },
            init() {
                const update = () => this.url = window.location.href;
                window.addEventListener('popstate', update);
                window.addEventListener('hashchange', update);
            }
        }" class="w-full max-w-md p-4">
            <div class="relative">
                <input
                    type="text"
                    x-model="url"
                    readonly
                    class="w-full p-2 pr-20 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <button
                    @click="copyToClipboard"
                    class="absolute right-1 top-1/2 -translate-y-1/2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-200"
                >
                    <span x-show="!copied">Copy</span>
                    <span x-show="copied">Copied!</span>
                </button>
            </div>
        </div>
      </div>
    </div>


    <!-- Save modal background -->
    <div
      x-show="$store.ephemeral.showSaveModal"
      x-transition.opacity
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center"
      @click="open = false">

      <!-- Modal content -->
      <div
        @click.stop
        x-transition
        class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

        <!-- X button -->
        <button
          @click="$store.ephemeral.showSaveModal = false"
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
          &times;
        </button>

        <h2 class="text-xl font-semibold mb-4">Save Image</h2>
        <p class="mb-4">Image save feature coming soon</p>
      </div>
    </div>


    <!-- Help modal background -->
    <div
      x-show="$store.ephemeral.showHelpModal"
      x-transition.opacity
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center"
      @click="open = false">

      <!-- Modal content -->
      <div
        @click.stop
        x-transition
        class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

        <!-- X button -->
        <button
          @click="$store.ephemeral.showHelpModal= false"
          class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
          &times;
        </button>

        <h2 class="text-xl font-semibold mb-4">About FuzzyGraph</h2>
        <p>FuzzyGraph is a non-binary graphing app. This is similar to the concept of <a class="text-blue-600 underline hover:text-blue-800 transition-colors duration-200" href="https://en.wikipedia.org/wiki/Fuzzy_logic">Fuzzy logic</a>.</p>
        <br />
        <p>Most conventional graphing apps show where the left and right side of the equation are EXACTLY equal. By comparison, FuzzyGraph shows the error gradient of the equation... and does not collapse into either TRUE of FALSE, but rather, shows the "shades of gray", choosing colors based on how near or far both sides are to being equal.</p>
        <br />
        <p>This is a project by math artist <a href="https://gods.art" class="text-blue-600 underline hover:text-blue-800 transition-colors duration-200">Caleb Madrigal</a>.</p>
      </div>
    </div>



    <script >
        var firstPass = true;
        // Initialize canvas
        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');

        // Set canvas size to match its display size
        function resizeCanvas() {
            // const rect = canvas.getBoundingClientRect();

            const dpr = window.devicePixelRatio || 1;
            const displayWidth= canvas.clientWidth;
            const displayHeight = canvas.clientHeight;
            canvas.width = displayWidth * dpr;
            canvas.height = displayHeight * dpr;
            ctx.scale(dpr, dpr);

            // canvas.width = rect.width;
            // canvas.height = rect.height;

            // TODO: This is because alpine has not loaded on the first pass... Fix this in a better way
            if (!firstPass) {
                updateGraph();
            }
        }

        // Initial resize
        resizeCanvas();

        // Resize canvas when window is resized
        window.addEventListener('resize', resizeCanvas);

        function updateGraph() {
          const canvas = document.getElementById('mainCanvas');
          const graphConfig = getAppConfig();

          // Compile equations
          parsedEquation = parseEquationString(graphConfig['equations'][0]);
          if (parsedEquation) {
            graphConfig['equationFunction'] = parsedEquation;

            Alpine.store('app').equationFunction = graphConfig['equationFunction'];

            // Actually draw graph (only if equation parses)
            displayGraph(graphConfig, canvas, Alpine);
          }

        }

        /////////////////////////////////////////////////////////////////////////////////////// Handle changes
        function handleChange() {
            var appConfig = Object.entries(Alpine.store('app'))
            resizeCanvas();
            setUrlFromParams();
        }

        /////////////////////////////////////////////////////////////////////////////////////// URL Handling

        function getAppConfig() {
            // TODO: Different scoping to simplify and not need this
            const sessionVars = ['isDragging', 'dragStartX', 'dragStartY', 'nextId',
                                 'xWidth', 'hoverMsg', 'showError', 'pixelValues'];
            const appStore = Alpine.store('app');
            // Filter out functions from the store, keeping only non-function properties
            const appConfig = Object.fromEntries(
                Object.entries(appStore).filter(([key, value]) => (typeof value !== 'function' && !(sessionVars.includes(key))))
            );
            return appConfig;
        }

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
            var results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        function isBooleanString(str) {
            return /^(true|false)$/i.test(str);
        }

        function parseUrlParam(param, value) {
            if (value === null || value === '') return undefined;

            // Handle JSON arrays (e.g., for equations)
            if (value.startsWith('[') && value.endsWith(']')) {
                try {
                    return JSON.parse(value);
                } catch (e) {
                    console.warn(`Failed to parse JSON for param ${param}: ${value}`);
                    return value;
                }
            }

            // Handle booleans
            if (isBooleanString(value)) {
                return JSON.parse(value.toLowerCase());
            }

            // Handle numbers
            if (!isNaN(value) && value.trim() !== '') {
                return parseFloat(value);
            }

            // Return as string for other cases
            return value;
        }

        function setParamsFromUrl() {
            const urlFragmentId = window.location.hash.substr(1);
            const appConfig = getAppConfig();
            const configFromUrl = {};

            // Parse each parameter from the URL
            for (const param in appConfig) {
                if (appConfig.hasOwnProperty(param)) {
                    const paramValue = getParameterByName(param, urlFragmentId);
                    if (paramValue !== null) {
                        configFromUrl[param] = parseUrlParam(param, paramValue);
                    }
                }
            }

            // Update the store with parsed values
            if (Object.keys(configFromUrl).length > 0) {
                Object.assign(Alpine.store('app'), configFromUrl);
            }

            console.log("Parsed config from URL:", configFromUrl);
        }

        function setUrlFromParams() {
            const appConfig = getAppConfig();
            const params = new URLSearchParams();
            for (const [key, value] of Object.entries(appConfig)) {
                const paramValue = Array.isArray(value) ? JSON.stringify(value) : value;
                params.append(key, paramValue);
            }
            const hashStr = `#?${params.toString()}`;
            window.location.hash = hashStr;
        }

        function getColorMapList() {
            var colorMapList = Object.keys(data);
            return colorMapList;
        }

        const defaultConfig = {
            fuzzyLevel: 190,
            colorMap: 'plasma',
            invertColor: true,
            // colorCycles: 1,
            // colorOffset: 0,
            equations: ['x^2+y^2=2'],
            xCenter: 0,
            yCenter: 0,
            yHeight: 6,
            sidebarOpen: true,
            showAxes: true,
            mobileMenuOpen: false,
            version: '0',

            // non-persistent
            isDragging: false,
            dragStartX: 0,
            dragStartY: 0,
            hoverMsg: '',
            showError: false,
            nextId: 1,
            pixelValues: []
        };

        // Initialize Alpine store
        document.addEventListener('alpine:init', () => {

            Alpine.store('ephemeral', {
                showSaveModal: false
            });

            Alpine.store('app', {
                // addEquation() {
                //     this.equations.push('');
                //     setTimeout(() => document.getElementById(`eq-${this.equations.length - 1}`).focus(), 0);
                // },
                updateEquation(index, value) {
                    this.equations = [
                        ...this.equations.slice(0, index),
                        value,
                        ...this.equations.slice(index + 1)
                    ];
                },
                // removeEquation(index) {
                //     this.equations.splice(index, 1);
                //     if (this.equations.length === 0) {
                //         this.equations.push('');
                //     }
                // },

                startDrag(event) {
                    this.dragStartX = event.x;
                    this.dragStartY = event.y;
                    this.isDragging = true;
                },
                endDrag() {
                    if (this.isDragging) {
                        this.updatePosition(event);
                    }
                    this.isDragging = false;
                },
                updatePosition(event) {
                    const canvas = event.target;
                    var xWidth = getXWidth(this.yHeight, canvas.width, canvas.height);
                    this.xWidth = xWidth;

                    var xOffsetPixels = event.x - this.dragStartX;
                    var yOffsetPixels =  event.y - this.dragStartY;

                    // First, we have to convert the offset in pixels into the offset in our graphing window
                    var xOffset = xOffsetPixels * (xWidth / canvas.clientWidth);
                    var yOffset = yOffsetPixels * (this.yHeight / canvas.clientHeight);

                    // Then we need to move the center of our graphing window accordingly
                    this.xCenter = this.xCenter - xOffset;
                    this.yCenter = this.yCenter + yOffset;  // Due to flipped y, negate yOffset (and -1*-1 = 1)

                    this.isDragging = false;
                    updateGraph();
                }
            });

            Object.assign(Alpine.store('app'), defaultConfig);

            Alpine.effect(() => {
                if (firstPass) {
                    setParamsFromUrl();
                    firstPass = false;
                }
                else {
                    handleChange();
                }
            });

            // Watch for sidebarOpen changes specifically
            Alpine.effect(() => {
                Alpine.store('app').sidebarOpen;
                setTimeout(() => resizeCanvas(), 300); // Delay to match transition duration
            });

        });


    </script>
</body>

</html>
