<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuzzy Graph</title>
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    <style>@import "./input.css";</style>

    <style>
        #mainCanvas {
            touch-action: none;
            /* Prevents default touch behaviors like scrolling to allow pan. */
            user-select: none;
        }

        .coords {
            position: absolute;
            right: 6px;
            bottom: 6px;
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            pointer-events: none;
            user-select: none;
            display: none;
        }

        .hidden {
            display: none;
        }

        .keep {
            display: inline;
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 text-white h-16 fixed w-full top-0 left-0 z-50">
        <div class="flex items-center justify-between h-full px-4">
            <div class="flex items-center">

                <!-- Logo -->
                <div class="ml-1 w-52">
                    <svg xmlns="http://www.w3.org/2000/svg" width="68.92mm" height="12.21mm" viewBox="0 0 69.92 12.21"
                        preserveAspectRatio="xMidYMid meet" class="w-full h-full">
                        <text x="0.42" y="8.78" font-family="Arial Black" font-size="10.58" stroke="white" fill="white"
                            stroke-width="0.26" style="filter: blur(0.5px);">Fuzzy</text>
                        <text x="34.83" y="8.86" font-family="Arial Black" font-size="10.58" stroke="white" fill="white"
                            stroke-width="0.26">Graph</text>
                    </svg>
                </div>

            </div>
            <div class="flex items-center space-x-4">
                <!-- Desktop Navigation -->
                <nav class="hidden md:!flex space-x-4">

                    <button id="showShareButton"
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700">
                        <span class="inline text-gray-200 hover:text-gray-300">Share</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                        </svg>
                    </button>

                    <button id="showSaveButton"
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700">
                        <span class="inline text-gray-200">Save</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                    </button>

                    <button id="showHelpButton"
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700">
                        <span class="inline text-gray-200">Help</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M12 21a9 9 0 110-18 9 9 0 010 18z" />
                        </svg>
                    </button>

                </nav>

                <!-- Mobile menu button -->
                <button id="mobileMenuButton" class="md:hidden p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
        <!-- Mobile Navigation Menu -->
        <div id="mobileMenu" x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform -translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100 transform translate-y-0"
            x-transition:leave-end="opacity-0 transform -translate-y-2"
            class="hidden absolute top-16 right-0 w-48 bg-gray-800 shadow-lg md:hidden rounded-bl-lg">
            <div class="px-2 py-3 space-y-2">
                <button id="mobileShowShareButton"
                    class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded">
                    <span class="inline text-gray-200">Share</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                    </svg>
                </button>
                <button id="mobileShowSaveButton"
                    class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded">
                    <span class="inline text-gray-200">Save</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                </button>
                <button id="mobileShowHelpButton"
                    class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded">
                    <span class="inline text-gray-200">Help</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M12 21a9 9 0 110-18 9 9 0 010 18z" />
                    </svg>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="flex flex-col md:flex-row pt-16 bg-gray-300">
        <!-- Main Content -->
        <main id="controlPanel" class="flex-1 order-1 md:order-2 transition-all duration-300 relative">
            <div class="absolute top-4 right-4 z-10 flex flex-col gap-0.5">
                <button id="zoomInButton"
                    class="p-1.5 bg-gray-800 bg-opacity-75 hover:bg-opacity-100 text-white rounded-t-lg shadow-lg transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
                <button id="zoomOutButton"
                    class="p-1.5 bg-gray-800 bg-opacity-75 hover:bg-opacity-100 text-white rounded-b-lg shadow-lg transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                    </svg>
                </button>
            </div>
            <!-- Sidebar Show Button (Desktop) -->
            <button id="openControlPanelButton"
                class="hidden md:!flex items-center justify-center w-6 h-12 bg-gray-800 bg-opacity-50 hover:bg-opacity-75 text-white rounded-r fixed left-0 top-1/2 transform -translate-y-1/2 transition-opacity duration-300">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>

            <canvas id="mainCanvas" class="w-full h-[calc(100vh-4rem)] md:h-[calc(100vh-4rem)] bg-white">
            </canvas>

            <div id="hoverMsgDiv" class="coords">
                <span id="hoverMsg"></span>
            </div>
        </main>

        <!-- Sidebar - Fixed to bottom on mobile, left side on desktop -->
        <aside id="mobileControlPanel"
            class="bg-gray-300 text-gray-800 w-full md:w-64 fixed transition-all duration-300 order-2 md:order-1 z-40">
            <!-- Top Control Bar -->
            <div class="bg-gray-400 text-white p-2 flex justify-between items-center">
                <button id="hideControlPanelButton" class="p-1 hover:bg-gray-700 rounded">
                    <svg class="w-5 h-5 rotate-90 md:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19l7-7-7-7" />
                    </svg>
                </button>
            </div>
            <!-- Sidebar Content -->
            <div class="p-4 flex flex-col space-y-8 max-h-[30vh] md:max-h-[calc(100vh-7rem)] overflow-y-auto">
                <!-- Equation Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200">Equation</h3>
                    <div class="space-y-2">
                        <textarea id="equationInput" class="w-full h-16 p-2 border border-gray-300 rounded-md resize-y"
                            oninput="this.value=this.value.toLowerCase()"
                            autocapitalize="off" spellcheck="false"
                            placeholder="y=x">
                        </textarea>
                    </div>
                </div>

                <!-- Controls Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200">Controls</h3>
                    <!-- Fuzzy Level Slider -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Fuzzy Level: <span id="fuzzyLevelDisplay"></span>
                        </label>
                        <input id="fuzzyInput" type="range" min="0" max="100"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <!-- Axes Toggle Switch -->
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-sm font-medium text-gray-700">Show Axes</span>
                        <button type="button" id="axesToggle"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                            role="switch">
                            <span id="axesOnSlider"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out">
                            </span>
                        </button>
                    </div>
                </div>

                <!-- Color Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200">Color Map</h3>
                    <!-- Color Map Dropdown -->
                    <div class="relative inline-block max-w-full sm:w-64 w-full">
                        <select id="colorMapSelect" name="colors"
                            class="block w-full min-w-0 truncate appearance-none rounded-lg border border-gray-300 bg-white py-2 pl-3 pr-10 text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        <!-- Dropdown arrow -->
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                            <svg class="h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>

                    <!-- Invert Color Switch -->
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-sm font-medium text-gray-700">Invert Color</span>
                        <button id="invertColorButton" type="button"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                            role="switch">
                            <span id="invertColorSlider"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out">
                            </span>
                        </button>
                    </div>

                    <div class="mt-16 text-center flex flex-col justify-end">
                            <span>~ Built by <a href="https://gods.art"
                                class="text-cyan-500 underline hover:text-cyan-300 underline transition-colors duration-200">
                                Caleb Madrigal
                            </a>
                            ~</span>
                    </div>

                </div>

            </div>
    </div>
    </aside>

    <!-- Mobile Show Button (when panel is hidden) -->
    <button id="mobileShowControlPanelButton"
        class="md:hidden fixed bottom-0 left-1/2 transform -translate-x-1/2 bg-gray-800 bg-opacity-50 hover:bg-opacity-75 text-white px-4 py-2 rounded-t transition-all duration-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
    </button>
    </div>

    <!-- Share modal background -->
    <div id="shareModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">

        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="shareModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Share</h2>
            <div class="w-full max-w-md p-4">
                <div class="relative">
                    <input type="text" readonly id="shareUrlInput"
                        class="w-full p-2 pr-20 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="copyUrlButton"
                        class="absolute right-1 top-1/2 -translate-y-1/2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-200">
                        Copy
                    </button>

                </div>
                <div id="copytooltip" style="display: none;">Copied!</div>
            </div>
        </div>
    </div>

    <!-- Save modal background -->
    <div id="saveModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <!-- Modal content -->
        <div x-transition class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="saveModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Save Image</h2>
            <p class="mb-4">Image save feature coming soon</p>
        </div>
    </div>

    <!-- Help modal background -->
    <div id="helpModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">

        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="helpModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">FuzzyGraph v1.0.4</h2>
            <p>FuzzyGraph is the world's first non-binary graphing calculator.</p>
            <br />
            <p>Conventional graphing apps show where the LEFT and RIGHT side of the equation are EXACTLY equal. By
                comparison, FuzzyGraph shows the error gradient of the equation. Instead of collapsing the evaluation
                into either
                TRUE of FALSE, it instead, shows the "shades of gray", choosing colors based on how near or far both
                sides are to being equal.</p>
            <br />
            <p>This non-binary form of evaluation is similar to the concept of <a
                    class="text-cyan-500 underline hover:text-cyan-300 underline transition-colors duration-200"
                    href="https://en.wikipedia.org/wiki/Fuzzy_logic">Fuzzy logic</a> (hence the name "FuzzyGraph").</p>
            <br />
            <p>Project by math artist <a href="https://gods.art"
                    class="text-cyan-500 underline hover:text-cyan-300 underline transition-colors duration-200">Caleb
                    Madrigal</a>.</p>
        </div>
    </div>

    <script>
        window.process = { env: { NODE_ENV: "development" } };
    </script>

    <script type="module">
        import { math } from "mathjs";
        import { atom } from "nanostores";
        import { evaluate_cmap, data as js_colormaps_data } from "./js/js-colormaps";
        import {
            parseEquationString,
            displayGraph,
            calcWindowBounds,
            getXWidth,
            makeLinearMapper,
            ZOOM_RATE
        } from './js/fuzzygraph.js';

        const equation = atom('x^2+y^2=2');
        const fuzzyLevel = atom(50);
        const showAxes = atom(true);
        const colorMap = atom('plasma');
        const invertColor = atom(true);
        const xCenter = atom(0);
        const yCenter = atom(0);
        const yHeight = atom(6);

        const sidebarOpen = atom(true);
        const mobileMenuOpen = atom(false);

        const hoverMsg = atom('');
        const showError = atom(false);

        const showShareModal = atom(false);
        const showSaveModal = atom(false);
        const showHelpModal = atom(false);

        var pixelValuesStore = atom([]);

        function checkCanvasSize(canvas) {
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1
            const rect = canvas.getBoundingClientRect()
            canvas.width = Math.max(1, Math.round(rect.width * dpr))
            canvas.height = Math.max(1, Math.round(rect.height * dpr))
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0) // user-space: CSS pixels
        }

        function paintGraph() {
            console.log('paintGraph()')
            const canvas = document.getElementById('mainCanvas');

            console.log(`equation = ${equation.get()}`);
            // Compile equation using math.js (parseEquationString)
            const parsedEquation = parseEquationString(equation.get());

            if (parsedEquation) {
                console.log('equationParsed');
                var graphConfig = {
                    equationFunction: parsedEquation,
                    fuzzyLevel: fuzzyLevel.get(),
                    colorMap: colorMap.get(),
                    invertColor: invertColor.get(),
                    xCenter: xCenter.get(),
                    yCenter: yCenter.get(),
                    yHeight: yHeight.get(),
                    showAxes: showAxes.get()
                };

                const pixelValuesNew = displayGraph(graphConfig, canvas);
                pixelValuesStore.set(pixelValuesNew);
                hoverMsg.set('');
                document.getElementById('hoverMsgDiv').style.display = 'none';
            } else {
                document.getElementById('hoverMsgDiv').style.display = 'block';
                hoverMsg.set('Equation is invalid');
            }
        }

        // // // // // // // Event handling

        // TOP MENU EVENTS
        showShareModal.listen((visible) => { document.getElementById('shareModal').classList.toggle('hidden', !visible); showURL(); });
        showSaveModal.listen((visible) => { document.getElementById('saveModal').classList.toggle('hidden', !visible); });
        showHelpModal.listen((visible) => { document.getElementById('helpModal').classList.toggle('hidden', !visible); });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                showShareModal.set(false);
                showSaveModal.set(false);
                showHelpModal.set(false);
            }
        });

        // Share logic
        function showURL() {
            setUrlFromParams();
            const shareURL = window.location.href;
            document.getElementById('shareUrlInput').value = shareURL;
        }

        function copyURL() {
            const urlInput = document.getElementById('shareUrlInput');
            urlInput.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                console.error('Failed to copy: ', err);
                alert('Failed to copy URL');
            }
        }

        document.getElementById('copyUrlButton').addEventListener('click', () => { copyURL(); });

        // Small notification to show when the share url was copied
        document.getElementById('shareUrlInput').addEventListener('copy', function (e) {
            // Get input field position
            const rect = document.getElementById('shareUrlInput').getBoundingClientRect();
            const copytooltip = document.getElementById('copytooltip');

            // Position tooltip
            copytooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
            copytooltip.style.left = `${rect.left + window.scrollX}px`;

            // Show tooltip
            copytooltip.style.display = 'block';

            // Hide tooltip after 2 seconds
            setTimeout(() => {
                copytooltip.style.display = 'none';
            }, 2000);
        });

        // Desktop menu buttons
        document.getElementById('showShareButton').addEventListener('click', () => { showShareModal.set(!showShareModal.get()); });
        document.getElementById('showSaveButton').addEventListener('click', () => { showSaveModal.set(!showSaveModal.get()); });
        document.getElementById('showHelpButton').addEventListener('click', () => { showHelpModal.set(!showHelpModal.get()); });

        // Mobile menu buttons
        document.getElementById('mobileShowShareButton').addEventListener('click', () => { showShareModal.set(!showShareModal.get()); });
        document.getElementById('mobileShowSaveButton').addEventListener('click', () => { showSaveModal.set(!showSaveModal.get()); });
        document.getElementById('mobileShowHelpButton').addEventListener('click', () => { showHelpModal.set(!showHelpModal.get()); });

        // Modal X buttons
        document.getElementById('shareModalX').addEventListener('click', () => { showShareModal.set(false); });
        document.getElementById('saveModalX').addEventListener('click', () => { showSaveModal.set(false); });
        document.getElementById('helpModalX').addEventListener('click', () => { showHelpModal.set(false); });

        // Mobile top menu
        mobileMenuOpen.subscribe((visible) => {
            document.getElementById('mobileMenu').classList.toggle('hidden', !visible);
        });

        document.getElementById('mobileMenuButton').addEventListener('click', () => { mobileMenuOpen.set(!mobileMenuOpen.get()); });

        document.getElementById('mobileControlPanel').addEventListener('transitionend', (e) => {
            if (e.propertyName === 'left' || e.propertyName === 'transform' || e.propertyName === 'width') {
                // Layout is final now
                resizeCanvas();
            }
        });

        // CONTROL PANEL
        sidebarOpen.subscribe((visible) => {
            // TODO: Do this using simple visibility?
            document.getElementById('controlPanel').classList.remove('md:ml-64', 'md:ml-0');
            document.getElementById('controlPanel').classList.add(visible ? 'md:ml-64' : 'md:ml-0');

            document.getElementById('openControlPanelButton').classList.remove('opacity-0', 'pointer-events-none', 'opacity-100');
            if (visible) {
                document.getElementById('openControlPanelButton').classList.add('opacity-0', 'pointer-events-none');
            } else {
                document.getElementById('openControlPanelButton').classList.add('opacity-100');
            }

            document.getElementById('mobileControlPanel').classList.remove('bottom-0', 'md:bottom-auto', 'md:top-16',
                'md:left-0', 'bottom-[-1000px]', 'md:bottom-auto',
                'md:top-16', 'md:left-[-1000px]');
            if (visible) {
                document.getElementById('mobileControlPanel').classList.add('bottom-0', 'md:bottom-auto', 'md:top-16', 'md:left-0');
            } else {
                document.getElementById('mobileControlPanel').classList.add('bottom-[-1000px]', 'md:bottom-auto', 'md:top-16', 'md:left-[-1000px]');
            }

            document.getElementById('mobileShowControlPanelButton').classList.remove('opacity-0', 'pointer-events-none', 'opacity-100');

            if (visible) {
                document.getElementById('mobileShowControlPanelButton').classList.add('opacity-0', 'pointer-events-none');
            } else {
                document.getElementById('mobileShowControlPanelButton').classList.add('opacity-100');
            }
        });

        document.getElementById('mobileShowControlPanelButton').addEventListener('click', () => { sidebarOpen.set(true); });
        document.getElementById('openControlPanelButton').addEventListener('click', () => { sidebarOpen.set(true); });
        document.getElementById('hideControlPanelButton').addEventListener('click', () => { sidebarOpen.set(false); });

        // Debounce utility: returns a debounced version of a function
        function debounce(fn, delay = 900) {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn.apply(null, args), delay);
            };
        }

        // CONTROL PANEL / Equation
        equation.subscribe((eq) => {
            document.getElementById('equationInput').value = eq;
            paintGraph();
        });

        document.getElementById('equationInput').addEventListener('input', debounce((event) => {
            equation.set(event.target.value);
        }));

        // CONTROL PANEL / Fuzzy
        fuzzyLevel.subscribe((fuzzyVal) => {
            document.getElementById('fuzzyLevelDisplay').textContent = parseInt(fuzzyVal) + '%';
            document.getElementById('fuzzyInput').value = fuzzyVal;
            paintGraph();
        });
        document.getElementById('fuzzyInput').addEventListener('input', (event) => {
            fuzzyLevel.set(event.target.value);
        });

        // CONTROL PANEL / Show Axes
        showAxes.subscribe((show) => {
            document.getElementById('axesOnSlider').classList.remove('translate-x-5', 'translate-x-0');
            document.getElementById('axesOnSlider').classList.add(show ? 'translate-x-5' : 'translate-x-0');

            document.getElementById('axesToggle').classList.remove('bg-blue-600', 'bg-gray-200');
            document.getElementById('axesToggle').classList.add(show ? 'bg-blue-600' : 'bg-gray-200');

            document.getElementById('axesToggle').setAttribute('aria-checked', show);
        });

        document.getElementById('axesToggle').addEventListener('click', () => {
            showAxes.set(!showAxes.get());
            paintGraph();
        });

        // CONTROL PANEL / Color map
        function getColorMapList() {
            // TODO: Rename the js-matplotlib data to be something other than "data"?
            // var colorMapList = Object.keys(data);
            var colorMapList = Object.keys(js_colormaps_data);
            return colorMapList;
        }

        const colorMapSelect = document.getElementById('colorMapSelect');
        function renderOptions(selectedValue) {
            const colorMaps = getColorMapList();
            colorMapSelect.innerHTML = '';
            colorMaps.forEach((color) => {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                option.selected = color === selectedValue;
                colorMapSelect.appendChild(option);
            });
        }
        colorMap.subscribe((value) => {
            renderOptions(value);
            paintGraph();
        });
        colorMapSelect.addEventListener('change', (event) => {
            colorMap.set(event.target.value);
            paintGraph();
        });

        // CONTROL PANEL / Invert color
        invertColor.subscribe((show) => {
            document.getElementById('invertColorSlider').classList.remove('translate-x-5', 'translate-x-0');
            document.getElementById('invertColorSlider').classList.add(show ? 'translate-x-5' : 'translate-x-0');

            document.getElementById('invertColorButton').classList.remove('bg-blue-600', 'bg-gray-200');
            document.getElementById('invertColorButton').classList.add(show ? 'bg-blue-600' : 'bg-gray-200');

            document.getElementById('invertColorButton').setAttribute('aria-checked', show);
        });

        document.getElementById('invertColorButton').addEventListener('click', () => {
            invertColor.set(!invertColor.get());
            paintGraph();
        });


        // Zoom In
        document.getElementById('zoomInButton').addEventListener('click', () => {
            yHeight.set(yHeight.get() * (1 / ZOOM_RATE));
            paintGraph();
        });
        // Zoom Out
        document.getElementById('zoomOutButton').addEventListener('click', () => {
            yHeight.set(yHeight.get() * ZOOM_RATE);
            paintGraph();
        });

        // // // // // // // Drag and drop to pan

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let dragState = {
            isDragging: false,
            startX: 0,
            startY: 0,
            endX: 0,
            endY: 0
        };

        function drawArrow() {
            ctx.beginPath();
            ctx.moveTo(dragState.startX, dragState.startY);
            ctx.lineTo(dragState.endX, dragState.endY);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Draw arrowhead
            const angle = Math.atan2(dragState.endY - dragState.startY, dragState.endX - dragState.startX);
            const arrowSize = 10;
            ctx.beginPath();
            ctx.moveTo(dragState.endX, dragState.endY);
            ctx.lineTo(
                dragState.endX - arrowSize * Math.cos(angle - Math.PI / 6),
                dragState.endY - arrowSize * Math.sin(angle - Math.PI / 6)
            );
            ctx.moveTo(dragState.endX, dragState.endY);
            ctx.lineTo(
                dragState.endX - arrowSize * Math.cos(angle + Math.PI / 6),
                dragState.endY - arrowSize * Math.sin(angle + Math.PI / 6)
            );
            ctx.stroke();
        }

        function updatePosition(event) {
            const canvas = event.target;
            var xWidth = getXWidth(yHeight.get(), canvas.width, canvas.height);

            var xOffsetPixels = event.x - dragState.startX;
            var yOffsetPixels = event.y - dragState.startY;

            // First, we have to convert the offset in pixels into the offset in our graphing window
            var xOffset = xOffsetPixels * (xWidth / canvas.clientWidth);
            var yOffset = yOffsetPixels * (yHeight.get() / canvas.clientHeight);

            // Then we need to move the center of our graphing window accordingly
            xCenter.set(xCenter.get() - xOffset);
            yCenter.set(yCenter.get() + yOffset);  // Due to flipped y, negate yOffset (and -1*-1 = 1)

            dragState.isDragging = false;

            // TODO: No need for nanostores if we call directly
            paintGraph()
        }

        // Get mouse position relative to canvas
        function getMousePos(event) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            };
        }

        // Mouse down event
        canvas.addEventListener('mousedown', (event) => {
            dragState.startX = event.x;
            dragState.startY = event.y;
            dragState.isDragging = true;
        });

        // Mouse up event
        canvas.addEventListener('mouseup', (event) => {
            dragState.isDragging = false;
            updatePosition(event)
        });

        // Mouse out event to stop dragging if mouse leaves canvas
        canvas.addEventListener('mouseout', () => {
            dragState.isDragging = false;
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Prevent scrolling
            const touch = e.touches[0];
            dragState.startX = touch.clientX;
            dragState.startY = touch.clientY;
            dragState.isDragging = true;
        });

        canvas.addEventListener('touchend', (e) => {
            dragState.isDragging = false;
            const touch = event.changedTouches[0];
            // Make event look like destktop so updatePosition(e) works
            e.x = touch.clientX;
            e.y = touch.clientY;
            updatePosition(e);
        });

        function countLeadingZeros(str) {
            const match = str.match(/^0*/);
            return match ? match[0].length : 0;
        }

        function getDecimalPart(str) {
            const parts = str.split('.');
            return parts.length > 1 ? parts[1] : '';
        }

        function getPrecision() {
            const yHeightVal = yHeight.get();
            if (yHeightVal >= 0.01) {
                return 3;
            } else {
                return countLeadingZeros(getDecimalPart(yHeightVal.toString())) + 3;
            }
        }

        // Show (x, y) = error when the mouse moves over the canvas
        // Mouse move event
        hoverMsg.listen((value) => {
            document.getElementById('hoverMsg').textContent = value;
        });

        canvas.addEventListener('mousemove', (event) => {
            const precision = getPrecision();

            const r = canvas.getBoundingClientRect();
            const sx = canvas.width / r.width, sy = canvas.height / r.height;
            const windowBounds = calcWindowBounds(xCenter.get(), yCenter.get(), yHeight.get(), canvas.width, canvas.height);
            var pixelToXMapper = makeLinearMapper([0, canvas.width], [windowBounds['xMin'], windowBounds['xMax']], false);
            var pixelToYMapper = makeLinearMapper([canvas.height, 0], [windowBounds['yMin'], windowBounds['yMax']], false);
            const xPixel = (event.clientX - r.left) * sx;
            const yPixel = (event.clientY - r.top) * sy;
            const x = pixelToXMapper(xPixel);
            const y = pixelToYMapper(yPixel);
            const xStr = x.toFixed(precision);
            const yStr = y.toFixed(precision);
            document.getElementById('hoverMsgDiv').style.display = 'block';

            const pixelValuesTemp = pixelValuesStore.get();
            if (pixelValuesTemp) {
                const errorVal = pixelValuesTemp[yPixel * canvas.width + xPixel]
                if (errorVal) {
                    const errorValStr = errorVal.toFixed(precision);
                    hoverMsg.set(`(${xStr}, ${yStr}): error = ${errorValStr}`);
                }
            }
        });

        canvas.addEventListener('mouseleave', (event) => {
            document.getElementById('hoverMsgDiv').style.display = 'none';
        });

        // // // // // // // Initialization

        function fitCanvasToDisplay(canvas) {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();

            // Only touch backing store if it actually changed
            const newW = Math.max(1, Math.round(rect.width * dpr));
            const newH = Math.max(1, Math.round(rect.height * dpr));
            if (canvas.width !== newW || canvas.height !== newH) {
                canvas.width = newW;
                canvas.height = newH;
            }

            // Always draw in CSS pixels; map 1 unit = 1 CSS px
            const ctx = canvas.getContext('2d');
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }

        // Set canvas size to match its display size
        function resizeCanvas() {
            fitCanvasToDisplay(canvas);
            paintGraph();
        }

        // Resize canvas when window is resized
        window.addEventListener('resize', resizeCanvas);

        /////////////////////////////////////////////////////////////////////////////////////// URL Handling

        function getAppConfig() {
            var graphConfig = {
                equation: equation.get(),
                fuzzyLevel: fuzzyLevel.get(),
                colorMap: colorMap.get(),
                invertColor: invertColor.get(),
                xCenter: xCenter.get(),
                yCenter: yCenter.get(),
                yHeight: yHeight.get(),
                showAxes: showAxes.get()
            };
            return graphConfig;
        }

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
            var results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        function isBooleanString(str) {
            return /^(true|false)$/i.test(str);
        }

        function parseUrlParam(param, value) {
            if (value === null || value === '') return undefined;

            // Handle JSON arrays (e.g., for equations)
            if (value.startsWith('[') && value.endsWith(']')) {
                try {
                    return JSON.parse(value);
                } catch (e) {
                    console.warn(`Failed to parse JSON for param ${param}: ${value}`);
                    return value;
                }
            }

            // Handle booleans
            if (isBooleanString(value)) {
                return JSON.parse(value.toLowerCase());
            }

            // Handle numbers
            if (!isNaN(value) && value.trim() !== '') {
                return parseFloat(value);
            }

            // Return as string for other cases
            return value;
        }

        function setParamsFromUrl() {
            const urlFragmentId = window.location.hash.substr(1);
            const appConfig = getAppConfig();
            const configFromUrl = {};

            // Parse each parameter from the URL
            for (const param in appConfig) {
                if (appConfig.hasOwnProperty(param)) {
                    const paramValue = getParameterByName(param, urlFragmentId);
                    if (paramValue !== null && paramValue != '') {
                        configFromUrl[param] = parseUrlParam(param, paramValue);
                    }
                }
            }

            // Update stores
            if (configFromUrl['equation'] !== null && typeof configFromUrl['equation'] !== 'undefined') {
                equation.set(configFromUrl['equation']);
            }
            if (configFromUrl['fuzzyLevel'] !== null && typeof configFromUrl['fuzzyLevel'] !== 'undefined') {
                fuzzyLevel.set(configFromUrl['fuzzyLevel']);
            }
            if (configFromUrl['showAxes'] !== null && typeof configFromUrl['showAxes'] !== 'undefined') {
                showAxes.set(configFromUrl['showAxes']);
            }
            if (configFromUrl['colorMap'] !== null && typeof configFromUrl['colorMap'] !== 'undefined') {
                colorMap.set(configFromUrl['colorMap']);
            }
            if (configFromUrl['invertColor'] !== null && typeof configFromUrl['invertColor'] !== 'undefined') {
                invertColor.set(configFromUrl['invertColor']);
            }
            if (configFromUrl['xCenter'] !== null && typeof configFromUrl['xCenter'] !== 'undefined') {
                xCenter.set(configFromUrl['xCenter']);
            }
            if (configFromUrl['yCenter'] !== null && typeof configFromUrl['yCenter'] !== 'undefined') {
                yCenter.set(configFromUrl['yCenter']);
            }
            if (configFromUrl['yHeight'] !== null && typeof configFromUrl['yHeight'] !== 'undefined') {
                yHeight.set(configFromUrl['yHeight']);
            }
        }

        function setUrlFromParams() {
            const appConfig = getAppConfig();
            const params = new URLSearchParams();
            for (const [key, value] of Object.entries(appConfig)) {
                const paramValue = Array.isArray(value) ? JSON.stringify(value) : value;
                params.append(key, paramValue);
            }
            const hashStr = `#?${params.toString()}`;
            window.location.hash = hashStr;
        }

        setParamsFromUrl();

        const ro = new ResizeObserver(() => resizeCanvas());
        ro.observe(document.getElementById('controlPanel'));
        ro.observe(document.getElementById('mainCanvas'));

        function removeResizeObserver() {
            ro.unobserve(document.getElementById('controlPanel'));
            ro.unobserve(document.getElementById('mainCanvas'));
            ro.disconnect();
        }

        window.addEventListener('load', () => {
            requestAnimationFrame(() => {
                resizeCanvas();
                if (document.fonts && document.fonts.ready) {
                    document.fonts.ready.then(resizeCanvas);
                }
            });
        });

        // Allow plenty of time for the page to fully load and for the canvas to resize
        // appropriately. But after that, remove the resize observers so it doesn't slow
        // down the side bar expand/collapse
        setTimeout(() => {
            removeResizeObserver();
        }, 5000);

    </script>
</body>

</html>