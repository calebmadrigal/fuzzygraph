<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuzzy Graph</title>
    <style>
        @import "./input.css";
    </style>

    <style>
        #mainCanvas {
            touch-action: none;
            /* Prevents default touch behaviors like scrolling to allow pan. */
            user-select: none;
        }

        .coords {
            position: absolute;
            left: 6px;
            top: 6px;
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            pointer-events: none;
            user-select: none;
            display: none;
        }

        .tooltip-button {
            position: relative;
            padding: 10px 20px;
            cursor: pointer;
        }

        .tooltip-button::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .tooltip-button:hover::after {
            opacity: 1;
            visibility: visible;
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 text-white h-16 fixed w-full top-0 left-0 z-50">
        <div class="flex items-center justify-between h-full px-4">
            <div class="flex items-center">

                <!-- Logo -->
                <div class="h-fit flex gap-2">
                    <div>
                    <svg xmlns="http://www.w3.org/2000/svg" width="68.92mm" height="12.21mm" viewBox="0 0 69.92 12.21"
                        preserveAspectRatio="xMidYMid meet" class="w-full h-full">
                        <text x="0.42" y="8.78" font-family="Arial Black" font-size="10.58" stroke="white" fill="white"
                            stroke-width="0.26" style="filter: blur(0.5px);">Fuzzy</text>
                        <text x="34.83" y="8.86" font-family="Arial Black" font-size="10.58" stroke="white" fill="white"
                            stroke-width="0.26">Graph</text>
                    </svg>
                    </div>

                    <div>
                    <button id="downloadFuzzyGraphBtn" data-tooltip="Download offline copy of FuzzyGraph"
                    class="hidden md:flex text-white hover:bg-gray-700 items-center px-1 py-3 rounded tooltip-button">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                    </button>
                    </div>
                </div>

            </div>
            <div class="flex items-center space-x-4">
                <!-- Desktop Navigation -->
                <nav class="hidden md:!flex space-x-4">

                    <button id="showShareButton"
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700">
                        <span class="inline text-gray-200 hover:text-gray-300">Share</span>
                        <svg class="w-5 h-5" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500">
                            <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-width: 40px;" d="M 71.335 351.263 C 71.335 351.263 220.824 546.123 425.655 354.919" id="object-0"/>
                            <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-width: 40px;" d="M 244.441 337.303 L 247.495 57.542" id="object-1"/>
                            <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-width: 40px;" d="M 245.927 57.667 C 245.927 57.667 233.676 153.919 163.023 157.325" id="object-2"/>
                            <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; transform-box: fill-box; transform-origin: 50% 50%; stroke-width: 40px;" d="M 324.455 177.087 C 324.455 177.087 314.941 85.607 244.288 82.201" transform="matrix(-1, 0, 0, -1, 4.432068, -20.892017)" id="object-3"/>
                        </svg>
                    </button>

                    <button id="showSaveButton"
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700">
                        <span class="inline text-gray-200">Save</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                    </button>

                    <button id="showOpenButton"
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700">
                        <span class="inline text-gray-200">Open</span>
                        <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 6H12L10 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V8C22 6.9 21.1 6 20 6ZM20 18H4V6H9.17L11.17 8H20V18Z" fill="#000000"/>
                        </svg>
                    </button>

                    <button id="showHelpButton"
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700">
                        <span class="inline text-gray-200">Help</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M12 21a9 9 0 110-18 9 9 0 010 18z" />
                        </svg>
                    </button>

                </nav>

                <!-- Mobile menu button -->
                <button id="mobileMenuButton" class="md:hidden p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Navigation Menu -->
        <div id="mobileMenu" x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform -translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100 transform translate-y-0"
            x-transition:leave-end="opacity-0 transform -translate-y-2"
            class="hidden absolute top-16 right-0 w-48 bg-gray-800 shadow-lg md:hidden rounded-bl-lg">
            <div class="px-2 py-3 space-y-2">

                <button id="mobileShowShareButton"
                    class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded">
                    <span class="inline text-gray-200">Share</span>
                    <svg class="w-5 h-5" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500">
                        <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-width: 40px;" d="M 71.335 351.263 C 71.335 351.263 220.824 546.123 425.655 354.919" id="object-0"/>
                        <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-width: 40px;" d="M 244.441 337.303 L 247.495 57.542" id="object-1"/>
                        <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-width: 40px;" d="M 245.927 57.667 C 245.927 57.667 233.676 153.919 163.023 157.325" id="object-2"/>
                        <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; transform-box: fill-box; transform-origin: 50% 50%; stroke-width: 40px;" d="M 324.455 177.087 C 324.455 177.087 314.941 85.607 244.288 82.201" transform="matrix(-1, 0, 0, -1, 4.432068, -20.892017)" id="object-3"/>
                    </svg>
                </button>

                <button id="mobileShowSaveButton"
                    class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded">
                    <span class="inline text-gray-200">Save</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                </button>

                <button id="mobileShowOpenButton"
                    class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded">
                    <span class="inline text-gray-200">Open</span>
                    <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 6H12L10 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V8C22 6.9 21.1 6 20 6ZM20 18H4V6H9.17L11.17 8H20V18Z" fill="#000000"/>
                    </svg>
                </button>

                <button id="mobileShowHelpButton"
                    class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded">
                    <span class="inline text-gray-200">Help</span>
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M12 21a9 9 0 110-18 9 9 0 010 18z" />
                    </svg>
                </button>

            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="flex flex-col md:flex-row pt-16 bg-gray-300">
        <!-- Main Content -->
        <main id="overCanvasControls" class="flex-1 order-1 md:order-2 transition-all duration-300 relative">
            <div class="absolute top-4 right-4 z-10 flex flex-col gap-0.5">
                <button id="zoomInButton"
                    class="p-1.5 bg-gray-800 bg-opacity-75 hover:bg-opacity-100 text-white rounded-t-lg shadow-lg transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
                <button id="zoomOutButton"
                    class="p-1.5 bg-gray-800 bg-opacity-75 hover:bg-opacity-100 text-white rounded-b-lg shadow-lg transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                    </svg>
                </button>

                <div class="mt-4">
                    <button id="homeButton"
                        class="p-1.5 bg-gray-800 bg-opacity-75 hover:bg-opacity-100 text-white rounded-lg shadow-lg transition-colors duration-200 flex items-center justify-center">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M3 9.5l9-7 9 7M4 10v10a1 1 0 001 1h5V14h4v7h5a1 1 0 001-1V10" />
                        </svg>
                    </button>
                </div>

            </div>
            <!-- Sidebar Show Button (Desktop) -->
            <button id="openControlPanelButton"
                class="hidden md:!flex items-center justify-center w-6 h-12 bg-gray-800 bg-opacity-50 hover:bg-opacity-75 text-white rounded-r fixed left-0 top-1/2 transform -translate-y-1/2 transition-opacity duration-300">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>

            <canvas id="mainCanvas" class="w-full h-[calc(100vh-4rem)] md:h-[calc(100vh-4rem)] bg-white">
            </canvas>

            <div id="hoverMsgDiv" class="coords">
                <span id="hoverMsg">Loading...</span>
            </div>
        </main>

        <!-- Side Control Panel - Fixed to bottom on mobile, left side on desktop -->
        <aside id="controlPanel"
            class="bg-gray-300 text-gray-800 w-full md:w-64 fixed order-2 md:order-1 z-40 bottom-0 md:bottom-auto md:top-16 md:left-0">
            <!-- Top Control Bar -->
            <div class="bg-gray-400 text-white p-2 flex justify-between items-center">
                <button id="hideControlPanelButton" class="p-1 hover:bg-gray-700 rounded">
                    <svg class="w-5 h-5 rotate-90 md:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19l7-7-7-7" />
                    </svg>
                </button>
            </div>
            <!-- Sidebar Content -->
            <div class="p-4 flex flex-col space-y-8 max-h-[30vh] md:max-h-[calc(100vh-7rem)] overflow-y-auto">
                <!-- Equation Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200">Equation</h3>
                    <div class="space-y-2">
                        <textarea id="equationInput" class="w-full h-16 p-2 border border-gray-300 rounded-md resize-y"
                            oninput="this.value=this.value.toLowerCase()" autocapitalize="off" spellcheck="false"
                            placeholder="y=x">
                        </textarea>
                    </div>
                </div>

                <!-- Controls Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200">Controls</h3>
                    <!-- Fuzzy Level Slider -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Fuzzy Level: <span id="fuzzyLevelDisplay"></span>
                        </label>
                        <input id="fuzzyInput" type="range" min="0" max="100"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <!-- Axes Toggle Switch -->
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-sm font-medium text-gray-700">Show Axes</span>
                        <button type="button" id="axesToggle"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                            role="switch">
                            <span id="axesOnSlider"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out">
                            </span>
                        </button>
                    </div>
                </div>

                <!-- Color Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200">Color Map</h3>
                    <!-- Color Map Dropdown -->
                    <div class="relative inline-block max-w-full sm:w-64 w-full">
                        <select id="colorMapSelect" name="colors"
                            class="block w-full min-w-0 truncate appearance-none rounded-lg border border-gray-300 bg-white py-2 pl-3 pr-10 text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        <!-- Dropdown arrow -->
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                            <svg class="h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>

                    <!-- Invert Color Switch -->
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-sm font-medium text-gray-700">Invert Color</span>
                        <button id="invertColorButton" type="button"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                            role="switch">
                            <span id="invertColorSlider"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out">
                            </span>
                        </button>
                    </div>

                    <div class="mt-16 text-center flex flex-col justify-end">
                        <span>~ Built by <a href="https://gods.art"
                                class="text-cyan-500 underline hover:text-cyan-300 underline transition-colors duration-200">
                                Caleb Madrigal
                            </a>
                            ~</span>
                    </div>

                </div>

            </div>
    </div>
    </aside>

    <!-- Mobile Show Button (when panel is hidden) -->
    <button id="mobileShowControlPanelButton"
        class="md:hidden fixed bottom-0 left-1/2 transform -translate-x-1/2 bg-gray-800 bg-opacity-50 hover:bg-opacity-75 text-white px-4 py-2 rounded-t transition-all duration-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
    </button>
    </div>

    <!-- Share modal background -->
    <div id="shareModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">

        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="shareModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Share</h2>
            <div class="w-full max-w-md p-4">
                <div class="relative">
                    <input type="text" readonly id="shareUrlInput"
                        class="w-full p-2 pr-20 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="copyUrlButton"
                        class="absolute right-1 top-1/2 -translate-y-1/2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-200">
                        Copy
                    </button>

                </div>
                <div id="copytooltip" style="display: none;">Copied!</div>
            </div>
        </div>
    </div>

    <!-- Save modal background -->
    <div id="saveModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <!-- Modal content -->
        <div x-transition class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="saveModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Save Image</h2>

            <div class="bg-white w-full max-w-md">
                <!-- Size Inputs -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Size</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="width" class="block text-sm font-medium text-gray-600">Width (pixels)</label>
                            <input 
                                type="number" 
                                id="saveWidthInput" 
                                name="saveWidthInput" 
                                min="0" 
                                step="1" 
                                required 
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter width"
                            >
                        </div>
                        <div>
                            <label for="height" class="block text-sm font-medium text-gray-600">Height (pixels)</label>
                            <input 
                                type="number" 
                                id="saveHeightInput" 
                                name="saveHeightInput" 
                                min="0" 
                                step="1" 
                                required 
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter height"
                            >
                        </div>
                    </div>
                </div>
    
                <!-- Center Inputs -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Center</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="x" class="block text-sm font-medium text-gray-600">X (decimal)</label>
                            <input 
                                type="number" 
                                id="saveCenterXInput" 
                                name="saveCenterXInput" 
                                step="any" 
                                required 
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter x coordinate"
                            >
                        </div>
                        <div>
                            <label for="y" class="block text-sm font-medium text-gray-600">Y (decimal)</label>
                            <input 
                                type="number" 
                                id="saveCenterYInput" 
                                name="saveCenterYInput" 
                                step="any" 
                                required 
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter y coordinate"
                            >
                        </div>
                    </div>
                </div>
    
                <!-- yHeight Input -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Zoom</h3>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="yHeight" class="block text-sm font-medium text-gray-600">yHeight (decimal)</label>
                            <input 
                                type="number" 
                                id="saveYHeightInput" 
                                name="saveYHeightInput" 
                                step="any" 
                                required 
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter yHeight"
                            >
                        </div>
                        <div>&nbsp;</div>
                    </div>

                </div>


                <div class="mb-4">
                    <div class="grid grid-cols-2 gap-4 items-center">
                        <!-- Show Axes -->
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">Show Axes</span>
                            <button 
                                type="button" 
                                id="saveAxesToggle"
                                class="relative inline-flex h-8 w-14 flex-shrink-0 cursor-pointer rounded-full bg-gray-200 border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                                role="switch">
                                <span 
                                    id="saveAxesOnSlider"
                                    class="pointer-events-none inline-block h-7 w-7 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out">
                                </span>
                            </button>
                        </div>
                
                        <!-- Save Image Button -->
                        <div class="flex items-center justify-end">
                            <button 
                                type="button" 
                                id="saveImageButton"
                                class="px-8 py-2 bg-blue-600 text-white font-semibold rounded-md shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center justify-center"
                            >
                                <span class="inline text-gray-200 mr-2">Save Image</span>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>





            </div>
            <!-- <p class="mb-4">Image save feature coming soon</p> -->


        </div>
    </div>
    


    <!-- Open modal background -->
    <div id="openModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <!-- Modal content -->
        <div x-transition class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="openModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Open FuzzyGraph Image</h2>

            <div class="mb-6">
                <!-- File Upload Container -->
                <div class="flex items-center space-x-4">
                  <input
                    id="pngInput"
                    type="file"
                    accept="image/png"
                    class="block p-2 w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-300 dark:bg-gray-800 dark:border-gray-600 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-blue-600 file:text-white hover:file:bg-blue-700 transition"
                  />
                </div>
              
                <!-- Result Display -->
                <pre id="openResult" class="mt-4 rounded text-sm text-gray-200 dark:text-gray-700"></pre>
            </div>


        </div>
    </div>


    <!-- Help modal background -->
    <div id="helpModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">

        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="helpModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">FuzzyGraph v1.0.19</h2>
            <p>FuzzyGraph is the world's first non-binary graphing calculator.</p>
            <br />
            <p>Conventional graphing apps show where the LEFT and RIGHT side of the equation are EXACTLY equal. By
                comparison, FuzzyGraph shows the error gradient of the equation. Instead of collapsing the evaluation
                into either
                TRUE or FALSE, it instead, shows the "shades of gray", choosing colors based on how near or far both
                sides are to being equal at every point in the visible area.</p>
            <br />
            <p>Here is the <a href="https://www.youtube.com/watch?v=DsOyp3-8dug&t=1s" class="text-cyan-500 underline hover:text-cyan-300 underline transition-colors duration-200">Video intro to FuzzyGraph</a>.</p>
            <br />
            <p>Project by math artist <a href="https://gods.art"
                    class="text-cyan-500 underline hover:text-cyan-300 underline transition-colors duration-200">Caleb
                    Madrigal</a>.</p>
        </div>
    </div>

    <script>
        window.process = { env: { NODE_ENV: "development" } };
    </script>

    <script type="module">
        import { math } from "mathjs";
        import { atom } from "nanostores";
        import { evaluate_cmap, data as js_colormaps_data } from "./js/js-colormaps";
        import {
            parseEquationString,
            displayGraph,
            calcWindowBounds,
            getXWidth,
            makeLinearMapper,
            ZOOM_RATE
        } from './js/fuzzygraph.js';

        const equation = atom('x^2+y^2=2');
        const fuzzyLevel = atom(90);
        const showAxes = atom(true);
        const colorMap = atom('plasma');
        const invertColor = atom(true);
        const xCenter = atom(0);
        const yCenter = atom(0);
        const yHeight = atom(6);

        const sidebarOpen = atom(true);
        const mobileMenuOpen = atom(false);

        const hoverMsg = atom('Loading...');
        const showError = atom(false);
        const isLoading = atom(true);

        const showShareModal = atom(false);
        const showSaveModal = atom(false);
        const showOpenModal = atom(false);
        const showHelpModal = atom(false);

        // Save modal variables
        const saveWidth = atom(0);
        const saveHeight = atom(0);
        const saveCenterX = atom(0);
        const saveCenterY = atom(0);
        const saveYHeight = atom(6);
        const saveShowAxes = atom(true);
        const saveDefaultConfig = atom(true);

        var pixelValuesStore = atom([]);

        function checkCanvasSize(canvas) {
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1
            const rect = canvas.getBoundingClientRect()
            canvas.width = Math.max(1, Math.round(rect.width * dpr))
            canvas.height = Math.max(1, Math.round(rect.height * dpr))
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0) // user-space: CSS pixels
        }

        function startLoading() {
            isLoading.set(true);
            document.getElementById('hoverMsgDiv').style.display = 'block';
            hoverMsg.set("Loading...");
        }

        function stopLoading() {
            document.getElementById('hoverMsgDiv').style.display = 'none';
            hoverMsg.set('');
            isLoading.set(false);
        }

        function debounceLatest(fn, delay) {
            let timeoutId;
            return function (...args) {
                // Clear the previous scheduled call
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }

                // Schedule the new call
                timeoutId = setTimeout(() => {
                    fn.apply(this, args);
                }, delay);
            };
        }

        function paintGraph() {
            // startLoading();
            const canvas = document.getElementById('mainCanvas');

            // Compile equation using math.js (parseEquationString)
            const parsedEquation = parseEquationString(equation.get());

            if (parsedEquation) {
                var graphConfig = {
                    equationFunction: parsedEquation,
                    fuzzyLevel: fuzzyLevel.get(),
                    colorMap: colorMap.get(),
                    invertColor: invertColor.get(),
                    xCenter: xCenter.get(),
                    yCenter: yCenter.get(),
                    yHeight: yHeight.get(),
                    showAxes: showAxes.get()
                };

                const pixelValuesNew = displayGraph(graphConfig, canvas);
                stopLoading();
                pixelValuesStore.set(pixelValuesNew);
                // hoverMsg.set('');
                // document.getElementById('hoverMsgDiv').style.display = 'none';
            } else {
                document.getElementById('hoverMsgDiv').style.display = 'block';
                hoverMsg.set('Equation is invalid');
            }
        }

        const paintGraphDebounced = debounceLatest(paintGraph, 1000);

        function scheduleRepaint() {
            startLoading();
            paintGraphDebounced();
        }

        // Download FuzzyGraph

        function downloadFuzzygraph() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'FuzzyGraph.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Save Image

        async function saveImage() {
            let saveCanvas = null;
            if (saveDefaultConfig.get()) {
                // If no defaults were changed in the Save Image modal,
                // we can just copy the image from the main canvas.
                saveCanvas = canvas;
            } else {
                // But if any parameters in the Save Image modal were changed,
                // we need to fully repaint the image in a new off-DOM canvas.
                saveCanvas = document.createElement('canvas');
                saveCanvas.width = saveWidth.get();
                saveCanvas.height = saveHeight.get();

                // Compile equation using math.js (parseEquationString)
                const parsedEquation = parseEquationString(equation.get());

                var graphConfig = {
                    equationFunction: parsedEquation,
                    fuzzyLevel: fuzzyLevel.get(),
                    colorMap: colorMap.get(),
                    invertColor: invertColor.get(),
                    xCenter: parseFloat(saveCenterX.get()),
                    yCenter: parseFloat(saveCenterY.get()),
                    yHeight: parseFloat(saveYHeight.get()),
                    showAxes: saveShowAxes.get()
                };

                displayGraph(graphConfig, saveCanvas);
            }

            const ctx = saveCanvas.getContext('2d');





            // Logic to embed graph config data into the generated png file
            // Add a JSON object as UTF-8 iTXt metadata to a PNG Blob.
            // Returns a new PNG Blob.
            async function addJsonITXtToPng(blob, json, keyword = "graphconfig") {
                // NOTE: This function generated by ChatGPT 5 (2025-09-08)
                const buf = await blob.arrayBuffer();
                const u8  = new Uint8Array(buf);

                // --- sanity check signature ---
                const sig = [137,80,78,71,13,10,26,10];
                for (let i = 0; i < 8; i++) if (u8[i] !== sig[i]) throw new Error("Not a PNG");

                // --- walk chunks to find IEND offset ---
                let p = 8;
                let iendPos = -1;
                while (p + 8 <= u8.length) {
                    const len = readU32(u8, p);          // chunk data length
                    const type = readType(u8, p + 4);    // e.g., 'IHDR','IDAT','IEND'
                    const next = p + 12 + len;           // move past [len][type][data][crc]
                    if (type === "IEND") { iendPos = p; break; }
                    p = next;
                }
                if (iendPos < 0) throw new Error("Malformed PNG (no IEND)");

                // --- build iTXt chunk data (UTF-8, uncompressed) ---
                // iTXt layout:
                // keyword\0 compressionFlag(0|1) compressionMethod(0)
                // languageTag\0 translatedKeyword\0 text(UTF-8 or zlib-compressed UTF-8)
                const enc = new TextEncoder();
                const keywordBytes = enc.encode(keyword);             // ASCII in spec, but encoder is fine
                const langBytes = new Uint8Array(0);                  // empty language tag
                const translatedBytes = new Uint8Array(0);            // empty translated keyword
                const textBytes = enc.encode(JSON.stringify(json));   // your JSON as UTF-8

                const parts = [
                    keywordBytes, zero(),                               // keyword\0
                    u8byte(0),                                          // compressionFlag = 0 (uncompressed)
                    u8byte(0),                                          // compressionMethod = 0
                    langBytes, zero(),                                  // languageTag\0
                    translatedBytes, zero(),                            // translatedKeyword\0
                    textBytes                                           // the text payload
                ];
                const itxtData = concat(parts);

                const itxtChunk = buildChunk("iTXt", itxtData);

                // --- assemble: everything before IEND + our iTXt + IEND..end ---
                const out = new Uint8Array(u8.length + itxtChunk.length);
                out.set(u8.subarray(0, iendPos), 0);
                out.set(itxtChunk, iendPos);
                out.set(u8.subarray(iendPos), iendPos + itxtChunk.length);

                return new Blob([out], { type: "image/png" });

                // -------- helpers --------
                function readU32(a, i)   { return (a[i]<<24 | a[i+1]<<16 | a[i+2]<<8 | a[i+3]) >>> 0; }
                function readType(a, i)  { return String.fromCharCode(a[i],a[i+1],a[i+2],a[i+3]); }
                function u8byte(n)       { return new Uint8Array([n & 255]); }
                function zero()          { return u8byte(0); }
                function concat(arrs) {
                    let len = 0; arrs.forEach(a => len += a.length);
                    const o = new Uint8Array(len);
                    let off = 0; arrs.forEach(a => { o.set(a, off); off += a.length; });
                    return o;
                }
                function buildChunk(type4, data) {
                    const enc = new TextEncoder();
                    const typeBytes = enc.encode(type4); // 4 bytes
                    const lenBytes  = u32BE(data.length);
                    const crcBytes  = u32BE(crc32(join(typeBytes, data)));
                    const out = new Uint8Array(4 + 4 + data.length + 4);
                    out.set(lenBytes, 0);
                    out.set(typeBytes, 4);
                    out.set(data, 8);
                    out.set(crcBytes, 8 + data.length);
                    return out;

                    function join(a,b){ const o=new Uint8Array(a.length+b.length); o.set(a,0); o.set(b,a.length); return o; }
                    function u32BE(n){ const b=new Uint8Array(4); b[0]=n>>>24; b[1]=n>>>16; b[2]=n>>>8; b[3]=n; return b; }
                    function crc32(bytes){
                    let c = 0xFFFFFFFF >>> 0;
                    for (let i=0;i<bytes.length;i++){
                        c = (c ^ bytes[i]) >>> 0;
                        for (let k=0;k<8;k++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) >>> 0 : (c >>> 1) >>> 0;
                    }
                    return (~c) >>> 0;
                    }
                }
            }




            // Helpers
            function downloadBlob(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            }

            function canvasToBlob(canvas, type = 'image/png', quality) {
              return new Promise(resolve => canvas.toBlob(resolve, type, quality));
            }

            // Convert canvas into an in-memory PNG file
            const imgBlob = await canvasToBlob(saveCanvas, 'image/png');

            // Embed graph config data into the PNG file (so it can be re-opened in FuzzyGraph)
            var graphConfig = getAppConfig();
            graphConfig['source'] = 'FuzzyGraph';
            graphConfig['createdDate'] = new Date().toISOString().split('T')[0];
            const imgBlobWithData = await addJsonITXtToPng(imgBlob, graphConfig);

            downloadBlob(imgBlobWithData, 'fuzzygraph_image.png');
        }


        // // // // // // // Open Logic
        const pngInput  = document.getElementById('pngInput');
        const uploadResult = document.getElementById('openResult');

        // var configFromImage = {};
        function loadGraphFromImage(configFromImage) {
            if (configFromImage) {
                setConfigFromObj(configFromImage);
                // Close Open Modal
                showOpenModal.set(false);
                uploadResult.textContent = "";
            }
        }

        pngInput.addEventListener('change', async () => {
            const file = pngInput.files?.[0];
            if (!file) return;
            try {
                const text = await readITXtByKeyword(file, "graphconfig");
                let parsed;
                try { parsed = JSON.parse(text); } catch {}
                loadGraphFromImage(parsed);
            } catch (err) {
                uploadResult.textContent = "No FuzzyGraph config found";
            }
        });

        /** Read iTXt chunk with a given keyword from a PNG Blob/ArrayBuffer. Returns UTF-8 text string. */
        async function readITXtByKeyword(blobOrArrayBuffer, targetKeyword) {
            const ab = blobOrArrayBuffer.arrayBuffer
                        ? await blobOrArrayBuffer.arrayBuffer()
                        : blobOrArrayBuffer;
            const u8 = new Uint8Array(ab);

            // --- PNG signature check ---
            const sig = [137,80,78,71,13,10,26,10];
            for (let i = 0; i < 8; i++) if (u8[i] !== sig[i]) throw new Error("Not a PNG.");

            // --- iterate chunks ---
            let p = 8;
            while (p + 8 <= u8.length) {
                const len  = readU32(u8, p);
                const type = strFrom4(u8, p + 4);
                const dataStart = p + 8;
                const dataEnd   = dataStart + len;
                const next      = dataEnd + 4; // + CRC

                if (dataEnd > u8.length || next > u8.length) break;

                if (type === "iTXt") {
                const maybe = await parseITXt(u8.subarray(dataStart, dataEnd), targetKeyword);
                if (maybe != null) return maybe; // found it
                }
                if (type === "IEND") break;
                p = next;
            }
            throw new Error(`No iTXt chunk with keyword "${targetKeyword}" found.`);
        }

        /** Parse an iTXt chunk and return the UTF-8 text if the keyword matches; else null. */
        async function parseITXt(data, targetKeyword) {
            // iTXt data layout:
            // keyword\0 compressionFlag(1) compressionMethod(1)
            // languageTag\0 translatedKeyword\0 text(UTF-8 or zlib-compressed UTF-8)
            let off = 0;

            const decLatin1 = new TextDecoder("latin1");
            const decUTF8   = new TextDecoder("utf-8");

            const key = readZ(data, off);               off = key.next;
            const keyword = decLatin1.decode(key.bytes); // spec uses Latin-1 for keyword
            if (keyword !== targetKeyword) return null;

            const compressionFlag   = data[off++];
            const compressionMethod = data[off++];
            const lang = readZ(data, off);              off = lang.next; // languageTag (ignored)
            const trkw = readZ(data, off);              off = trkw.next; // translated keyword (ignored)

            let textBytes = data.subarray(off);

            if (compressionFlag === 0) {
                return decUTF8.decode(textBytes);
            } else if (compressionFlag === 1 && compressionMethod === 0) {
                // zlib-compressed UTF-8 text
                const inflated = await inflateZlib(textBytes);
                return decUTF8.decode(inflated);
            } else {
                throw new Error(`Unsupported iTXt compression (flag=${compressionFlag}, method=${compressionMethod}).`);
            }
        }

        /** Inflate zlib bytes using the browserâ€™s DecompressionStream when available (no libs). */
        async function inflateZlib(bytes) {
            if (typeof DecompressionStream === "function") {
                // 'deflate' works for zlib-wrapped DEFLATE streams in modern Chromium/Firefox.
                const ds = new DecompressionStream('deflate');
                const stream = new Blob([bytes]).stream().pipeThrough(ds);
                const buf = await new Response(stream).arrayBuffer();
                return new Uint8Array(buf);
            }
            // Fallback: tell the caller they need a small library (e.g., pako) if their PNG uses compression.
            throw new Error("Compressed iTXt requires DecompressionStream support or a small inflate library.");
        }

        /** Helpers */
        function readU32(a, i) { return ((a[i]<<24) | (a[i+1]<<16) | (a[i+2]<<8) | a[i+3]) >>> 0; }
        function strFrom4(a,i) { return String.fromCharCode(a[i],a[i+1],a[i+2],a[i+3]); }
        function readZ(a, start) {
            let i = start;
            while (i < a.length && a[i] !== 0) i++;
            return { bytes: a.subarray(start, i), next: i + 1 };
        }


        document.getElementById('saveImageButton').addEventListener('click', async () => {
            saveImage();
        });

        saveShowAxes.subscribe((show) => {
            document.getElementById('saveAxesOnSlider').classList.remove('translate-x-6', 'translate-x-0');
            document.getElementById('saveAxesOnSlider').classList.add(show ? 'translate-x-6' : 'translate-x-0');

            document.getElementById('saveAxesToggle').classList.remove('bg-blue-600', 'bg-gray-200');
            document.getElementById('saveAxesToggle').classList.add(show ? 'bg-blue-600' : 'bg-gray-200');

            document.getElementById('saveAxesToggle').setAttribute('aria-checked', show);
        });

        document.getElementById('saveWidthInput').addEventListener('input', (event) => {
            saveWidth.set(event.target.value);
            saveDefaultConfig.set(false);
        });
        document.getElementById('saveHeightInput').addEventListener('input', (event) => {
            saveHeight.set(event.target.value);
            saveDefaultConfig.set(false);
        });
        document.getElementById('saveCenterXInput').addEventListener('input', (event) => {
            saveCenterX.set(event.target.value);
            saveDefaultConfig.set(false);
        });
        document.getElementById('saveCenterYInput').addEventListener('input', (event) => {
            saveCenterY.set(event.target.value);
            saveDefaultConfig.set(false);
        });
        document.getElementById('saveYHeightInput').addEventListener('input', (event) => {
            saveYHeight.set(event.target.value);
            saveDefaultConfig.set(false);
        });
        document.getElementById('saveAxesToggle').addEventListener('click', () => {
            saveShowAxes.set(!saveShowAxes.get());
            saveDefaultConfig.set(false);
        });

        saveWidth.subscribe((val) => {
            document.getElementById('saveWidthInput').value = val;
        });
        saveHeight.subscribe((val) => {
            document.getElementById('saveHeightInput').value = val;
        });
        saveCenterX.subscribe((val) => {
            document.getElementById('saveCenterXInput').value = val;
        });
        saveCenterY.subscribe((val) => {
            document.getElementById('saveCenterYInput').value = val;
        });
        saveYHeight.subscribe((val) => {
            document.getElementById('saveYHeightInput').value = val;
        });

        // // // // // // // Event handling

        // Download offline copy of FuzzyGraph
        document.getElementById("downloadFuzzyGraphBtn").addEventListener('click', downloadFuzzygraph);

        // TOP MENU EVENTS
        showShareModal.listen((visible) => { document.getElementById('shareModal').classList.toggle('hidden', !visible); showURL(); });
        showHelpModal.listen((visible) => { document.getElementById('helpModal').classList.toggle('hidden', !visible); });
        showOpenModal.listen((visible) => { document.getElementById('openModal').classList.toggle('hidden', !visible); });
        showSaveModal.listen((visible) => {
            document.getElementById('saveModal').classList.toggle('hidden', !visible);
            // Set default values in Save Modal form
            if (visible) {
                saveWidth.set(canvas.width);
                saveHeight.set(canvas.height);
                saveCenterX.set(xCenter.get());
                saveCenterY.set(yCenter.get());
                saveYHeight.set(yHeight.get());
                saveShowAxes.set(showAxes.get());
                saveDefaultConfig.set(true);
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                showShareModal.set(false);
                showSaveModal.set(false);
                showOpenModal.set(false);
                showHelpModal.set(false);
            }
        });

        // Share logic
        function showURL() {
            setUrlFromParams();
            const shareURL = window.location.href;
            document.getElementById('shareUrlInput').value = shareURL;
        }

        function copyURL() {
            const urlInput = document.getElementById('shareUrlInput');
            urlInput.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                alert('Failed to copy URL');
            }
        }

        document.getElementById('copyUrlButton').addEventListener('click', () => { copyURL(); });

        // Small notification to show when the share url was copied
        document.getElementById('shareUrlInput').addEventListener('copy', function (e) {
            // Get input field position
            const rect = document.getElementById('shareUrlInput').getBoundingClientRect();
            const copytooltip = document.getElementById('copytooltip');

            // Position tooltip
            copytooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
            copytooltip.style.left = `${rect.left + window.scrollX}px`;

            // Show tooltip
            copytooltip.style.display = 'block';

            // Hide tooltip after 2 seconds
            setTimeout(() => {
                copytooltip.style.display = 'none';
            }, 2000);
        });

        // Desktop menu buttons
        document.getElementById('showShareButton').addEventListener('click', () => { showShareModal.set(!showShareModal.get()); });
        document.getElementById('showSaveButton').addEventListener('click', () => { showSaveModal.set(!showSaveModal.get()); });
        document.getElementById('showOpenButton').addEventListener('click', () => { showOpenModal.set(!showOpenModal.get()); });
        document.getElementById('showHelpButton').addEventListener('click', () => { showHelpModal.set(!showHelpModal.get()); });

        // Mobile menu buttons
        document.getElementById('mobileShowShareButton').addEventListener('click', () => { showShareModal.set(!showShareModal.get()); });
        document.getElementById('mobileShowSaveButton').addEventListener('click', () => { showSaveModal.set(!showSaveModal.get()); });
        document.getElementById('mobileShowOpenButton').addEventListener('click', () => { showOpenModal.set(!showOpenModal.get()); });
        document.getElementById('mobileShowHelpButton').addEventListener('click', () => { showHelpModal.set(!showHelpModal.get()); });

        // Modal X buttons
        document.getElementById('shareModalX').addEventListener('click', () => { showShareModal.set(false); });
        document.getElementById('saveModalX').addEventListener('click', () => { showSaveModal.set(false); });
        document.getElementById('openModalX').addEventListener('click', () => { showOpenModal.set(false); });
        document.getElementById('helpModalX').addEventListener('click', () => { showHelpModal.set(false); });

        // Mobile top menu
        mobileMenuOpen.subscribe((visible) => {
            document.getElementById('mobileMenu').classList.toggle('hidden', !visible);
        });

        document.getElementById('mobileMenuButton').addEventListener('click', () => { mobileMenuOpen.set(!mobileMenuOpen.get()); });

        // document.getElementById('controlPanel').addEventListener('transitionend', (e) => {
        //     if (e.propertyName === 'left' || e.propertyName === 'transform' || e.propertyName === 'width') {
        //         // Layout is final now
        //         resizeCanvas();
        //     }
        // });

        // CONTROL PANEL
        sidebarOpen.subscribe((visible) => {
            // TODO: Do this using simple visibility?
            document.getElementById('overCanvasControls').classList.remove('md:ml-64', 'md:ml-0');
            document.getElementById('overCanvasControls').classList.add(visible ? 'md:ml-64' : 'md:ml-0');

            document.getElementById('openControlPanelButton').classList.remove('opacity-0', 'pointer-events-none', 'opacity-100');
            if (visible) {
                document.getElementById('openControlPanelButton').classList.add('opacity-0', 'pointer-events-none');
            } else {
                document.getElementById('openControlPanelButton').classList.add('opacity-100');
            }

            document.getElementById('controlPanel').classList.remove('bottom-0', 'md:bottom-auto', 'md:top-16',
                'md:left-0', 'bottom-[-1000px]', 'md:bottom-auto',
                'md:top-16', 'md:left-[-1000px]');
            if (visible) {
                document.getElementById('controlPanel').classList.add('bottom-0', 'md:bottom-auto', 'md:top-16', 'md:left-0');
            } else {
                document.getElementById('controlPanel').classList.add('bottom-[-1000px]', 'md:bottom-auto', 'md:top-16', 'md:left-[-1000px]');
            }

            document.getElementById('mobileShowControlPanelButton').classList.remove('opacity-0', 'pointer-events-none', 'opacity-100');

            if (visible) {
                document.getElementById('mobileShowControlPanelButton').classList.add('opacity-0', 'pointer-events-none');
            } else {
                document.getElementById('mobileShowControlPanelButton').classList.add('opacity-100');
            }
        });

        document.getElementById('mobileShowControlPanelButton').addEventListener('click', () => { sidebarOpen.set(true); });
        document.getElementById('openControlPanelButton').addEventListener('click', () => { sidebarOpen.set(true); });
        document.getElementById('hideControlPanelButton').addEventListener('click', () => { sidebarOpen.set(false); });

        // CONTROL PANEL / Equation
        equation.subscribe((eq) => {
            document.getElementById('equationInput').value = eq;
            scheduleRepaint();
        });

        document.getElementById('equationInput').addEventListener('input', (event) => {
            equation.set(event.target.value);
        });

        // CONTROL PANEL / Fuzzy
        fuzzyLevel.subscribe((fuzzyVal) => {
            document.getElementById('fuzzyLevelDisplay').textContent = parseInt(fuzzyVal) + '%';
            document.getElementById('fuzzyInput').value = fuzzyVal;
            scheduleRepaint();
        });
        document.getElementById('fuzzyInput').addEventListener('input', (event) => {
            fuzzyLevel.set(event.target.value);
        });

        // CONTROL PANEL / Show Axes
        showAxes.subscribe((show) => {
            document.getElementById('axesOnSlider').classList.remove('translate-x-5', 'translate-x-0');
            document.getElementById('axesOnSlider').classList.add(show ? 'translate-x-5' : 'translate-x-0');

            document.getElementById('axesToggle').classList.remove('bg-blue-600', 'bg-gray-200');
            document.getElementById('axesToggle').classList.add(show ? 'bg-blue-600' : 'bg-gray-200');

            document.getElementById('axesToggle').setAttribute('aria-checked', show);
        });

        document.getElementById('axesToggle').addEventListener('click', () => {
            showAxes.set(!showAxes.get());
            scheduleRepaint();
        });

        // CONTROL PANEL / Color map
        function getColorMapList() {
            // TODO: Rename the js-matplotlib data to be something other than "data"?
            // var colorMapList = Object.keys(data);
            var colorMapList = Object.keys(js_colormaps_data);
            return colorMapList;
        }

        const colorMapSelect = document.getElementById('colorMapSelect');
        function renderOptions(selectedValue) {
            const colorMaps = getColorMapList();
            colorMapSelect.innerHTML = '';
            colorMaps.forEach((color) => {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                option.selected = color === selectedValue;
                colorMapSelect.appendChild(option);
            });
        }
        colorMap.subscribe((value) => {
            renderOptions(value);
            scheduleRepaint();
        });
        colorMapSelect.addEventListener('change', (event) => {
            colorMap.set(event.target.value);
            scheduleRepaint();
        });

        // CONTROL PANEL / Invert color
        invertColor.subscribe((show) => {
            document.getElementById('invertColorSlider').classList.remove('translate-x-5', 'translate-x-0');
            document.getElementById('invertColorSlider').classList.add(show ? 'translate-x-5' : 'translate-x-0');

            document.getElementById('invertColorButton').classList.remove('bg-blue-600', 'bg-gray-200');
            document.getElementById('invertColorButton').classList.add(show ? 'bg-blue-600' : 'bg-gray-200');

            document.getElementById('invertColorButton').setAttribute('aria-checked', show);
        });

        document.getElementById('invertColorButton').addEventListener('click', () => {
            invertColor.set(!invertColor.get());
            scheduleRepaint();
        });


        // Zoom In
        document.getElementById('zoomInButton').addEventListener('click', () => {
            yHeight.set(yHeight.get() * (1 / ZOOM_RATE));
            scheduleRepaint();
        });
        // Zoom Out
        document.getElementById('zoomOutButton').addEventListener('click', () => {
            yHeight.set(yHeight.get() * ZOOM_RATE);
            scheduleRepaint();
        });
        // Home
        document.getElementById('homeButton').addEventListener('click', () => {
            yHeight.set(6);
            xCenter.set(0);
            yCenter.set(0);
            scheduleRepaint();
        });


        // // // // // // // Drag and drop to pan

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let dragState = {
            isDragging: false,
            startX: 0,
            startY: 0,
            endX: 0,
            endY: 0
        };

        function drawArrow() {
            ctx.beginPath();
            ctx.moveTo(dragState.startX, dragState.startY);
            ctx.lineTo(dragState.endX, dragState.endY);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Draw arrowhead
            const angle = Math.atan2(dragState.endY - dragState.startY, dragState.endX - dragState.startX);
            const arrowSize = 10;
            ctx.beginPath();
            ctx.moveTo(dragState.endX, dragState.endY);
            ctx.lineTo(
                dragState.endX - arrowSize * Math.cos(angle - Math.PI / 6),
                dragState.endY - arrowSize * Math.sin(angle - Math.PI / 6)
            );
            ctx.moveTo(dragState.endX, dragState.endY);
            ctx.lineTo(
                dragState.endX - arrowSize * Math.cos(angle + Math.PI / 6),
                dragState.endY - arrowSize * Math.sin(angle + Math.PI / 6)
            );
            ctx.stroke();
        }

        function updatePosition(event) {
            const canvas = event.target;
            var xWidth = getXWidth(yHeight.get(), canvas.width, canvas.height);

            var xOffsetPixels = event.x - dragState.startX;
            var yOffsetPixels = event.y - dragState.startY;

            // First, we have to convert the offset in pixels into the offset in our graphing window
            var xOffset = xOffsetPixels * (xWidth / canvas.clientWidth);
            var yOffset = yOffsetPixels * (yHeight.get() / canvas.clientHeight);

            // Then we need to move the center of our graphing window accordingly
            xCenter.set(xCenter.get() - xOffset);
            yCenter.set(yCenter.get() + yOffset);  // Due to flipped y, negate yOffset (and -1*-1 = 1)

            dragState.isDragging = false;

            // TODO: No need for nanostores if we call directly
            scheduleRepaint();
        }

        // Get mouse position relative to canvas
        function getMousePos(event) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            };
        }

        // Mouse down event
        canvas.addEventListener('mousedown', (event) => {
            dragState.startX = event.x;
            dragState.startY = event.y;
            dragState.isDragging = true;
        });

        // Mouse up event
        canvas.addEventListener('mouseup', (event) => {
            dragState.isDragging = false;
            updatePosition(event)
        });

        // Mouse out event to stop dragging if mouse leaves canvas
        canvas.addEventListener('mouseout', () => {
            dragState.isDragging = false;
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Prevent scrolling
            const touch = e.touches[0];
            dragState.startX = touch.clientX;
            dragState.startY = touch.clientY;
            dragState.isDragging = true;
        });

        canvas.addEventListener('touchend', (e) => {
            dragState.isDragging = false;
            const touch = event.changedTouches[0];
            // Make event look like destktop so updatePosition(e) works
            e.x = touch.clientX;
            e.y = touch.clientY;
            updatePosition(e);
        });

        function countLeadingZeros(str) {
            const match = str.match(/^0*/);
            return match ? match[0].length : 0;
        }

        function getDecimalPart(str) {
            const parts = str.split('.');
            return parts.length > 1 ? parts[1] : '';
        }

        function getPrecision() {
            const yHeightVal = yHeight.get();
            if (yHeightVal >= 0.01) {
                return 3;
            } else {
                return countLeadingZeros(getDecimalPart(yHeightVal.toString())) + 3;
            }
        }

        // Show (x, y) = error when the mouse moves over the canvas
        // Mouse move event
        hoverMsg.listen((value) => {
            document.getElementById('hoverMsg').textContent = value;
        });

        canvas.addEventListener('mousemove', (event) => {
            // Don't overwrite the "Loading..." message
            if (isLoading.get()) return;

            const precision = getPrecision();

            const r = canvas.getBoundingClientRect();
            const sx = canvas.width / r.width, sy = canvas.height / r.height;
            const windowBounds = calcWindowBounds(xCenter.get(), yCenter.get(), yHeight.get(), canvas.width, canvas.height);
            var pixelToXMapper = makeLinearMapper([0, canvas.width], [windowBounds['xMin'], windowBounds['xMax']], false);
            var pixelToYMapper = makeLinearMapper([canvas.height, 0], [windowBounds['yMin'], windowBounds['yMax']], false);
            const xPixel = (event.clientX - r.left) * sx;
            const yPixel = (event.clientY - r.top) * sy;
            const x = pixelToXMapper(xPixel);
            const y = pixelToYMapper(yPixel);
            const xStr = x.toFixed(precision);
            const yStr = y.toFixed(precision);
            document.getElementById('hoverMsgDiv').style.display = 'block';

            const pixelValuesTemp = pixelValuesStore.get();
            if (pixelValuesTemp) {
                const errorVal = pixelValuesTemp[yPixel * canvas.width + xPixel]
                if (errorVal) {
                    const errorValStr = errorVal.toFixed(precision);
                    hoverMsg.set(`(${xStr}, ${yStr}): error = ${errorValStr}`);
                }
            }
        });

        canvas.addEventListener('mouseleave', (event) => {
            if (isLoading.get()) return;  // Don't overwrite "Loading..." message
            document.getElementById('hoverMsgDiv').style.display = 'none';
        });

        // // // // // // // Initialization

        function fitCanvasToDisplay(canvas) {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();

            // Only touch backing store if it actually changed
            const newW = Math.max(1, Math.round(rect.width * dpr));
            const newH = Math.max(1, Math.round(rect.height * dpr));
            if (canvas.width !== newW || canvas.height !== newH) {
                canvas.width = newW;
                canvas.height = newH;
            }

            // Always draw in CSS pixels; map 1 unit = 1 CSS px
            const ctx = canvas.getContext('2d');
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }

        // Set canvas size to match its display size
        function resizeCanvas() {
            fitCanvasToDisplay(canvas);
            scheduleRepaint();
        }

        // Resize canvas when window is resized
        // window.addEventListener('resize', resizeCanvas);

        /////////////////////////////////////////////////////////////////////////////////////// URL Handling

        function getAppConfig() {
            var graphConfig = {
                equation: equation.get(),
                fuzzyLevel: fuzzyLevel.get(),
                colorMap: colorMap.get(),
                invertColor: invertColor.get(),
                xCenter: xCenter.get(),
                yCenter: yCenter.get(),
                yHeight: yHeight.get(),
                showAxes: showAxes.get()
            };
            return graphConfig;
        }

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
            var results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        function isBooleanString(str) {
            return /^(true|false)$/i.test(str);
        }

        function parseUrlParam(param, value) {
            if (value === null || value === '') return undefined;

            // Handle JSON arrays (e.g., for equations)
            if (value.startsWith('[') && value.endsWith(']')) {
                try {
                    return JSON.parse(value);
                } catch (e) {
                    console.warn(`Failed to parse JSON for param ${param}: ${value}`);
                    return value;
                }
            }

            // Handle booleans
            if (isBooleanString(value)) {
                return JSON.parse(value.toLowerCase());
            }

            // Handle numbers
            if (!isNaN(value) && value.trim() !== '') {
                return parseFloat(value);
            }

            // Return as string for other cases
            return value;
        }

        function setConfigFromObj(configObj) {
            // Update stores
            if (configObj['equation'] !== null && typeof configObj['equation'] !== 'undefined') {
                equation.set(configObj['equation']);
            }
            if (configObj['fuzzyLevel'] !== null && typeof configObj['fuzzyLevel'] !== 'undefined') {
                fuzzyLevel.set(configObj['fuzzyLevel']);
            }
            if (configObj['showAxes'] !== null && typeof configObj['showAxes'] !== 'undefined') {
                showAxes.set(configObj['showAxes']);
            }
            if (configObj['colorMap'] !== null && typeof configObj['colorMap'] !== 'undefined') {
                colorMap.set(configObj['colorMap']);
            }
            if (configObj['invertColor'] !== null && typeof configObj['invertColor'] !== 'undefined') {
                invertColor.set(configObj['invertColor']);
            }
            if (configObj['xCenter'] !== null && typeof configObj['xCenter'] !== 'undefined') {
                xCenter.set(configObj['xCenter']);
            }
            if (configObj['yCenter'] !== null && typeof configObj['yCenter'] !== 'undefined') {
                yCenter.set(configObj['yCenter']);
            }
            if (configObj['yHeight'] !== null && typeof configObj['yHeight'] !== 'undefined') {
                yHeight.set(configObj['yHeight']);
            }
        }

        function setParamsFromUrl() {
            const urlFragmentId = window.location.hash.substr(1);
            const appConfig = getAppConfig();
            const configFromUrl = {};

            // Parse each parameter from the URL
            for (const param in appConfig) {
                if (appConfig.hasOwnProperty(param)) {
                    const paramValue = getParameterByName(param, urlFragmentId);
                    if (paramValue !== null && paramValue != '') {
                        configFromUrl[param] = parseUrlParam(param, paramValue);
                    }
                }
            }

            setConfigFromObj(configFromUrl);
        }

        function setUrlFromParams() {
            const appConfig = getAppConfig();
            const params = new URLSearchParams();
            for (const [key, value] of Object.entries(appConfig)) {
                const paramValue = Array.isArray(value) ? JSON.stringify(value) : value;
                params.append(key, paramValue);
            }
            const hashStr = `#?${params.toString()}`;
            window.location.hash = hashStr;
        }

        setParamsFromUrl();

        const ro = new ResizeObserver(() => resizeCanvas());
        ro.observe(document.getElementById('overCanvasControls'));
        ro.observe(document.getElementById('mainCanvas'));

        function removeResizeObserver() {
            ro.unobserve(document.getElementById('overCanvasControls'));
            ro.unobserve(document.getElementById('mainCanvas'));
            ro.disconnect();
        }

        window.addEventListener('load', () => {
            requestAnimationFrame(() => {
                resizeCanvas();
                if (document.fonts && document.fonts.ready) {
                    document.fonts.ready.then(resizeCanvas);
                }
            });
        });

    </script>
</body>

</html>