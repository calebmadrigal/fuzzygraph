<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuzzy Graph</title>
    <script defer src="js/alpine.min.js"></script>
    <script src="js/tailwind.js"></script>
    <script src="js/math.js"></script>
    <script src="js/js-colormaps.js"></script>
    <script src="js/fuzzygraph.js"></script>

    <style>
        #mainCanvas {
            touch-action: none;
            /* Prevents default touch behaviors like scrolling to allow pan. */
            user-select: none;
        }

        .coords {
            position: absolute;
            right: 6px;
            bottom: 6px;
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            pointer-events: none;
            user-select: none;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 text-white h-16 fixed w-full top-0 left-0 z-50">
        <div class="flex items-center justify-between h-full px-4">
            <div class="flex items-center">

                <!-- Logo -->
                <div class="ml-1 w-52">
                    <svg xmlns="http://www.w3.org/2000/svg" width="68.92mm" height="12.21mm" viewBox="0 0 69.92 12.21"
                        preserveAspectRatio="xMidYMid meet" class="w-full h-full">
                        <text x="0.42" y="8.78" font-family="Arial Black" font-size="10.58" stroke="white" fill="white"
                            stroke-width="0.26" style="filter: blur(0.5px);">Fuzzy</text>
                        <text x="34.83" y="8.86" font-family="Arial Black" font-size="10.58" stroke="white" fill="white"
                            stroke-width="0.26">Graph</text>
                    </svg>
                </div>

            </div>
            <div class="flex items-center space-x-4">
                <!-- Desktop Navigation -->
                <nav class="hidden md:flex space-x-4">

                    <button id="showShareButton"
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                        </svg>
                        <span>Share</span>
                    </button>

                    <button id="showSaveButton"
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                        <span>Save</span>
                    </button>

                    <button id="showHelpButton"
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M12 21a9 9 0 110-18 9 9 0 010 18z" />
                        </svg>
                        <span>Help</span>
                    </button>

                </nav>

                <!-- Mobile menu button -->
                <button id="mobileMenuButton" class="md:hidden p-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>
        <!-- Mobile Navigation Menu -->
        <div id="mobileMenu" x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform -translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100 transform translate-y-0"
            x-transition:leave-end="opacity-0 transform -translate-y-2"
            class="absolute top-16 right-0 w-48 bg-gray-800 shadow-lg md:hidden rounded-bl-lg">
            <div class="px-2 py-3 space-y-2">
                <button id="mobileShowShareButton"
                    class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" />
                    </svg>
                    <span>Share</span>
                </button>
                <button id="mobileShowSaveButton"
                    class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                    <span>Save</span>
                </button>
                <button id="mobileShowHelpButton"
                    class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M12 21a9 9 0 110-18 9 9 0 010 18z" />
                    </svg>
                    <span>Help</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="flex flex-col md:flex-row pt-16 bg-gray-300">
        <!-- Main Content -->
        <main id="controlPanel" class="flex-1 order-1 md:order-2 transition-all duration-300 relative" <!-- Zoom
            Controls -->
            <div class="absolute top-4 right-4 z-10 flex flex-col gap-0.5">
                <button id="zoomInButton"
                    class="p-1.5 bg-gray-800 bg-opacity-75 hover:bg-opacity-100 text-white rounded-t-lg shadow-lg transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
                <button id="zoomOutButton"
                    class="p-1.5 bg-gray-800 bg-opacity-75 hover:bg-opacity-100 text-white rounded-b-lg shadow-lg transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                    </svg>
                </button>
            </div>
            <!-- Sidebar Show Button (Desktop) -->
            <button id="openControlPanelButton"
                class="hidden md:flex items-center justify-center w-6 h-12 bg-gray-800 bg-opacity-50 hover:bg-opacity-75 text-white rounded-r fixed left-0 top-1/2 transform -translate-y-1/2 transition-opacity duration-300">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>

            <canvas id="mainCanvas" class="w-full h-[calc(100vh-4rem)] md:h-[calc(100vh-4rem)] bg-white">
            </canvas>

            <div id="hoverMsgDiv" class="coords" x-transition>
                <span id="hoverMsg"></span>
            </div>
        </main>

        <!-- Sidebar - Fixed to bottom on mobile, left side on desktop -->
        <aside id="mobileControlPanel"
            class="bg-gray-300 text-gray-800 w-full md:w-64 fixed transition-all duration-300 order-2 md:order-1 z-40">
            <!-- Top Control Bar -->
            <div class="bg-gray-400 text-white p-2 flex justify-between items-center">
                <button id="hideControlPanelButton" class="p-1 hover:bg-gray-700 rounded">
                    <svg class="w-5 h-5 rotate-90 md:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19l7-7-7-7" />
                    </svg>
                </button>
            </div>
            <!-- Sidebar Content -->
            <div class="p-4 flex flex-col space-y-8 max-h-[50vh] md:max-h-[calc(100vh-7rem)] overflow-y-auto">
                <!-- Equation Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200">Equation</h3>
                    <div class="space-y-2">
                        <textarea id="equationInput" class="w-full h-16 p-2 border border-gray-300 rounded-md resize-y"
                            placeholder="y=x">
                        </textarea>
                    </div>
                </div>

                <!-- Controls Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200">Controls</h3>
                    <!-- Fuzzy Level Slider -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Fuzzy Level: <span id="fuzzyLevelDisplay"></span>
                        </label>
                        <input id="fuzzyInput" type="range" min="0" max="200"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                    </div>

                    <!-- Axes Toggle Switch -->
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-sm font-medium text-gray-700">Show Axes</span>
                        <button type="button" id="axesToggle"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                            role="switch">
                            <span id="axesOnSlider"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out">
                            </span>
                        </button>
                    </div>
                </div>

                <!-- Color Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200">Color Map</h3>
                    <!-- Color Map Dropdown -->
                    <div class="relative inline-block max-w-full sm:w-64 w-full">
                        <select id="colorMapSelect" name="colors"
                            class="block w-full min-w-0 truncate appearance-none rounded-lg border border-gray-300 bg-white py-2 pl-3 pr-10 text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        <!-- Dropdown arrow -->
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                            <svg class="h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>

                    <!-- Invert Color Switch -->
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-sm font-medium text-gray-700">Invert Color</span>
                        <button id="invertColorButton" type="button"
                            class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                            role="switch">
                            <span id="invertColorSlider"
                                class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out">
                            </span>
                        </button>
                    </div>

                    <div class="mt-16 text-center">
                        ~ Built by <a href="https://gods.art"
                            class="text-blue-600 underline hover:text-blue-800 transition-colors duration-200">
                            Caleb Madrigal
                        </a>
                        ~
                    </div>

                </div>

            </div>
    </div>
    </aside>

    <!-- Mobile Show Button (when panel is hidden) -->
    <button id="mobileShowControlPanelButton"
        class="md:hidden fixed bottom-0 left-1/2 transform -translate-x-1/2 bg-gray-800 bg-opacity-50 hover:bg-opacity-75 text-white px-4 py-2 rounded-t transition-all duration-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
    </button>
    </div>

    <!-- Share modal background -->
    <div id="shareModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">

        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="shareModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Share</h2>
            <div class="w-full max-w-md p-4">
                <div class="relative">
                    <!--<input
                    type="text"
                    readonly
                    class="w-full p-2 pr-20 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                >
                <button
                    class="absolute right-1 top-1/2 -translate-y-1/2 bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 transition duration-200">
                </button>-->
                    <p>Just copy the URL in the URL bar and sent it.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Save modal background -->
    <div id="saveModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <!-- Modal content -->
        <div x-transition class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="saveModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Save Image</h2>
            <p class="mb-4">Image save feature coming soon</p>
        </div>
    </div>

    <!-- Help modal background -->
    <div id="helpModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">

        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="helpModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">About FuzzyGraph</h2>
            <p>FuzzyGraph is a non-binary graphing app. This is similar to the concept of <a
                    class="text-blue-600 underline hover:text-blue-800 transition-colors duration-200"
                    href="https://en.wikipedia.org/wiki/Fuzzy_logic">Fuzzy logic</a>.</p>
            <br />
            <p>Most conventional graphing apps show where the left and right side of the equation are EXACTLY equal. By
                comparison, FuzzyGraph shows the error gradient of the equation... and does not collapse into either
                TRUE of FALSE, but rather, shows the "shades of gray", choosing colors based on how near or far both
                sides are to being equal.</p>
            <br />
            <p>Project by math artist <a href="https://gods.art"
                    class="text-blue-600 underline hover:text-blue-800 transition-colors duration-200">Caleb
                    Madrigal</a>.</p>
        </div>
    </div>

    <script type="module">
        import { atom } from 'https://cdn.jsdelivr.net/npm/nanostores@0.9.5/+esm';

        const equation = atom('x^2+y^2=2');
        const fuzzyLevel = atom(190);
        const showAxes = atom(true);
        const colorMap = atom('plasma');
        const invertColor = atom(true);
        const xCenter = atom(0);
        const yCenter = atom(0);
        const yHeight = atom(6);

        const sidebarOpen = atom(true);
        const mobileMenuOpen = atom(false);

        // non-persistent
        //const isDragging = atom(false);
        //const dragStartX = atom(0);
        //const dragStartY = atom(0);
        const hoverMsg = atom('');
        const showError = atom(false);

        const showShareModal = atom(false);
        const showSaveModal = atom(false);
        const showHelpModal = atom(false);

        function checkCanvasSize(canvas) {
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1
            const rect = canvas.getBoundingClientRect()
            canvas.width = Math.max(1, Math.round(rect.width * dpr))
            canvas.height = Math.max(1, Math.round(rect.height * dpr))
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0) // user-space: CSS pixels
        }

        function paintGraph() {
            const canvas = document.getElementById('mainCanvas');

            // Compile equation using math.js (parseEquationString)
            const parsedEquation = parseEquationString(equation.get());

            if (parsedEquation) {
                var graphConfig = {
                    equationFunction: parsedEquation,
                    fuzzyLevel: fuzzyLevel.get(),
                    colorMap: colorMap.get(),
                    invertColor: invertColor.get(),
                    xCenter: xCenter.get(),
                    yCenter: yCenter.get(),
                    yHeight: yHeight.get(),
                    showAxes: showAxes.get()
                };

                displayGraph(graphConfig, canvas);
            }
        }

        // // // // // // // Event handling

        // TOP MENU EVENTS
        showShareModal.subscribe((visible) => { document.getElementById('shareModal').classList.toggle('hidden', !visible); });
        showSaveModal.subscribe((visible) => { document.getElementById('saveModal').classList.toggle('hidden', !visible); });
        showHelpModal.subscribe((visible) => { document.getElementById('helpModal').classList.toggle('hidden', !visible); });

        // Desktop menu buttons
        document.getElementById('showShareButton').addEventListener('click', () => { showShareModal.set(!showShareModal.get()); });
        document.getElementById('showSaveButton').addEventListener('click', () => { showSaveModal.set(!showSaveModal.get()); });
        document.getElementById('showHelpButton').addEventListener('click', () => { showHelpModal.set(!showHelpModal.get()); });

        // Mobile menu buttons
        document.getElementById('mobileShowShareButton').addEventListener('click', () => { showShareModal.set(!showShareModal.get()); });
        document.getElementById('mobileShowSaveButton').addEventListener('click', () => { showSaveModal.set(!showSaveModal.get()); });
        document.getElementById('mobileShowHelpButton').addEventListener('click', () => { showHelpModal.set(!showHelpModal.get()); });

        // Modal X buttons
        document.getElementById('shareModalX').addEventListener('click', () => { showShareModal.set(false); });
        document.getElementById('saveModalX').addEventListener('click', () => { showSaveModal.set(false); });
        document.getElementById('helpModalX').addEventListener('click', () => { showHelpModal.set(false); });

        // Mobile top menu
        mobileMenuOpen.subscribe((visible) => {
            document.getElementById('mobileMenu').classList.toggle('hidden', visible);
        });

        document.getElementById('mobileMenuButton').addEventListener('click', () => { mobileMenuOpen.set(!mobileMenuOpen.get()); });

        // CONTROL PANEL
        sidebarOpen.subscribe((visible) => {
            // TODO: Make this simple visibility
            document.getElementById('controlPanel').classList.remove('md:ml-64', 'md:ml-0');
            document.getElementById('controlPanel').classList.add(visible ? 'md:ml-64' : 'md:ml-0');

            document.getElementById('openControlPanelButton').classList.remove('opacity-0', 'pointer-events-none', 'opacity-100');
            if (visible) {
                document.getElementById('openControlPanelButton').classList.add('opacity-0', 'pointer-events-none');
            } else {
                document.getElementById('openControlPanelButton').classList.add('opacity-100');
            }

            document.getElementById('mobileControlPanel').classList.remove('bottom-0', 'md:bottom-auto', 'md:top-16',
                'md:left-0', 'bottom-[-1000px]', 'md:bottom-auto',
                'md:top-16', 'md:left-[-1000px]');
            if (visible) {
                document.getElementById('mobileControlPanel').classList.add('bottom-0', 'md:bottom-auto', 'md:top-16', 'md:left-0');
            } else {
                document.getElementById('mobileControlPanel').classList.add('bottom-[-1000px]', 'md:bottom-auto', 'md:top-16', 'md:left-[-1000px]');
            }

            document.getElementById('mobileShowControlPanelButton').classList.remove('opacity-0', 'pointer-events-none', 'opacity-100');

            if (visible) {
                document.getElementById('mobileShowControlPanelButton').classList.add('opacity-0', 'pointer-events-none');
            } else {
                document.getElementById('mobileShowControlPanelButton').classList.add('opacity-100');
            }

            // This will cause a redraw after sidebar animation is done
            setTimeout(() => { window.dispatchEvent(new Event('resize')); }, 300);
        });

        document.getElementById('mobileShowControlPanelButton').addEventListener('click', () => { sidebarOpen.set(true); });
        document.getElementById('openControlPanelButton').addEventListener('click', () => { console.log('openControlPanelButton pressed'); sidebarOpen.set(true); });
        document.getElementById('hideControlPanelButton').addEventListener('click', () => { sidebarOpen.set(false); });

        // CONTROL PANEL / Equation
        equation.subscribe((eq) => {
            document.getElementById('equationInput').value = eq;
            paintGraph();
        });

        document.getElementById('equationInput').addEventListener('input', (event) => {
            // TODO: debounce
            console.log(`equationInput - ${event.target.value}`);
            equation.set(event.target.value);
        });

        // CONTROL PANEL / Fuzzy
        fuzzyLevel.subscribe((fuzzyVal) => {
            document.getElementById('fuzzyLevelDisplay').textContent = parseInt((fuzzyVal / 200) * 100) + '%';
            document.getElementById('fuzzyInput').value = fuzzyVal;
            paintGraph();
        });
        document.getElementById('fuzzyInput').addEventListener('input', (event) => {
            // TODO: debounce
            fuzzyLevel.set(event.target.value);
        });

        // CONTROL PANEL / Show Axes
        showAxes.subscribe((show) => {
            document.getElementById('axesOnSlider').classList.remove('translate-x-5', 'translate-x-0');
            document.getElementById('axesOnSlider').classList.add(show ? 'translate-x-5' : 'translate-x-0');

            document.getElementById('axesToggle').classList.remove('bg-blue-600', 'bg-gray-200');
            document.getElementById('axesToggle').classList.add(show ? 'bg-blue-600' : 'bg-gray-200');

            document.getElementById('axesToggle').setAttribute('aria-checked', show);
        });

        document.getElementById('axesToggle').addEventListener('click', () => {
            // TODO: debounce
            showAxes.set(!showAxes.get());
            paintGraph();
        });

        // CONTROL PANEL / Color map
        function getColorMapList() {
            // TODO: Rename the js-matplotlib data to be something other than "data"?
            var colorMapList = Object.keys(data);
            return colorMapList;
        }

        const colorMapSelect = document.getElementById('colorMapSelect');
        function renderOptions(selectedValue) {
            const colorMaps = getColorMapList();
            colorMapSelect.innerHTML = '';
            colorMaps.forEach((color) => {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                option.selected = color === selectedValue;
                colorMapSelect.appendChild(option);
            });
        }
        colorMap.subscribe((value) => {
            renderOptions(value);
            paintGraph();
        });
        colorMapSelect.addEventListener('change', (event) => {
            colorMap.set(event.target.value);
            paintGraph();
        });
        //renderOptions(colorMap.get());

        // CONTROL PANEL / Invert color
        invertColor.subscribe((show) => {
            document.getElementById('invertColorSlider').classList.remove('translate-x-5', 'translate-x-0');
            document.getElementById('invertColorSlider').classList.add(show ? 'translate-x-5' : 'translate-x-0');

            document.getElementById('invertColorButton').classList.remove('bg-blue-600', 'bg-gray-200');
            document.getElementById('invertColorButton').classList.add(show ? 'bg-blue-600' : 'bg-gray-200');

            document.getElementById('invertColorButton').setAttribute('aria-checked', show);
        });

        document.getElementById('invertColorButton').addEventListener('click', () => {
            // TODO: debounce
            invertColor.set(!invertColor.get());
            paintGraph();
        });


        // Zoom In
        document.getElementById('zoomInButton').addEventListener('click', () => {
            yHeight.set(yHeight.get() * (1 / ZOOM_RATE));
            paintGraph();
        });
        // Zoom Out
        document.getElementById('zoomOutButton').addEventListener('click', () => {
            yHeight.set(yHeight.get() * ZOOM_RATE);
            paintGraph();
        });

        // // // // // // // Drag and drop to pan

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let dragState = {
            isDragging: false,
            startX: 0,
            startY: 0,
            endX: 0,
            endY: 0
        };

        function drawArrow() {
            ctx.beginPath();
            ctx.moveTo(dragState.startX, dragState.startY);
            ctx.lineTo(dragState.endX, dragState.endY);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Draw arrowhead
            const angle = Math.atan2(dragState.endY - dragState.startY, dragState.endX - dragState.startX);
            const arrowSize = 10;
            ctx.beginPath();
            ctx.moveTo(dragState.endX, dragState.endY);
            ctx.lineTo(
                dragState.endX - arrowSize * Math.cos(angle - Math.PI / 6),
                dragState.endY - arrowSize * Math.sin(angle - Math.PI / 6)
            );
            ctx.moveTo(dragState.endX, dragState.endY);
            ctx.lineTo(
                dragState.endX - arrowSize * Math.cos(angle + Math.PI / 6),
                dragState.endY - arrowSize * Math.sin(angle + Math.PI / 6)
            );
            ctx.stroke();
        }

        function updatePosition(event) {
            const canvas = event.target;
            var xWidth = getXWidth(yHeight.get(), canvas.width, canvas.height);

            var xOffsetPixels = event.x - dragState.startX;
            var yOffsetPixels = event.y - dragState.startY;

            console.log(`[*] updatePosition - xOffsetPixels = ${xOffsetPixels}, yOffsetPixels = ${yOffsetPixels}`);

            // First, we have to convert the offset in pixels into the offset in our graphing window
            var xOffset = xOffsetPixels * (xWidth / canvas.clientWidth);
            var yOffset = yOffsetPixels * (yHeight.get() / canvas.clientHeight);

            console.log(`updatePosition - xOffset = ${xOffset}, yOffset = ${yOffset}`);

            // Then we need to move the center of our graphing window accordingly
            xCenter.set(xCenter.get() - xOffset);
            yCenter.set(yCenter.get() + yOffset);  // Due to flipped y, negate yOffset (and -1*-1 = 1)

            dragState.isDragging = false;

            // TODO: No need for nanostores if we call directly
            paintGraph()
        }

        // Get mouse position relative to canvas
        function getMousePos(event) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            };
        }

        // Mouse down event
        canvas.addEventListener('mousedown', (event) => {
            //const mousePos = getMousePos(event);
            //dragState.startX = mousePos.x;
            //dragState.startY = mousePos.y;
            dragState.startX = event.x;
            dragState.startY = event.y;
            dragState.isDragging = true;
        });

        // Mouse move event
        //canvas.addEventListener('mousemove', (event) => {
        //  dragState.endX = event.x;
        //  dragState.endY = event.y;
        //  drawArrow();
        //});

        // Mouse up event
        canvas.addEventListener('mouseup', (event) => {
            dragState.isDragging = false;
            updatePosition(event)
        });


        // Mouse out event to stop dragging if mouse leaves canvas
        canvas.addEventListener('mouseout', () => {
            dragState.isDragging = false;
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Prevent scrolling
            const touch = e.touches[0];
            dragState.startX = touch.clientX - currentX;
            dragState.startY = touch.clientY - currentY;
            dragState.isDragging = true;
        });

        document.addEventListener('touchend', (e) => {
            dragState.isDragging = false;
            const rect = canvas.getBoundingClientRect();
        });

        // // // // // // // Initialization


        // Set canvas size to match its display size
        function resizeCanvas() {
            // const rect = canvas.getBoundingClientRect();

            const dpr = window.devicePixelRatio || 1;
            const displayWidth = canvas.clientWidth;
            const displayHeight = canvas.clientHeight;
            canvas.width = displayWidth * dpr;
            canvas.height = displayHeight * dpr;
            ctx.scale(dpr, dpr);

            paintGraph();
        }

        // Initial resize
        resizeCanvas();

        // Resize canvas when window is resized
        window.addEventListener('resize', resizeCanvas);

        /////////////////////////////////////////////////////////////////////////////////////// URL Handling

        function getAppConfig() {
            var graphConfig = {
                equation: equation.get(),
                fuzzyLevel: fuzzyLevel.get(),
                colorMap: colorMap.get(),
                invertColor: invertColor.get(),
                xCenter: xCenter.get(),
                yCenter: yCenter.get(),
                yHeight: yHeight.get(),
                showAxes: showAxes.get()
            };
            return graphConfig;
        }

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
            var results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        function isBooleanString(str) {
            return /^(true|false)$/i.test(str);
        }

        function parseUrlParam(param, value) {
            if (value === null || value === '') return undefined;

            // Handle JSON arrays (e.g., for equations)
            if (value.startsWith('[') && value.endsWith(']')) {
                try {
                    return JSON.parse(value);
                } catch (e) {
                    console.warn(`Failed to parse JSON for param ${param}: ${value}`);
                    return value;
                }
            }

            // Handle booleans
            if (isBooleanString(value)) {
                return JSON.parse(value.toLowerCase());
            }

            // Handle numbers
            if (!isNaN(value) && value.trim() !== '') {
                return parseFloat(value);
            }

            // Return as string for other cases
            return value;
        }

        function setParamsFromUrl() {
            const urlFragmentId = window.location.hash.substr(1);
            const appConfig = getAppConfig();
            const configFromUrl = {};

            // Parse each parameter from the URL
            for (const param in appConfig) {
                if (appConfig.hasOwnProperty(param)) {
                    const paramValue = getParameterByName(param, urlFragmentId);
                    if (paramValue !== null) {
                        configFromUrl[param] = parseUrlParam(param, paramValue);
                    }
                }
            }

            console.log("Parsed config from URL:", configFromUrl);

            // Update stores
            equation.set(configFromUrl['equation']);
            fuzzyLevel.set(configFromUrl['fuzzyLevel']);
            showAxes.set(configFromUrl['showAxes']);
            colorMap.set(configFromUrl['colorMap']);
            invertColor.set(configFromUrl['invertColor']);
            xCenter.set(configFromUrl['xCenter']);
            yCenter.set(configFromUrl['yCenter']);
            yHeight.set(configFromUrl['yHeight']);
        }

        function setUrlFromParams() {
            const appConfig = getAppConfig();
            const params = new URLSearchParams();
            for (const [key, value] of Object.entries(appConfig)) {
                const paramValue = Array.isArray(value) ? JSON.stringify(value) : value;
                params.append(key, paramValue);
            }
            const hashStr = `#?${params.toString()}`;
            window.location.hash = hashStr;
        }

        // Fixes the canvas aspect being off (as a result of sidebar animation changing the size)
        setTimeout(() => { window.dispatchEvent(new Event('resize')); }, 500);

    </script>
</body>

</html>