<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fuzzy Graph</title>
    <style>
        @import "./input.css";
    </style>

    <style>
        html, body {
              height: 100%;
              overflow: hidden;             /* stop page scroll */
              overscroll-behavior: none;    /* stop pull-to-refresh/bounce */
        }

        #mainCanvas {
            touch-action: none;
            /* Prevents default touch behaviors like scrolling to allow pan. */
            user-select: none;
        }

        .coords {
            position: absolute;
            left: 6px;
            top: 6px;
            padding: 4px 8px;
            border-radius: 6px;
            background: rgba(0, 0, 0, 0.6);
            color: #fff;
            font: 12px/1.2 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            pointer-events: none;
            user-select: none;
            display: none;
        }

        .tooltip-button {
            position: relative;
            padding: 10px 20px;
            cursor: pointer;
        }

        .tooltip-button::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 100%;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: #fff;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            white-space: nowrap;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.2s, visibility 0.2s;
        }

        .tooltip-button:hover::after {
            opacity: 1;
            visibility: visible;
        }

        /* Remove number input arrows (Chrome, Safari, Edge, Opera) */
        .no-spinner::-webkit-outer-spin-button,
        .no-spinner::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        
        /* Remove number input arrows (Firefox) */
        .no-spinner[type="number"] {
            -moz-appearance: textfield;
        }
                    
    </style>
</head>

<body class="min-h-screen">
    <!-- Header -->
    <header class="bg-gray-800 text-white h-16 fixed w-full top-0 left-0 z-50">
        <div class="flex items-center justify-between h-full">
            <div class="flex items-center">

                <!-- Logo -->
                <div class="h-fit flex">
                    <div class="ml-2">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             width="70mm" height="15mm" viewBox="0 0 70 15"
                             preserveAspectRatio="xMidYMid meet" class="w-full h-full">

                            <defs>
                                <filter id="fg-blur" x="-20%" y="-20%" width="140%" height="140%">
                                <feGaussianBlur in="SourceGraphic" stdDeviation="1.0"/>
                                </filter>
                            </defs>

                            <text x="2" y="10" font-family="Arial Black" font-size="9"
                                    stroke="white" fill="white" stroke-width="0.26"
                                    filter="url(#fg-blur)" opacity="1">
                                <tspan>Fuzzy</tspan>
                                <tspan dx="0.8">Graph</tspan>
                            </text>

                            <text x="2" y="10" font-family="Arial Black" font-size="9"
                                    stroke="white" fill="white" stroke-width="0.26">
                                <tspan>Fuzzy</tspan>
                                <tspan dx="0.8">Graph</tspan>
                            </text>
                        </svg>
                    </div>

                    <div>
                        <button id="downloadFuzzyGraphBtn" data-tooltip="Download offline copy of FuzzyGraph"
                        class="hidden md:flex text-white hover:bg-gray-700 items-center py-3 rounded tooltip-button h-14">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                            </svg>
                        </button>
                    </div>
                </div>

            </div>
            <div class="flex items-center space-x-4">
                <!-- Desktop Navigation -->
                <nav class="hidden md:!flex space-x-4">

                    <button id="showShareButton" data-tooltip="Generates a shareable link to this graph"
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700 tooltip-button">
                        <span class="inline text-gray-200 hover:text-gray-300">Share</span>
                        <svg class="w-5 h-5" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500">
                            <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-width: 40px;" d="M 71.335 351.263 C 71.335 351.263 220.824 546.123 425.655 354.919" id="object-0"/>
                            <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-width: 40px;" d="M 244.441 337.303 L 247.495 57.542" id="object-1"/>
                            <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-width: 40px;" d="M 245.927 57.667 C 245.927 57.667 233.676 153.919 163.023 157.325" id="object-2"/>
                            <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; transform-box: fill-box; transform-origin: 50% 50%; stroke-width: 40px;" d="M 324.455 177.087 C 324.455 177.087 314.941 85.607 244.288 82.201" transform="matrix(-1, 0, 0, -1, 4.432068, -20.892017)" id="object-3"/>
                        </svg>
                    </button>

                    <button id="showSaveButton" data-tooltip="Saves this graph as an image file with the graph data built in"
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700 tooltip-button">
                        <span class="inline text-gray-200">Save</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                        </svg>
                    </button>

                    <button id="showOpenButton" data-tooltip="Only opens FuzzyGraph-created image files"
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700 tooltip-button">
                        <span class="inline text-gray-200">Open</span>
                        <svg width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M20 6H12L10 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V8C22 6.9 21.1 6 20 6ZM20 18H4V6H9.17L11.17 8H20V18Z" fill="#000000"/>
                        </svg>
                    </button>

                    <button id="showHelpButton"
                        class="text-white hover:text-blue-200 flex items-center space-x-2 px-3 py-2 rounded-md hover:bg-gray-700">
                        <span class="inline text-gray-200">Help</span>
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M12 21a9 9 0 110-18 9 9 0 010 18z" />
                        </svg>
                    </button>

                </nav>

                <!-- Mobile menu button -->
                <button id="mobileMenuButton" class="md:hidden p-2 mr-2">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
            </div>
        </div>

        <!-- Mobile Navigation Menu -->
        <div id="mobileMenu" x-transition:enter="transition ease-out duration-200"
            x-transition:enter-start="opacity-0 transform -translate-y-2"
            x-transition:enter-end="opacity-100 transform translate-y-0"
            x-transition:leave="transition ease-in duration-150"
            x-transition:leave-start="opacity-100 transform translate-y-0"
            x-transition:leave-end="opacity-0 transform -translate-y-2"
            class="hidden absolute top-16 right-0 w-32 bg-gray-800 shadow-lg md:hidden rounded-bl-lg">
            <div class="px-2 py-3 space-y-2">

                <button id="mobileShowShareButton"
                    class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded">
                    <span class="inline text-gray-200 w-12">Share</span>
                    <svg class="w-5 h-5 block" fill="none" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 500 500">
                        <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-width: 40px;" d="M 71.335 351.263 C 71.335 351.263 220.824 546.123 425.655 354.919" id="object-0"/>
                        <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-width: 40px;" d="M 244.441 337.303 L 247.495 57.542" id="object-1"/>
                        <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; stroke-width: 40px;" d="M 245.927 57.667 C 245.927 57.667 233.676 153.919 163.023 157.325" id="object-2"/>
                        <path style="fill: none; stroke: rgb(255, 255, 255); stroke-linecap: round; transform-box: fill-box; transform-origin: 50% 50%; stroke-width: 40px;" d="M 324.455 177.087 C 324.455 177.087 314.941 85.607 244.288 82.201" transform="matrix(-1, 0, 0, -1, 4.432068, -20.892017)" id="object-3"/>
                    </svg>
                </button>

                <button id="mobileShowSaveButton"
                    class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded">
                    <span class="inline text-gray-200 w-12">Save</span>
                    <svg class="w-5 h-5 block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                    </svg>
                </button>

                <button id="mobileShowOpenButton"
                    class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded">
                    <span class="inline text-gray-200 w-12">Open</span>
                    <svg class="w-5 h-5 block" width="24" height="24" viewBox="0 0 24 24" stroke="currentColor" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 6H12L10 4H4C2.9 4 2 4.9 2 6V18C2 19.1 2.9 20 4 20H20C21.1 20 22 19.1 22 18V8C22 6.9 21.1 6 20 6ZM20 18H4V6H9.17L11.17 8H20V18Z" fill="#000000"/>
                    </svg>
                </button>

                <button id="mobileShowHelpButton"
                    class="w-full text-white hover:bg-gray-700 flex items-center space-x-2 px-3 py-2 rounded">
                    <span class="inline text-gray-200 w-12">Help</span>
                    <svg class="w-5 h-5 block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M12 21a9 9 0 110-18 9 9 0 010 18z" />
                    </svg>
                </button>

            </div>
        </div>
    </header>

    <!-- Main Container -->
    <!-- <div class="flex flex-col md:flex-row pt-16 bg-gray-300"> -->
    <div class="fixed inset-x-0 top-16 bottom-0 flex flex-col md:flex-row bg-gray-300">
        <!-- Main Content -->
        <main id="overCanvasControls" class="flex-1 order-1 md:order-2 transition-all duration-300 relative">
            <div class="absolute top-4 right-4 z-10 flex flex-col gap-0.5">
                <button id="zoomInButton"
                    class="p-1.5 bg-gray-800 bg-opacity-75 hover:bg-opacity-100 text-white rounded-t-lg shadow-lg transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                </button>
                <button id="zoomOutButton"
                    class="p-1.5 bg-gray-800 bg-opacity-75 hover:bg-opacity-100 text-white rounded-b-lg shadow-lg transition-colors duration-200">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 12H6" />
                    </svg>
                </button>

                <button id="gotoButton"
                    class="p-1.5 bg-gray-800 bg-opacity-75 hover:bg-opacity-100 text-white rounded-lg shadow-lg transition-colors duration-200 flex items-center justify-center mt-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <circle cx="12" cy="12" r="9" stroke-width="2" />
                        <circle cx="12" cy="12" r="4" stroke-width="2" />
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v2m0 14v2m9-9h-2M5 12H3" />
                    </svg>
                </button>

                <button id="homeButton"
                    class="p-1.5 bg-gray-800 bg-opacity-75 hover:bg-opacity-100 text-white rounded-lg shadow-lg transition-colors duration-200 flex items-center justify-center">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M3 9.5l9-7 9 7M4 10v10a1 1 0 001 1h5V14h4v7h5a1 1 0 001-1V10" />
                    </svg>
                </button>

            </div>
            <!-- Sidebar Show Button (Desktop) -->
            <button id="openControlPanelButton"
                class="hidden md:!flex items-center justify-center w-6 h-12 bg-gray-800 bg-opacity-50 hover:bg-opacity-75 text-white rounded-r fixed left-0 top-1/2 transform -translate-y-1/2 transition-opacity duration-300">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
            </button>

            <canvas id="mainCanvas" class="w-full h-[calc(100dvh-4rem)] md:h-[calc(100dvh-4rem)] bg-white">
            </canvas>

            <div id="hoverMsgDiv" class="coords">
                <span id="hoverMsg">Loading...</span>
            </div>
        </main>

        <!-- Side Control Panel - Fixed to bottom on mobile, left side on desktop -->
        <aside id="controlPanel"
            class="bg-gray-300 text-gray-800 w-full md:w-64 fixed order-2 md:order-1 z-40 bottom-0 md:bottom-auto md:top-16 md:left-0">
            <!-- Top Control Bar -->
            <div class="bg-gray-400 text-white p-2 flex justify-between items-center">
                <button id="hideControlPanelButton" class="p-1 hover:bg-gray-700 rounded">
                    <svg class="w-5 h-5 rotate-90 md:rotate-180" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 19l7-7-7-7" />
                    </svg>
                </button>

                <div id="advancedModeToggle" class="flex items-center gap-3 select-none mr-2">
                    <!-- Dynamic Label -->
                    <span id="modeLabel" class="text-xs">Basic</span>
                  
                    <!-- Switch -->
                    <button
                      id="modeToggle"
                      type="button"
                      role="switch"
                      aria-checked="false"
                      aria-labelledby="mode-label"
                      class="relative inline-flex h-6 w-12 items-center bg-gray-300 transition-colors duration-200 
                             focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-offset-2 rounded-none"
                    >
                      <span class="sr-only">Toggle Basic/Advanced</span>
                  
                      <!-- Track border -->
                      <span aria-hidden="true" class="absolute inset-0 border border-gray-500/50 pointer-events-none rounded-none"></span>
                  
                      <!-- Thumb -->
                      <span
                        id="modeThumb"
                        class="pointer-events-none inline-block h-4 w-4 translate-x-1 bg-gray-50 transition-all duration-200 
                               will-change-transform rounded-none shadow-md"
                      ></span>
                    </button>
                </div>


            </div>
            <!-- Sidebar Content -->
            <div class="p-4 flex flex-col space-y-8 max-h-[30vh] md:max-h-[calc(100vh-7rem)] overflow-y-auto">
                <!-- Equation Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200 flex items-center gap-1">
                      <span>Equation</span>
                      <button id="equationHelpButton"
                        class="text-gray-500 hover:text-blue-500 flex items-center p-1 rounded-md hover:bg-gray-100">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M8.228 9c.549-1.165 2.03-2 3.772-2 
                               2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907
                               -.542.104-.994.54-.994 1.093m0 3h.01
                               M12 21a9 9 0 110-18 9 9 0 010 18z" />
                        </svg>
                      </button>
                    </h3>

                    <div style="position:relative; max-width:100%;">
                        <textarea id="equationInput" class="w-full h-16 p-2 border border-gray-300 rounded-md resize-y"
                            oninput="this.value=this.value.toLowerCase()" autocapitalize="off" spellcheck="false"
                            placeholder="y=x">
                        </textarea>

                        <button id="openEquationModalButton" type="button" title="Open equation editor"
                        class="m-1"
                        style="position:absolute; right:6px; bottom:30px; height:20px; width:20px; border-radius:4px;
                                border:0px; background:#fff; cursor:pointer; font-size:18px; line-height:1; padding:0;">
                        ✎
                        </button>

                        <button id="mathBtn" type="button" aria-haspopup="true" aria-expanded="false" aria-controls="mathPopover"
                        title="Math functions (⌘/Ctrl+K)"
                        class="m-1"
                        style="position:absolute; right:6px; bottom:6px; height:20px; width:20px; border-radius:4px;
                                border:0px; background:#fff; cursor:pointer; font-size:18px; line-height:1; padding:0;">
                        +
                        </button>
                    </div>

                </div>

                <!-- Controls Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200 flex items-center gap-1">
                        <span>Controls</span>
                        <button id="controlsHelpButton"
                            class="text-gray-500 hover:text-blue-500 flex items-center p-1 rounded-md hover:bg-gray-100">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 
                                2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907
                                -.542.104-.994.54-.994 1.093m0 3h.01
                                M12 21a9 9 0 110-18 9 9 0 010 18z" />
                            </svg>
                      </button>
                    </h3>
                    <!-- Fuzzy Level Slider -->
                    <div class="space-y-2">
                        <label class="block text-sm font-medium text-gray-700">
                            Fuzzy Level: <span id="fuzzyLevelDisplay"></span>
                        </label>
                        <!-- <input id="fuzzyInput" type="range" min="0" max="100"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer"> -->

                            <input
                            id="fuzzyInput"
                            type="range"
                            min="0"
                            max="100"
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer
                              [&::-webkit-slider-thumb]:appearance-none
                              [&::-webkit-slider-thumb]:w-4
                              [&::-webkit-slider-thumb]:h-4
                              [&::-webkit-slider-thumb]:bg-gray-800
                              [&::-webkit-slider-thumb]:rounded-none
                              [&::-webkit-slider-thumb]:cursor-pointer
                          
                              [&::-moz-range-thumb]:w-4
                              [&::-moz-range-thumb]:h-4
                              [&::-moz-range-thumb]:bg-gray-800
                              [&::-moz-range-thumb]:border-0
                              [&::-moz-range-thumb]:rounded-none
                            "
                          />
                    </div>

                    <!-- Axes Toggle Switch -->
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-sm font-medium text-gray-700">Show Axes</span>
                        <button
                            type="button"
                            id="axesToggle"
                            role="switch"
                            aria-checked="true"
                            class="relative inline-flex h-6 w-12 items-center bg-gray-800 transition-colors duration-200 
                                   focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-offset-2 rounded-none"
                        >
                            <span class="sr-only">Toggle axes</span>
                            <span
                                id="axesOnSlider"
                                class="pointer-events-none inline-block h-4 w-4 translate-x-7 bg-gray-50 transition-all duration-200 
                                       will-change-transform rounded-none shadow-md"
                            ></span>
                        </button>
                    </div>

                </div>

                <!-- Color Section -->
                <div>
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200 flex items-center gap-1">
                        <span>Color Map</span>
                        <button id="colorMapHelpButton"
                            class="text-gray-500 hover:text-blue-500 flex items-center p-1 rounded-md hover:bg-gray-100">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 
                                2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907
                                -.542.104-.994.54-.994 1.093m0 3h.01
                                M12 21a9 9 0 110-18 9 9 0 010 18z" />
                            </svg>
                      </button>
                    </h3>

                    <!-- Color Map Dropdown -->
                    <div class="relative inline-block max-w-full sm:w-64 w-full">
                        <select id="colorMapSelect" name="colors"
                            class="block w-full min-w-0 truncate appearance-none rounded-lg border border-gray-300 bg-white py-2 pl-3 pr-10 text-base text-gray-700 focus:border-blue-500 focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                        <!-- Dropdown arrow -->
                        <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center pr-3">
                            <svg class="h-4 w-4 text-gray-400" xmlns="http://www.w3.org/2000/svg" fill="none"
                                viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>

                    <!-- Invert Color Switch -->
                    <div class="flex items-center justify-between mt-4">
                        <span class="text-sm font-medium text-gray-700">Invert Color</span>
                        <button
                            id="invertColorButton"
                            type="button"
                            role="switch"
                            aria-checked="true"
                            class="relative inline-flex h-6 w-12 items-center bg-gray-800 transition-colors duration-200 
                                   focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-offset-2 rounded-none"
                        >
                            <span class="sr-only">Toggle color inversion</span>
                            <span
                                id="invertColorSlider"
                                class="pointer-events-none inline-block h-4 w-4 translate-x-7 bg-gray-50 transition-all duration-200 
                                       will-change-transform rounded-none shadow-md"
                            ></span>
                        </button>
                    </div>

                </div>

                <!-- Advanced Section -->
                <div id="advancedSection" class="hidden">
                    <h3 class="text-lg font-semibold text-gray-900 pb-2 mb-4 border-b-2 border-gray-200 flex items-center gap-1">
                        <span>Advanced</span>
                        <button id="advancedHelpButton"
                            class="text-gray-500 hover:text-blue-500 flex items-center p-1 rounded-md hover:bg-gray-100">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M8.228 9c.549-1.165 2.03-2 3.772-2 
                                2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907
                                -.542.104-.994.54-.994 1.093m0 3h.01
                                M12 21a9 9 0 110-18 9 9 0 010 18z" />
                            </svg>
                      </button>
                    </h3>

                    <div>
                        <label for="minOverrideInput" class="block text-sm font-medium text-gray-600">
                          Min Override (min: <span id="minDisplay" class="text-xs">0</span>)
                        </label>
                      
                        <div class="mt-1 relative">
                          <!-- Input -->
                          <input 
                            type="number" 
                            id="minOverrideInput" 
                            name="minOverrideInput" 
                            class="no-spinner w-full px-3 py-2 pr-12 border border-gray-300 rounded-md shadow-sm 
                                   focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                          >
                      
                          <!-- Toggle inside input (small advanced-style) -->
                          <button
                            type="button"
                            id="minOverrideToggle"
                            class="absolute inset-y-0 right-2 my-auto h-5 w-9 flex items-center px-0
                                   bg-gray-800 transition-colors duration-200 rounded-none"
                            aria-pressed="false"
                            tabindex="-1"
                          >
                            <span
                              class="knob inline-block h-3 w-3 translate-x-5 bg-gray-50 shadow transform 
                                     transition-transform duration-200 will-change-transform rounded-none"
                            ></span>
                          </button>
                        </div>
                      </div>
                      

                    <!-- Max Override -->
                    <div>
                        <label for="maxOverrideInput" class="block text-sm font-medium text-gray-600 mt-2">
                        Max Override (max: <span id="maxDisplay" class="text-xs">0</span>)
                        </label>
                    
                        <div class="mt-1 relative">
                        <input 
                            type="number" 
                            id="maxOverrideInput" 
                            name="maxOverrideInput" 
                            class="no-spinner w-full px-3 py-2 pr-12 border border-gray-300 rounded-md shadow-sm 
                                focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                        >
                    
                        <!-- Toggle inside input (small advanced-style) -->
                        <button
                            type="button"
                            id="maxOverrideToggle"
                            class="absolute inset-y-0 right-2 my-auto h-5 w-9 flex items-center px-0
                                bg-gray-800 transition-colors duration-200 rounded-none"
                            aria-pressed="false"
                            tabindex="-1"
                        >
                            <span
                            class="knob inline-block h-3 w-3 translate-x-5 bg-gray-50 shadow transform 
                                    transition-transform duration-200 will-change-transform rounded-none"
                            ></span>
                        </button>
                        </div>
                    </div>

                </div>

                <div class="mt-16 text-center flex flex-col justify-end">
                    <span>≈ Built by <a href="https://gods.art"
                            class="text-cyan-500 underline hover:text-cyan-300 underline transition-colors duration-200">
                            Caleb Madrigal
                        </a>
                        ≈</span>
                </div>


            </div>
    </div>
    </aside>

    <!-- Mobile Show Button (when panel is hidden) -->
    <button id="mobileShowControlPanelButton"
        class="md:hidden fixed bottom-0 left-1/2 transform -translate-x-1/2 bg-gray-800 bg-opacity-50 hover:bg-opacity-75 text-white px-4 py-2 rounded-t transition-all duration-300">
        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7" />
        </svg>
    </button>
    </div>

    <!-- Share modal background -->
    <div id="shareModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">

        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="shareModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Share</h2>
            <div class="w-full max-w-md p-4">
                <div class="relative">
                    <input type="text" readonly id="shareUrlInput"
                        class="w-full p-2 pr-20 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <button id="copyUrlButton"
                        class="absolute right-1 top-1/2 -translate-y-1/2 bg-gray-800 text-white px-3 py-1 rounded-lg hover:bg-gray-700 transition duration-200">
                        Copy
                    </button>

                </div>
                <div id="copytooltip" style="display: none;">Copied!</div>
            </div>
        </div>
    </div>

    <!-- Save modal background -->
    <div id="saveModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <!-- Modal content -->
        <div x-transition class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="saveModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Save Image</h2>

            <div class="bg-white w-full max-w-md">
                <!-- Size Inputs -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Size</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="width" class="block text-sm font-medium text-gray-600">Width (pixels)</label>
                            <input 
                                type="number" 
                                id="saveWidthInput" 
                                name="saveWidthInput" 
                                min="0" 
                                step="1" 
                                required 
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter width"
                            >
                        </div>
                        <div>
                            <label for="height" class="block text-sm font-medium text-gray-600">Height (pixels)</label>
                            <input 
                                type="number" 
                                id="saveHeightInput" 
                                name="saveHeightInput" 
                                min="0" 
                                step="1" 
                                required 
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter height"
                            >
                        </div>
                    </div>
                </div>
    
                <!-- Center Inputs -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Center</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="x" class="block text-sm font-medium text-gray-600">X (decimal)</label>
                            <input 
                                type="number" 
                                id="saveCenterXInput" 
                                name="saveCenterXInput" 
                                step="any" 
                                required 
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter x coordinate"
                            >
                        </div>
                        <div>
                            <label for="y" class="block text-sm font-medium text-gray-600">Y (decimal)</label>
                            <input 
                                type="number" 
                                id="saveCenterYInput" 
                                name="saveCenterYInput" 
                                step="any" 
                                required 
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter y coordinate"
                            >
                        </div>
                    </div>
                </div>
    
                <!-- yHeight Input -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Zoom</h3>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="yHeight" class="block text-sm font-medium text-gray-600">yHeight (decimal)</label>
                            <input 
                                type="number" 
                                id="saveYHeightInput" 
                                name="saveYHeightInput" 
                                step="any" 
                                required 
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter yHeight"
                            >
                        </div>
                        <div>&nbsp;</div>
                    </div>

                </div>


                <div class="mb-4">
                    <div class="grid grid-cols-2 gap-4 items-center">
                        <!-- Show Axes -->
                        <div class="flex items-center justify-between">
                            <span class="text-sm font-medium text-gray-700">Show Axes</span>
                            <button
                                type="button"
                                id="saveAxesToggle"
                                role="switch"
                                aria-checked="true"
                                class="relative inline-flex h-6 w-12 items-center bg-gray-800 transition-colors duration-200 
                                       focus:outline-none focus:ring-2 focus:ring-gray-600 focus:ring-offset-2 rounded-none"
                            >
                                <span class="sr-only">Toggle axes in saved image</span>
                                <span
                                    id="saveAxesOnSlider"
                                    class="pointer-events-none inline-block h-4 w-4 translate-x-7 bg-gray-50 transition-all duration-200 
                                           will-change-transform rounded-none shadow-md"
                                ></span>
                            </button>
                        </div>

                        <!-- Save Image Button -->
                        <div class="flex items-center justify-end">
                            <button 
                                type="button" 
                                id="saveImageButton"
                                class="px-8 py-2 bg-gray-800 text-white font-semibold rounded-md shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center justify-center"
                            >
                                <span class="inline text-gray-200 mr-2">Save Image</span>
                                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8 7H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-3m-1 4l-3 3m0 0l-3-3m3 3V4" />
                                </svg>
                            </button>
                        </div>
                    </div>
                </div>





            </div>
            <!-- <p class="mb-4">Image save feature coming soon</p> -->


        </div>
    </div>
    

    <!-- Goto modal background -->
    <div id="gotoModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <!-- Modal content -->
        <div x-transition class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="gotoModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Goto</h2>

            <div class="bg-white w-full max-w-md space-y-6">
                <!-- Center Inputs -->
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Center</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="gotoCenterXInput" class="block text-sm font-medium text-gray-600">X (decimal)</label>
                            <input
                                type="number"
                                id="gotoCenterXInput"
                                name="gotoCenterXInput"
                                step="any"
                                required
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter x coordinate"
                            >
                        </div>
                        <div>
                            <label for="gotoCenterYInput" class="block text-sm font-medium text-gray-600">Y (decimal)</label>
                            <input
                                type="number"
                                id="gotoCenterYInput"
                                name="gotoCenterYInput"
                                step="any"
                                required
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter y coordinate"
                            >
                        </div>
                    </div>
                </div>

                <!-- Zoom Input -->
                <div>
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">Zoom</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="gotoZoomInput" class="block text-sm font-medium text-gray-600">Zoom (decimal)</label>
                            <input
                                type="number"
                                id="gotoZoomInput"
                                name="gotoZoomInput"
                                step="any"
                                required
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                                placeholder="Enter zoom"
                            >
                        </div>
                        <div>&nbsp;</div>
                    </div>
                </div>

                <div class="flex items-center justify-end gap-3">
                    <button
                        type="button"
                        id="gotoCancelButton"
                        class="px-6 py-2 bg-gray-200 text-gray-800 font-semibold rounded-md shadow-sm hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
                    >
                        Cancel
                    </button>
                    <button
                        type="button"
                        id="gotoSubmitButton"
                        class="px-6 py-2 bg-gray-800 text-white font-semibold rounded-md shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center justify-center"
                    >
                        Goto
                    </button>
                </div>
            </div>


        </div>
    </div>

    <!-- Open modal background -->
    <div id="openModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <!-- Modal content -->
        <div x-transition class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="openModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Open FuzzyGraph Image</h2>

            <div class="mb-6">
                <!-- File Upload Container -->
                <div class="flex items-center space-x-4">
                  <input
                    id="pngInput"
                    type="file"
                    accept="image/png"
                    class="block p-2 w-full text-sm text-gray-900 border border-gray-300 rounded-lg cursor-pointer bg-gray-50 dark:text-gray-300 dark:bg-gray-800 dark:border-gray-600 focus:outline-none file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-gray-800 file:text-white hover:file:bg-gray-700 transition"
                  />
                </div>
              
                <!-- Result Display -->
                <pre id="openResult" class="mt-4 rounded text-sm text-gray-200 dark:text-gray-700"></pre>
            </div>


        </div>
    </div>


    <!-- Help modal background -->
    <div id="helpModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">

        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="helpModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">FuzzyGraph v3.0.1</h2>
            <p>FuzzyGraph is the world's first <a href="https://en.wikipedia.org/wiki/Fuzzy_logic" class="text-cyan-500 underline hover:text-cyan-300 underline transition-colors duration-200">fuzzy</a> (non-binary) graphing calculator. FuzzyGraph is also free and <a href="https://github.com/calebmadrigal/fuzzygraph" class="text-cyan-500 underline hover:text-cyan-300 underline transition-colors duration-200">open-source</a>.</p>
            <br />
            <p>Conventional graphing apps show where the LEFT and RIGHT side of the equation are EXACTLY equal. By
                comparison, FuzzyGraph shows the error gradient of the equation. Instead of collapsing the evaluation
                into either
                TRUE or FALSE, it instead, shows the "shades of gray", choosing colors based on how near or far both
                sides are to being equal at every point in the visible area.</p>
            <br />
            <p>Another way to think about it is this: fuzzy graphs are graphs of approximate equations (≈).</p>
            <br />
            <p>Here is a <a href="https://www.youtube.com/watch?v=DsOyp3-8dug&t=1s" class="text-cyan-500 underline hover:text-cyan-300 underline transition-colors duration-200">video intro to FuzzyGraph</a>.</p>
            <br />
            <p class="text-right">Project by math artist <a href="https://gods.art"
                    class="text-cyan-500 underline hover:text-cyan-300 underline transition-colors duration-200">Caleb Madrigal</a>.</p>
        </div>
    </div>


    <!-- Equation help modal -->
    <div id="equationHelpModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">

        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="equationHelpModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Equation Help</h2>
            <div class="w-full max-w-md p-4">
                <div>
                    <p>Equations must have an <span class="font-mono bg-gray-100 text-gray-800 px-1 py-0.5 rounded">=</span> sign, and can use variables <span class="font-mono bg-gray-100 text-gray-800 px-1 py-0.5 rounded">x</span>  and <span class="font-mono bg-gray-100 text-gray-800 px-1 py-0.5 rounded">y</span>. For example: <span class="font-mono bg-gray-100 text-gray-800 px-1 py-0.5 rounded">y = x^2</span>.</p>
                    <br />
                    <a class="text-cyan-500 underline hover:text-cyan-300 underline transition-colors duration-200"
                       href="https://fuzzygraph.com/examples.html">View Examples</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Controls help modal -->
    <div id="controlsHelpModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">

        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="controlsHelpModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Controls Help</h2>
            <div class="w-full max-w-md p-4">
                <div>
                    <h3 class="font-bold">Fuzzy Level</h3>
                    <p>The <span class="font-mono bg-gray-100 text-gray-800 px-1 py-0.5 rounded">Fuzzy Level</span> expands or squishes the equation so that the peaks and valleys are closer together, or further apart. This has an effect on how the colors manifest.</p>
                    <br />
                    <h3 class="font-bold">Show Axes</h3>
                    <p>Turns the X and Y Axes on or off</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Color Map help modal -->
    <div id="colorMapHelpModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">

        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="colorMapHelpModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Color Map Help</h2>
            <div class="w-full max-w-md p-4">
                <div>
                    <p>There are two parts: the <span class="font-bold">data</span> and the <span class="font-bold">representation</span>.</p>
                    <br />
                    <p><span class="font-bold">The Equation</span> defines the data.</p>
                    <p><span class="font-bold">The Color Map</span> defines which colors are used to represent which values. For example, in the <span class="font-mono bg-gray-100 text-gray-800 px-1 py-0.5 rounded">rainbow</span> color map, the <span class="italic">lowest</span> value maps to <span class="text-purple-500">purple</span>, and the <span class="italic">highest</span> value maps to <span class="text-red-500">red</span>. If <span class="font-bold">Invert Color</span> is on, then the <span class="italic">lowest</span> value maps to <span class="text-red-500">red</span> and the <span class="italic">highest</span> value maps to <span class="text-purple-500">purple</span>.</p>
                    <br />
                    <p>The same equation/data can be represented in many different ways. <span class="font-bold">There is no one right representation.</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Advanced help modal -->
    <div id="advancedHelpModal" class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50">

        <!-- Modal content -->
        <div class="relative bg-white rounded-lg shadow-lg p-6 max-w-md w-full">

            <!-- X button -->
            <button id="advancedHelpModalX"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none">
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Advanced Help</h2>
            <div class="w-full max-w-md p-4">
                <div>
                    <h3 class="font-bold">Min Override</h3>
                    <p>Since FuzzyGraph takes the absolute value of the error, the minimum value is typically 0, and usually does not need to be changed.</p>
                    <br />
                    <h3 class="font-bold">Max Override</h3>
                    <p>Just as a bright light (like the sun) can "wash out" everything else in a photo, so also a section of really high error can wash out the rest of the mathematical topography (which hides many of the details). So it is often valuable to clamp down on the max value by setting a "Max Override".</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Math Input Popover -->
    <div id="mathPopover" role="dialog" aria-label="Insert math"
        style="position:absolute; top:100%; right:0; margin-top:6px; z-index:1000; max-width:min(560px, 96vw);
                                                background:#fff; border:1px solid #ddd; border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.12); padding:10px; display:none;">
        <div style="display:flex; gap:6px; align-items:center; margin-bottom:8px;">
            <input id="mathFilter" type="text" placeholder="Filter (e.g., sin, sqrt, log)…"
                style="flex:1; padding:8px 10px; border:1px solid #ddd; border-radius:8px; font-size:14px;">
            <button id="closePopover" type="button" aria-label="Close"
                style="height:32px; width:32px; border-radius:8px; border:1px solid #ddd; background:#fff; cursor:pointer;">✕</button>
        </div>

        <!-- Action grid: now with top-row keys -->
        <div id="fnGrid"
            style="display:grid; grid-template-columns:repeat(4, minmax(0,1fr)); gap:6px; max-height:320px; overflow:auto;">
            <!-- Top row: basic variable and operator keys -->
            <button class="fn" id="clearEquationBtn" title="C">CLEAR</button>
            <button class="fn" data-insert="y" title="y">y</button>
            <button class="fn" data-insert="=" title="equals">=</button>
            <button class="fn" data-insert="x" title="x">x</button>
            <button class="fn" data-insert="+" title="plus">+</button>
            <button class="fn" data-insert="-" title="minus">−</button>
            <button class="fn" data-insert="*" title="multiply">*</button>
            <button class="fn" data-insert="/" title="divide">/</button>
            <button class="fn" data-wrap-start="sqrt(" data-wrap-end=")" title="sqrt(x)">√(·)</button>
            <button class="fn" data-insert="^2" title="square">^2</button>
            <button class="fn" data-insert="^3" title="cube">^3</button>
            <button class="fn" data-insert="^" title="power">x^y</button>

            <!-- Trigonometric -->
            <button class="fn" data-wrap-start="sin(" data-wrap-end=")" title="sin(x)">sin(·)</button>
            <button class="fn" data-wrap-start="cos(" data-wrap-end=")" title="cos(x)">cos(·)</button>
            <button class="fn" data-wrap-start="tan(" data-wrap-end=")" title="tan(x)">tan(·)</button>
            <button class="fn" data-wrap-start="asin(" data-wrap-end=")" title="asin(x)">asin(·)</button>
            <button class="fn" data-wrap-start="acos(" data-wrap-end=")" title="acos(x)">acos(·)</button>
            <button class="fn" data-wrap-start="atan(" data-wrap-end=")" title="atan(x)">atan(·)</button>
            <button class="fn" data-wrap-start="atan2(" data-wrap-end=", y)" title="atan2(x, y)">atan2(·,y)</button>

            <!-- Hyperbolic -->
            <button class="fn" data-wrap-start="sinh(" data-wrap-end=")" title="sinh(x)">sinh(·)</button>
            <button class="fn" data-wrap-start="cosh(" data-wrap-end=")" title="cosh(x)">cosh(·)</button>
            <button class="fn" data-wrap-start="tanh(" data-wrap-end=")" title="tanh(x)">tanh(·)</button>
            <button class="fn" data-wrap-start="asinh(" data-wrap-end=")" title="asinh(x)">asinh(·)</button>
            <button class="fn" data-wrap-start="acosh(" data-wrap-end=")" title="acosh(x)">acosh(·)</button>
            <button class="fn" data-wrap-start="atanh(" data-wrap-end=")" title="atanh(x)">atanh(·)</button>

            <!-- Advanced Roots & powers -->
            <button class="fn" data-wrap-start="pow(" data-wrap-end=", 2)" title="pow(x, 2)">pow(·,2)</button>
            <button class="fn" data-wrap-start="pow(" data-wrap-end=", y)" title="pow(x, y)">pow(·,y)</button>
            <button class="fn" data-wrap-start="hypot(" data-wrap-end=", y)" title="hypot(x, y)">hypot(·,y)</button>

            <!-- Exponentials & logs -->
            <button class="fn" data-wrap-start="exp(" data-wrap-end=")" title="e^x">exp(·)</button>
            <button class="fn" data-wrap-start="log(" data-wrap-end=")" title="natural log">ln(·)</button>
            <button class="fn" data-wrap-start="log10(" data-wrap-end=")" title="log base 10">log10(·)</button>
            <button class="fn" data-wrap-start="log(" data-wrap-end=", 2)" title="log base 2">log(·,2)</button>
            <button class="fn" data-wrap-start="log(" data-wrap-end=", 10)" title="log base 10 (alt)">log(·,10)</button>
            <button class="fn" data-wrap-start="log(" data-wrap-end=", b)" title="log base b">log(·,b)</button>

            <!-- Rounding / misc numeric -->
            <button class="fn" data-wrap-start="round(" data-wrap-end=", 2)" title="round(x, 2)">round(·,2)</button>
            <button class="fn" data-wrap-start="floor(" data-wrap-end=")" title="floor(x)">floor(·)</button>
            <button class="fn" data-wrap-start="ceil(" data-wrap-end=")" title="ceil(x)">ceil(·)</button>
            <button class="fn" data-wrap-start="sign(" data-wrap-end=")" title="sign(x)">sign(·)</button>
            <button class="fn" data-wrap-start="abs(" data-wrap-end=")" title="abs(x)">abs(·)</button>
            <button class="fn" data-wrap-start="min(" data-wrap-end=", 1)" title="min(x, 1)">min(·,1)</button>
            <button class="fn" data-wrap-start="max(" data-wrap-end=", 1)" title="max(x, 1)">max(·,1)</button>

            <!-- Constants & punctuation -->
            <button class="fn" data-insert="pi" title="π">pi</button>
            <button class="fn" data-insert="e" title="Euler’s number">e</button>
            <button class="fn" data-insert="(" title="left paren">(</button>
            <button class="fn" data-insert=")" title="right paren">)</button>
            <button class="fn" data-insert="," title="comma">,</button>
            <button class="fn" data-insert=" " title="space">␠</button>

            <!-- Equation generators -->
            <button class="fn" id="openCymaticsModal" title="Digital Cymatics Equation Generator">ψ</button>
        </div>

        <div style="font-size:12px; color:#666; margin-top:8px;">
            Tip: Select text first to wrap it, or place the cursor to insert. Open with <kbd>Ctrl/⌘</kbd>+<kbd>K</kbd>,
            close with <kbd>Esc</kbd>.
        </div>
    </div>
    <!-- END of Math Input Popover -->

    <!-- Equation Modal -->
    <div
        id="equationModal"
        class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50"
    >
        <div
            class="relative bg-white rounded-lg shadow-lg p-8 max-w-4xl w-full max-h-[90vh] h-[70vh] overflow-hidden mx-4 flex flex-col"
        >
            <button
                id="equationModalClose"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none"
                type="button"
            >
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">Equation</h2>

            <div class="flex-1 mb-4">
                <textarea
                    id="equationModalTextarea"
                    class="w-full h-full min-h-[320px] border border-gray-300 rounded-md p-3 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 resize-none"
                    spellcheck="false"
                    autocapitalize="off"
                ></textarea>
            </div>

            <div class="flex justify-end space-x-3 pt-2 border-t border-gray-200">
                <button
                    id="equationModalCancel"
                    class="px-4 py-2 bg-gray-100 text-gray-800 rounded-md hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    type="button"
                >
                    Cancel
                </button>
                <button
                    id="equationModalUpdate"
                    class="px-4 py-2 bg-gray-800 text-white rounded-md hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500"
                    type="button"
                >
                    Update
                </button>
            </div>
        </div>
    </div>

    <!-- Cymatics Modal -->
    <div
        id="cymaticsModal"
        class="hidden fixed inset-0 bg-black/50 flex items-center justify-center z-50 ">
        <!-- Modal content -->
        <div
            x-transition
            class="relative bg-white rounded-lg shadow-lg p-6 max-w-lg w-full max-h-[90vh] overflow-y-auto mx-4"
        >
            <!-- X button -->
            <button
                id="cymaticsModalClose"
                class="absolute top-3 right-3 text-gray-500 hover:text-gray-700 text-xl font-bold focus:outline-none"
                type="button"
            >
                &times;
            </button>

            <h2 class="text-xl font-semibold mb-4">
                Digital Cymatics Equation Generator
            </h2>

            <div class="bg-white w-full">
                <!-- Resonator Settings -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">
                        Resonator Settings
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label
                                for="numResonatorsInput"
                                class="block text-sm font-medium text-gray-600"
                                >Number of Resonators</label
                            >
                            <input
                                type="number"
                                id="numResonatorsInput"
                                name="numResonatorsInput"
                                min="1"
                                step="1"
                                required
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            />
                        </div>
                        <div>
                            <label
                                for="distanceInput"
                                class="block text-sm font-medium text-gray-600"
                                >Distance from Center</label
                            >
                            <input
                                type="number"
                                id="distanceInput"
                                name="distanceInput"
                                step="any"
                                required
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            />
                        </div>
                    </div>
                </div>

                <!-- Wave Parameters -->
                <div class="mb-4">
                    <h3 class="text-lg font-semibold mb-2 text-gray-700">
                        Wave Parameters
                    </h3>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <div>
                            <label
                                for="amplitudeInput"
                                class="block text-sm font-medium text-gray-600"
                                >Amplitude</label
                            >
                            <input
                                type="number"
                                id="amplitudeInput"
                                name="amplitudeInput"
                                step="any"
                                required
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            />
                        </div>
                        <div>
                            <label
                                for="frequencyInput"
                                class="block text-sm font-medium text-gray-600"
                                >Frequency</label
                            >
                            <input
                                type="number"
                                id="frequencyInput"
                                name="frequencyInput"
                                step="any"
                                required
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            />
                        </div>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                        <div>
                            <label
                                for="phaseInput"
                                class="block text-sm font-medium text-gray-600"
                                >Phase</label
                            >
                            <input
                                type="number"
                                id="phaseInput"
                                name="phaseInput"
                                step="any"
                                required
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            />
                        </div>
                        <div>
                            <label
                                for="combineOperatorInput"
                                class="block text-sm font-medium text-gray-600"
                                >Combine Operator</label
                            >
                            <select
                                id="combineOperatorInput"
                                name="combineOperatorInput"
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500 bg-white"
                            >
                                <option value="+">+</option>
                                <option value="-">-</option>
                                <option value="*">*</option>
                                <option value="/">/</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Rotation & Visualization -->
                <div class="mb-4">
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-start">
                        <div>
                            <h3 class="text-lg font-semibold mb-2 text-gray-700">
                                Rotation
                            </h3>
                            <label
                                for="rotateRadiansInput"
                                class="block text-sm font-medium text-gray-600"
                                >Rotate (radians)</label
                            >
                            <input
                                type="number"
                                id="rotateRadiansInput"
                                name="rotateRadiansInput"
                                step="any"
                                required
                                class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                            />
                            <p class="mt-1 text-xs text-gray-500">
                                π/2 (~1.571) = 90° rotation
                            </p>
                        </div>

                        <!-- Canvas visualization -->
                        <div class="flex flex-col items-center">
                            <h3 class="text-lg font-semibold mb-2 text-gray-700">
                                Layout Preview
                            </h3>
                            <canvas
                                id="resonatorCanvas"
                                width="200"
                                height="200"
                                class="border border-gray-300 shadow-sm w-32 h-32 sm:w-48 sm:h-48"
                            ></canvas>
                            <p class="mt-1 text-xs text-gray-500">
                                Points represent resonators (centered at 0,0).
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Bottom buttons -->
                <div class="mt-6 flex items-center justify-center pb-20 sm:pb-6">
                    <button
                        type="button"
                        id="insertCymaticsEquationButton"
                        class="px-6 py-2 bg-gray-800 text-white font-semibold rounded-md shadow-sm hover:bg-gray-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 flex items-center justify-center"
                    >
                        <span class="inline text-gray-200 mr-2">Insert Equation</span>
                        <svg
                            class="w-5 h-5"
                            fill="none"
                            stroke="currentColor"
                            viewBox="0 0 24 24"
                        >
                            <path
                                stroke-linecap="round"
                                stroke-linejoin="round"
                                stroke-width="2"
                                d="M12 4v16m8-8H4"
                            />
                        </svg>
                    </button>
                </div>


            </div>
        </div>
    </div>


    <script>
        window.process = { env: { NODE_ENV: "development" } };
    </script>

    <script type="module">
        import { math } from "mathjs";
        import { atom, map } from "nanostores";
        import { evaluate_cmap, data as js_colormaps_data } from "./js/js-colormaps";
        import {
            parseEquationString,
            displayGraph,
            calcWindowBounds,
            getXWidth,
            makeLinearMapper,
            ZOOM_RATE
        } from './js/fuzzygraph_glsl.js';
        import {
            uniformly_distributed_points,
            cymatics_equation_generator
        } from './js/cymatics.js';

        const version = '3';
        const yHeightAtZoom1 = 6;
        const defaultMaxOverride = 5;

        const equation = atom('y ≈ x^2 - 1');
        const fuzzyLevel = atom(30);
        const showAxes = atom(true);
        const colorMap = atom('plasma');
        const invertColor = atom(true);
        const xCenter = atom(0);
        const yCenter = atom(0);
        const yHeight = atom(yHeightAtZoom1);

        // Advanced stuff
        const advancedMode = atom(false);
        const minVal = atom(null);
        const maxVal = atom(null);
        const minOverride = atom(null);
        const maxOverride = atom(defaultMaxOverride);

        const sidebarOpen = atom(true);
        const mobileMenuOpen = atom(false);

        const hoverMsg = atom('Loading...');
        const showError = atom(false);
        const isLoading = atom(true);

        const showShareModal = atom(false);
        const showSaveModal = atom(false);
        const showGotoModal = atom(false);
        const showOpenModal = atom(false);
        const showHelpModal = atom(false);
        const showEquationHelpModal = atom(false);
        const showControlsHelpModal = atom(false);
        const showColorMapHelpModal = atom(false);
        const showAdvancedHelpModal = atom(false);
        const showEquationModal = atom(false);
        const showCymaticsModal = atom(false);
        const cymaticsConfig = map({
            numResonators: 2,
            distance: 2,
            amplitude: 1.0,
            frequency: 1.0,
            phase: 0.0,
            combineOperator: '+',
            rotateRadians: 0,
        });
        const unmodifiedCymaticsEquation = atom(false);

        // Save modal variables
        const saveWidth = atom(0);
        const saveHeight = atom(0);
        const saveCenterX = atom(0);
        const saveCenterY = atom(0);
        const saveYHeight = atom(yHeightAtZoom1);
        const saveShowAxes = atom(true);
        const saveDefaultConfig = atom(true);

        var pixelValuesStore = atom([]);

        function getStrippedEquation() {
            return equation.get().replace(/\s+/g, "");
        }

        function checkCanvasSize(canvas) {
            const ctx = canvas.getContext('2d');
            const dpr = window.devicePixelRatio || 1
            const rect = canvas.getBoundingClientRect()
            canvas.width = Math.max(1, Math.round(rect.width * dpr))
            canvas.height = Math.max(1, Math.round(rect.height * dpr))
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0) // user-space: CSS pixels
        }

        function startLoading() {
            isLoading.set(true);
            document.getElementById('hoverMsgDiv').style.display = 'block';
            hoverMsg.set("Loading...");
        }

        function stopLoading() {
            document.getElementById('hoverMsgDiv').style.display = 'none';
            hoverMsg.set('');
            isLoading.set(false);
        }

        function debounceLatest(fn, delay) {
            let timeoutId;
            return function (...args) {
                // Clear the previous scheduled call
                if (timeoutId) {
                    clearTimeout(timeoutId);
                }

                // Schedule the new call
                timeoutId = setTimeout(() => {
                    fn.apply(this, args);
                }, delay);
            };
        }

        function getEquationErrorDetails(equationStr) {
            if (!equationStr.includes('=') && !equationStr.includes('≈')) {
                return ' - equation must have an equals sign (=)'
            } else if (!equationStr.includes('x') && !equationStr.includes('y') && !equationStr.includes('r')) {
                return ' - equation should include x or y (probably both)'
            }
            else {
                return '';
            }
        }

        function paintGraph() {
            // startLoading();
            const canvas = document.getElementById('mainCanvas');

            // Compile equation using math.js (parseEquationString)
            const parsedEquation = parseEquationString(getStrippedEquation());

            if (parsedEquation) {
                var graphConfig = {
                    equationFunction: parsedEquation,
                    fuzzyLevel: fuzzyLevel.get(),
                    colorMap: colorMap.get(),
                    invertColor: invertColor.get(),
                    xCenter: xCenter.get(),
                    yCenter: yCenter.get(),
                    yHeight: yHeight.get(),
                    showAxes: showAxes.get(),
                    minOverride: minOverride.get(),
                    maxOverride: maxOverride.get()
                };

                const graphResult = displayGraph(graphConfig, canvas);
                const pixelValuesNew = graphResult['pixelValues']
                const minV = graphResult['min'];
                const maxV = graphResult['max'];
                minVal.set(minV);
                maxVal.set(maxV);
                
                stopLoading();
                pixelValuesStore.set(pixelValuesNew);
                // hoverMsg.set('');
                // document.getElementById('hoverMsgDiv').style.display = 'none';
            } else {
                document.getElementById('hoverMsgDiv').style.display = 'block';

                // TODO: More particular message
                const errorDetails = getEquationErrorDetails(getStrippedEquation());
                hoverMsg.set('Equation is invalid' + errorDetails);
            }
        }

        const paintGraphDebounced = debounceLatest(paintGraph, 1000);

        function scheduleRepaint() {
            startLoading();
            paintGraphDebounced();
        }

        // Download FuzzyGraph
        function downloadFuzzygraph() {
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'FuzzyGraph_v3.0.1.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Save Image
        async function saveImage(w=null, h=null, cX=null, cY=null, yH=null) {
            const sW = w ?? saveWidth.get();
            const sH = h ?? saveHeight.get();
            const sCX = cX ?? saveCenterX.get();
            const sCY = cY ?? saveCenterY.get();
            const sYH = yH ?? saveYHeight.get();
            if (w | h | cX | cY | yH) {
                // If we received any of these, then this is not from the UI, and we need to render
                saveDefaultConfig.set(false);
            }

            let saveCanvas = null;

            if (saveDefaultConfig.get()) {
                // If no defaults were changed in the Save Image modal,
                // we can just copy the image from the main canvas.
                saveCanvas = canvas;
            } else {
                // But if any parameters in the Save Image modal were changed,
                // we need to fully repaint the image in a new off-DOM canvas.
                saveCanvas = document.createElement('canvas');
                saveCanvas.width = sW;
                saveCanvas.height = sH;

                // Compile equation using math.js (parseEquationString)
                const parsedEquation = parseEquationString(getStrippedEquation());

                var graphConfig = {
                    equationFunction: parsedEquation,
                    fuzzyLevel: fuzzyLevel.get(),
                    colorMap: colorMap.get(),
                    invertColor: invertColor.get(),
                    xCenter: parseFloat(sCX),
                    yCenter: parseFloat(sCY),
                    yHeight: parseFloat(sYH),
                    minOverride: minOverride.get(),
                    maxOverride: maxOverride.get(),
                    showAxes: saveShowAxes.get()
                };

                displayGraph(graphConfig, saveCanvas);
            }

            const ctx = saveCanvas.getContext('2d');

            // Logic to embed graph config data into the generated png file
            // Add a JSON object as UTF-8 iTXt metadata to a PNG Blob.
            // Returns a new PNG Blob.
            async function addJsonITXtToPng(blob, json, keyword = "graphconfig") {
                // NOTE: This function generated by ChatGPT 5 (2025-09-08)
                const buf = await blob.arrayBuffer();
                const u8  = new Uint8Array(buf);

                // --- sanity check signature ---
                const sig = [137,80,78,71,13,10,26,10];
                for (let i = 0; i < 8; i++) if (u8[i] !== sig[i]) throw new Error("Not a PNG");

                // --- walk chunks to find IEND offset ---
                let p = 8;
                let iendPos = -1;
                while (p + 8 <= u8.length) {
                    const len = readU32(u8, p);          // chunk data length
                    const type = readType(u8, p + 4);    // e.g., 'IHDR','IDAT','IEND'
                    const next = p + 12 + len;           // move past [len][type][data][crc]
                    if (type === "IEND") { iendPos = p; break; }
                    p = next;
                }
                if (iendPos < 0) throw new Error("Malformed PNG (no IEND)");

                // --- build iTXt chunk data (UTF-8, uncompressed) ---
                // iTXt layout:
                // keyword\0 compressionFlag(0|1) compressionMethod(0)
                // languageTag\0 translatedKeyword\0 text(UTF-8 or zlib-compressed UTF-8)
                const enc = new TextEncoder();
                const keywordBytes = enc.encode(keyword);             // ASCII in spec, but encoder is fine
                const langBytes = new Uint8Array(0);                  // empty language tag
                const translatedBytes = new Uint8Array(0);            // empty translated keyword
                const textBytes = enc.encode(JSON.stringify(json));   // your JSON as UTF-8

                const parts = [
                    keywordBytes, zero(),                               // keyword\0
                    u8byte(0),                                          // compressionFlag = 0 (uncompressed)
                    u8byte(0),                                          // compressionMethod = 0
                    langBytes, zero(),                                  // languageTag\0
                    translatedBytes, zero(),                            // translatedKeyword\0
                    textBytes                                           // the text payload
                ];
                const itxtData = concat(parts);

                const itxtChunk = buildChunk("iTXt", itxtData);

                // --- assemble: everything before IEND + our iTXt + IEND..end ---
                const out = new Uint8Array(u8.length + itxtChunk.length);
                out.set(u8.subarray(0, iendPos), 0);
                out.set(itxtChunk, iendPos);
                out.set(u8.subarray(iendPos), iendPos + itxtChunk.length);

                return new Blob([out], { type: "image/png" });

                // -------- helpers --------
                function readU32(a, i)   { return (a[i]<<24 | a[i+1]<<16 | a[i+2]<<8 | a[i+3]) >>> 0; }
                function readType(a, i)  { return String.fromCharCode(a[i],a[i+1],a[i+2],a[i+3]); }
                function u8byte(n)       { return new Uint8Array([n & 255]); }
                function zero()          { return u8byte(0); }
                function concat(arrs) {
                    let len = 0; arrs.forEach(a => len += a.length);
                    const o = new Uint8Array(len);
                    let off = 0; arrs.forEach(a => { o.set(a, off); off += a.length; });
                    return o;
                }
                function buildChunk(type4, data) {
                    const enc = new TextEncoder();
                    const typeBytes = enc.encode(type4); // 4 bytes
                    const lenBytes  = u32BE(data.length);
                    const crcBytes  = u32BE(crc32(join(typeBytes, data)));
                    const out = new Uint8Array(4 + 4 + data.length + 4);
                    out.set(lenBytes, 0);
                    out.set(typeBytes, 4);
                    out.set(data, 8);
                    out.set(crcBytes, 8 + data.length);
                    return out;

                    function join(a,b){ const o=new Uint8Array(a.length+b.length); o.set(a,0); o.set(b,a.length); return o; }
                    function u32BE(n){ const b=new Uint8Array(4); b[0]=n>>>24; b[1]=n>>>16; b[2]=n>>>8; b[3]=n; return b; }
                    function crc32(bytes){
                    let c = 0xFFFFFFFF >>> 0;
                    for (let i=0;i<bytes.length;i++){
                        c = (c ^ bytes[i]) >>> 0;
                        for (let k=0;k<8;k++) c = (c & 1) ? (0xEDB88320 ^ (c >>> 1)) >>> 0 : (c >>> 1) >>> 0;
                    }
                    return (~c) >>> 0;
                    }
                }
            }

            function getFilenameWithTimestamp() {
                const now = new Date();
                const timestamp = now.getFullYear() + "-" +
                    String(now.getMonth() + 1).padStart(2, '0') + "-" +
                    String(now.getDate()).padStart(2, '0') + "_" +
                    String(now.getHours()).padStart(2, '0') + "_" +
                    String(now.getMinutes()).padStart(2, '0') + "_" +
                    String(now.getSeconds()).padStart(2, '0');

                return `fuzzygraph_${timestamp}.png`;
            }

            // Helpers
            function downloadBlob(blob, filename) {
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                a.remove();
                setTimeout(() => URL.revokeObjectURL(url), 1000);
            }

            function canvasToBlob(canvas, type = 'image/png', quality) {
              return new Promise(resolve => canvas.toBlob(resolve, type, quality));
            }

            // Convert canvas into an in-memory PNG file
            const imgBlob = await canvasToBlob(saveCanvas, 'image/png');

            // Embed graph config data into the PNG file (so it can be re-opened in FuzzyGraph)
            var graphConfig = getAppConfig();

            // Don't add advanced stuff if not in advanced mode
            if (!graphConfig['advancedMode']) {
                delete graphConfig['advancedMode'];
                delete graphConfig['minOverride'];
                delete graphConfig['maxOverride'];
            }

            // Add some metadata
            graphConfig['source'] = 'FuzzyGraph';
            graphConfig['createdDate'] = new Date().toISOString().split('T')[0];

            const imgBlobWithData = await addJsonITXtToPng(imgBlob, graphConfig);

            const filename = getFilenameWithTimestamp();
            downloadBlob(imgBlobWithData, filename);
        }


        // // // // // // // Open Logic
        const pngInput  = document.getElementById('pngInput');
        const uploadResult = document.getElementById('openResult');

        // var configFromImage = {};
        function loadGraphFromImage(configFromImage) {
            if (configFromImage) {
                setConfigFromObj(configFromImage);
                // Close Open Modal
                showOpenModal.set(false);
                uploadResult.textContent = "";
            }
        }

        pngInput.addEventListener('change', async () => {
            const file = pngInput.files?.[0];
            if (!file) return;
            try {
                const text = await readITXtByKeyword(file, "graphconfig");
                let parsed;
                try { parsed = JSON.parse(text); } catch {}
                loadGraphFromImage(parsed);
            } catch (err) {
                uploadResult.textContent = "No FuzzyGraph config found";
            }
        });

        /** Read iTXt chunk with a given keyword from a PNG Blob/ArrayBuffer. Returns UTF-8 text string. */
        async function readITXtByKeyword(blobOrArrayBuffer, targetKeyword) {
            const ab = blobOrArrayBuffer.arrayBuffer
                        ? await blobOrArrayBuffer.arrayBuffer()
                        : blobOrArrayBuffer;
            const u8 = new Uint8Array(ab);

            // --- PNG signature check ---
            const sig = [137,80,78,71,13,10,26,10];
            for (let i = 0; i < 8; i++) if (u8[i] !== sig[i]) throw new Error("Not a PNG.");

            // --- iterate chunks ---
            let p = 8;
            while (p + 8 <= u8.length) {
                const len  = readU32(u8, p);
                const type = strFrom4(u8, p + 4);
                const dataStart = p + 8;
                const dataEnd   = dataStart + len;
                const next      = dataEnd + 4; // + CRC

                if (dataEnd > u8.length || next > u8.length) break;

                if (type === "iTXt") {
                const maybe = await parseITXt(u8.subarray(dataStart, dataEnd), targetKeyword);
                if (maybe != null) return maybe; // found it
                }
                if (type === "IEND") break;
                p = next;
            }
            throw new Error(`No iTXt chunk with keyword "${targetKeyword}" found.`);
        }

        /** Parse an iTXt chunk and return the UTF-8 text if the keyword matches; else null. */
        async function parseITXt(data, targetKeyword) {
            // iTXt data layout:
            // keyword\0 compressionFlag(1) compressionMethod(1)
            // languageTag\0 translatedKeyword\0 text(UTF-8 or zlib-compressed UTF-8)
            let off = 0;

            const decLatin1 = new TextDecoder("latin1");
            const decUTF8   = new TextDecoder("utf-8");

            const key = readZ(data, off);               off = key.next;
            const keyword = decLatin1.decode(key.bytes); // spec uses Latin-1 for keyword
            if (keyword !== targetKeyword) return null;

            const compressionFlag   = data[off++];
            const compressionMethod = data[off++];
            const lang = readZ(data, off);              off = lang.next; // languageTag (ignored)
            const trkw = readZ(data, off);              off = trkw.next; // translated keyword (ignored)

            let textBytes = data.subarray(off);

            if (compressionFlag === 0) {
                return decUTF8.decode(textBytes);
            } else if (compressionFlag === 1 && compressionMethod === 0) {
                // zlib-compressed UTF-8 text
                const inflated = await inflateZlib(textBytes);
                return decUTF8.decode(inflated);
            } else {
                throw new Error(`Unsupported iTXt compression (flag=${compressionFlag}, method=${compressionMethod}).`);
            }
        }

        /** Inflate zlib bytes using the browser’s DecompressionStream when available (no libs). */
        async function inflateZlib(bytes) {
            if (typeof DecompressionStream === "function") {
                // 'deflate' works for zlib-wrapped DEFLATE streams in modern Chromium/Firefox.
                const ds = new DecompressionStream('deflate');
                const stream = new Blob([bytes]).stream().pipeThrough(ds);
                const buf = await new Response(stream).arrayBuffer();
                return new Uint8Array(buf);
            }
            // Fallback: tell the caller they need a small library (e.g., pako) if their PNG uses compression.
            throw new Error("Compressed iTXt requires DecompressionStream support or a small inflate library.");
        }

        /** Helpers */
        function readU32(a, i) { return ((a[i]<<24) | (a[i+1]<<16) | (a[i+2]<<8) | a[i+3]) >>> 0; }
        function strFrom4(a,i) { return String.fromCharCode(a[i],a[i+1],a[i+2],a[i+3]); }
        function readZ(a, start) {
            let i = start;
            while (i < a.length && a[i] !== 0) i++;
            return { bytes: a.subarray(start, i), next: i + 1 };
        }

        function formatNumber(num) {
            if (num == null) { return ''; }

             // Handle very small numbers like 8.88e-16
            if (Math.abs(num) < 0.000001) {
                return '0';
            }
            else if (Math.abs(num) >= 1000000) {
                return num.toExponential(8); // e.g., "8.8888e-16"
            }

            // Otherwise, use fixed decimal, trimmed
            let str = num.toFixed(8);      // up to 8 decimals
            str = str.replace(/\.?0+$/, ''); // strip trailing zeros
            return str.length > 8 ? str.slice(0, 8) : str;
        }

        minVal.subscribe((minV) => {
            document.getElementById('minDisplay').textContent = formatNumber(minV);
        });

        maxVal.subscribe((maxV) => {
            document.getElementById('maxDisplay').textContent = formatNumber(maxV);
        });

        const minToggle = document.getElementById("minOverrideToggle");
        const minKnob = minToggle.querySelector(".knob");
        const minInput = document.getElementById("minOverrideInput");

        const maxToggle = document.getElementById("maxOverrideToggle");
        const maxKnob = maxToggle.querySelector(".knob");
        const maxInput = document.getElementById("maxOverrideInput");

        function setMinOverrideEnabled(enabled) {
            minToggle.setAttribute("aria-pressed", String(enabled));
            minInput.disabled = !enabled;

            if (enabled) {
                // ON: dark track, light knob, knob right (advanced-style)
                minToggle.classList.remove("bg-gray-500");
                minToggle.classList.add("bg-gray-800");
                minKnob.classList.remove("translate-x-1", "bg-gray-700");
                minKnob.classList.add("translate-x-5", "bg-gray-50");
                minInput.classList.remove("bg-gray-100", "text-gray-500");
            } else {
                // OFF: medium track, dark knob, knob left
                minToggle.classList.remove("bg-gray-800");
                minToggle.classList.add("bg-gray-500");
                minKnob.classList.remove("translate-x-5", "bg-gray-50");
                minKnob.classList.add("translate-x-1", "bg-gray-700");
                minInput.classList.add("bg-gray-100", "text-gray-500");

                minOverride.set(null);
            }
        }

        function setMaxOverrideEnabled(enabled) {
            maxToggle.setAttribute("aria-pressed", String(enabled));
            maxInput.disabled = !enabled;

            if (enabled) {
                // ON: dark track, light knob, knob right (advanced-style)
                maxToggle.classList.remove("bg-gray-500");
                maxToggle.classList.add("bg-gray-800");
                maxKnob.classList.remove("translate-x-1", "bg-gray-700");
                maxKnob.classList.add("translate-x-5", "bg-gray-50");
                maxInput.classList.remove("bg-gray-100", "text-gray-500");
            } else {
                // OFF: medium track, dark knob, knob left
                maxToggle.classList.remove("bg-gray-800");
                maxToggle.classList.add("bg-gray-500");
                maxKnob.classList.remove("translate-x-5", "bg-gray-50");
                maxKnob.classList.add("translate-x-1", "bg-gray-700");
                maxInput.classList.add("bg-gray-100", "text-gray-500");

                maxOverride.set(null);
            }
        }

        function toggleMinOverride() {
            const isOn = minToggle.getAttribute("aria-pressed") === "true";
            setMinOverrideEnabled(!isOn);
        }

        function toggleMaxOverride() {
            const isOn = maxToggle.getAttribute("aria-pressed") === "true";
            setMaxOverrideEnabled(!isOn);
        }

        minToggle.addEventListener("click", toggleMinOverride);
        maxToggle.addEventListener("click", toggleMaxOverride);

        minOverride.subscribe((minO) => {
            document.getElementById('minOverrideInput').value = minO;
            if (minO == null || minO == '') {
                setMinOverrideEnabled(false);
            }
            else {
                setMinOverrideEnabled(true);
            }
            scheduleRepaint();
        });

        maxOverride.subscribe((maxO) => {
            document.getElementById('maxOverrideInput').value = maxO;
            if (maxO == null || maxO == '') {
                setMaxOverrideEnabled(false);
            }
            else {
                setMaxOverrideEnabled(true);
            }
            scheduleRepaint();
        });

        function clearMinAndMaxOverrides() {
            minOverride.set(null);
            maxOverride.set(defaultMaxOverride);
        }

        document.getElementById('minOverrideInput').addEventListener('input', (event) => {
            minOverride.set(event.target.value);
        });

        document.getElementById('maxOverrideInput').addEventListener('input', (event) => {
            maxOverride.set(event.target.value);
        });

        document.getElementById('saveImageButton').addEventListener('click', async () => {
            saveImage();
        });

        function setMode(advancedMode) {
            const checked = advancedMode;
            const btn = document.getElementById('modeToggle');
            const thumb = document.getElementById('modeThumb');
            const advancedSection = document.getElementById('advancedSection');
            const label = document.getElementById('modeLabel');

            btn.setAttribute('aria-checked', String(checked));

            // Track and thumb color
            if (checked) {
                btn.classList.remove('bg-gray-500');
                btn.classList.add('bg-gray-800');
                // thumb.classList.remove('bg-gray-700');
                // thumb.classList.add('bg-gray-50');
                advancedSection.classList.remove('hidden');
                label.textContent = 'Advanced';
            } else {
                btn.classList.remove('bg-gray-800');
                btn.classList.add('bg-gray-500');
                // thumb.classList.remove('bg-gray-50');
                // thumb.classList.add('bg-gray-700');
                advancedSection.classList.add('hidden');
                label.textContent = 'Basic';

                // Clear min and max overrides since they are no longer visible
                clearMinAndMaxOverrides();
            }

            // Thumb position
            thumb.classList.toggle('translate-x-1', !checked);
            thumb.classList.toggle('translate-x-7', checked);
        }

        function toggleMode() {
            const nextMode = document.getElementById('modeToggle').getAttribute('aria-checked') !== 'true';
            advancedMode.set(nextMode);
        }

        document.getElementById('modeToggle').addEventListener('click', toggleMode);


        advancedMode.subscribe((checked) => {
            setMode(checked);
        });

        saveShowAxes.subscribe((show) => {
            const slider = document.getElementById('saveAxesOnSlider');
            const toggleEl = document.getElementById('saveAxesToggle');

            slider.classList.remove('translate-x-1', 'translate-x-7');
            slider.classList.add(show ? 'translate-x-7' : 'translate-x-1');

            toggleEl.classList.remove('bg-gray-500', 'bg-gray-800', 'bg-blue-600', 'bg-gray-200');
            toggleEl.classList.add(show ? 'bg-gray-800' : 'bg-gray-500');

            toggleEl.setAttribute('aria-checked', show);
        });

        document.getElementById('saveWidthInput').addEventListener('input', (event) => {
            saveWidth.set(event.target.value);
            saveDefaultConfig.set(false);
        });
        document.getElementById('saveHeightInput').addEventListener('input', (event) => {
            saveHeight.set(event.target.value);
            saveDefaultConfig.set(false);
        });
        document.getElementById('saveCenterXInput').addEventListener('input', (event) => {
            saveCenterX.set(event.target.value);
            saveDefaultConfig.set(false);
        });
        document.getElementById('saveCenterYInput').addEventListener('input', (event) => {
            saveCenterY.set(event.target.value);
            saveDefaultConfig.set(false);
        });
        document.getElementById('saveYHeightInput').addEventListener('input', (event) => {
            saveYHeight.set(event.target.value);
            saveDefaultConfig.set(false);
        });
        document.getElementById('saveAxesToggle').addEventListener('click', () => {
            saveShowAxes.set(!saveShowAxes.get());
            saveDefaultConfig.set(false);
        });

        saveWidth.subscribe((val) => {
            document.getElementById('saveWidthInput').value = val;
        });
        saveHeight.subscribe((val) => {
            document.getElementById('saveHeightInput').value = val;
        });
        saveCenterX.subscribe((val) => {
            document.getElementById('saveCenterXInput').value = val;
        });
        saveCenterY.subscribe((val) => {
            document.getElementById('saveCenterYInput').value = val;
        });
        saveYHeight.subscribe((val) => {
            document.getElementById('saveYHeightInput').value = val;
        });

        function populateGotoModalFields() {
            document.getElementById('gotoCenterXInput').value = xCenter.get();
            document.getElementById('gotoCenterYInput').value = yCenter.get();
            document.getElementById('gotoZoomInput').value = yHeightAtZoom1 / yHeight.get();
        }


        // // // // // // // Event handling

        // Download offline copy of FuzzyGraph
        document.getElementById("downloadFuzzyGraphBtn").addEventListener('click', downloadFuzzygraph);

        // TOP MENU EVENTS
        showShareModal.listen((visible) => { document.getElementById('shareModal').classList.toggle('hidden', !visible); showURL(); });
        showHelpModal.listen((visible) => { document.getElementById('helpModal').classList.toggle('hidden', !visible); });
        showOpenModal.listen((visible) => { document.getElementById('openModal').classList.toggle('hidden', !visible); });
        showSaveModal.listen((visible) => {
            document.getElementById('saveModal').classList.toggle('hidden', !visible);
            // Set default values in Save Modal form
            if (visible) {
                saveWidth.set(canvas.width);
                saveHeight.set(canvas.height);
                saveCenterX.set(xCenter.get());
                saveCenterY.set(yCenter.get());
                saveYHeight.set(yHeight.get());
                saveShowAxes.set(showAxes.get());
                saveDefaultConfig.set(true);
            }
        });
        showGotoModal.listen((visible) => {
            document.getElementById('gotoModal').classList.toggle('hidden', !visible);
            if (visible) {
                populateGotoModalFields();
            }
        });

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape') {
                showShareModal.set(false);
                showSaveModal.set(false);
                showOpenModal.set(false);
                showHelpModal.set(false);
                showEquationHelpModal.set(false);
                showControlsHelpModal.set(false);
                showColorMapHelpModal.set(false);
                showAdvancedHelpModal.set(false);
                showEquationModal.set(false);
                showCymaticsModal.set(false);
                showGotoModal.set(false);
                closePopover();
            }
        });

        // Share logic
        function showURL() {
            // setUrlFromParams();
            // const shareURL = window.location.href;
            const shareURL = getShareUrl();
            document.getElementById('shareUrlInput').value = shareURL;
        }

        function copyURL() {
            const urlInput = document.getElementById('shareUrlInput');
            urlInput.select();
            try {
                document.execCommand('copy');
            } catch (err) {
                alert('Failed to copy URL');
            }
        }

        document.getElementById('copyUrlButton').addEventListener('click', () => { copyURL(); });

        // Small notification to show when the share url was copied
        document.getElementById('shareUrlInput').addEventListener('copy', function (e) {
            // Get input field position
            const rect = document.getElementById('shareUrlInput').getBoundingClientRect();
            const copytooltip = document.getElementById('copytooltip');

            // Position tooltip
            copytooltip.style.top = `${rect.bottom + window.scrollY + 5}px`;
            copytooltip.style.left = `${rect.left + window.scrollX}px`;

            // Show tooltip
            copytooltip.style.display = 'block';

            // Hide tooltip after 2 seconds
            setTimeout(() => {
                copytooltip.style.display = 'none';
            }, 2000);
        });

        // Desktop menu buttons
        document.getElementById('showShareButton').addEventListener('click', () => { showShareModal.set(!showShareModal.get()); });
        document.getElementById('showSaveButton').addEventListener('click', () => { showSaveModal.set(!showSaveModal.get()); });
        document.getElementById('showOpenButton').addEventListener('click', () => { showOpenModal.set(!showOpenModal.get()); });
        document.getElementById('showHelpButton').addEventListener('click', () => { showHelpModal.set(!showHelpModal.get()); });

        // Mobile menu buttons
        document.getElementById('mobileShowShareButton').addEventListener('click', () => { showShareModal.set(!showShareModal.get()); });
        document.getElementById('mobileShowSaveButton').addEventListener('click', () => { showSaveModal.set(!showSaveModal.get()); });
        document.getElementById('mobileShowOpenButton').addEventListener('click', () => { showOpenModal.set(!showOpenModal.get()); });
        document.getElementById('mobileShowHelpButton').addEventListener('click', () => { showHelpModal.set(!showHelpModal.get()); });

        // Modal X buttons
        document.getElementById('shareModalX').addEventListener('click', () => { showShareModal.set(false); });
        document.getElementById('saveModalX').addEventListener('click', () => { showSaveModal.set(false); });
        document.getElementById('openModalX').addEventListener('click', () => { showOpenModal.set(false); });
        document.getElementById('helpModalX').addEventListener('click', () => { showHelpModal.set(false); });
        document.getElementById('gotoModalX').addEventListener('click', () => { showGotoModal.set(false); });
        document.getElementById('gotoCancelButton').addEventListener('click', () => { showGotoModal.set(false); });
        document.getElementById('gotoSubmitButton').addEventListener('click', () => {
            const newX = parseFloat(document.getElementById('gotoCenterXInput').value);
            const newY = parseFloat(document.getElementById('gotoCenterYInput').value);
            const zoom = parseFloat(document.getElementById('gotoZoomInput').value);

            if (!Number.isFinite(newX) || !Number.isFinite(newY) || !Number.isFinite(zoom) || zoom === 0) {
                return;
            }

            xCenter.set(newX);
            yCenter.set(newY);
            yHeight.set(yHeightAtZoom1 / zoom);
            scheduleRepaint();
            showGotoModal.set(false);
        });

        // Mobile top menu
        mobileMenuOpen.subscribe((visible) => {
            document.getElementById('mobileMenu').classList.toggle('hidden', !visible);
        });

        document.getElementById('mobileMenuButton').addEventListener('click', () => { mobileMenuOpen.set(!mobileMenuOpen.get()); });

        // document.getElementById('controlPanel').addEventListener('transitionend', (e) => {
        //     if (e.propertyName === 'left' || e.propertyName === 'transform' || e.propertyName === 'width') {
        //         // Layout is final now
        //         resizeCanvas();
        //     }
        // });

        // CONTROL PANEL
        sidebarOpen.subscribe((visible) => {
            // TODO: Do this using simple visibility?
            document.getElementById('overCanvasControls').classList.remove('md:ml-64', 'md:ml-0');
            document.getElementById('overCanvasControls').classList.add(visible ? 'md:ml-64' : 'md:ml-0');

            document.getElementById('openControlPanelButton').classList.remove('opacity-0', 'pointer-events-none', 'opacity-100');
            if (visible) {
                document.getElementById('openControlPanelButton').classList.add('opacity-0', 'pointer-events-none');
            } else {
                document.getElementById('openControlPanelButton').classList.add('opacity-100');
            }

            document.getElementById('controlPanel').classList.remove('bottom-0', 'md:bottom-auto', 'md:top-16',
                'md:left-0', 'bottom-[-1000px]', 'md:bottom-auto',
                'md:top-16', 'md:left-[-1000px]');
            if (visible) {
                document.getElementById('controlPanel').classList.add('bottom-0', 'md:bottom-auto', 'md:top-16', 'md:left-0');
            } else {
                document.getElementById('controlPanel').classList.add('bottom-[-1000px]', 'md:bottom-auto', 'md:top-16', 'md:left-[-1000px]');
            }

            document.getElementById('mobileShowControlPanelButton').classList.remove('opacity-0', 'pointer-events-none', 'opacity-100');

            if (visible) {
                document.getElementById('mobileShowControlPanelButton').classList.add('opacity-0', 'pointer-events-none');
            } else {
                document.getElementById('mobileShowControlPanelButton').classList.add('opacity-100');
            }
        });

        document.getElementById('mobileShowControlPanelButton').addEventListener('click', () => { sidebarOpen.set(true); });
        document.getElementById('openControlPanelButton').addEventListener('click', () => { sidebarOpen.set(true); });
        document.getElementById('hideControlPanelButton').addEventListener('click', () => { sidebarOpen.set(false); });

        // CONTROL PANEL / Equation
        const equationModalTextarea = document.getElementById('equationModalTextarea');

        equation.subscribe((eq) => {
            document.getElementById('equationInput').value = eq;

            if (!document.getElementById('equationModal').classList.contains('hidden') && equationModalTextarea) {
                equationModalTextarea.value = eq;
            }

            // If not in advancd mode, clear the min and max overrides when the equation changes
            if (!advancedMode.get()) {
                clearMinAndMaxOverrides();
            }

            scheduleRepaint();
        });

        // CONTROL PANEL / Equation / Help
        document.getElementById('equationInput').addEventListener('input', (event) => {
            equation.set(event.target.value);
            unmodifiedCymaticsEquation.set(false);
        });

        showEquationModal.listen((visible) => {
            const modal = document.getElementById('equationModal');
            modal.classList.toggle('hidden', !visible);

            if (visible && equationModalTextarea) {
                const currentEquation = equation.get();
                equationModalTextarea.value = currentEquation;
                equationModalTextarea.focus();
                equationModalTextarea.setSelectionRange(currentEquation.length, currentEquation.length);
            }
        });

        document.getElementById('openEquationModalButton').addEventListener('click', () => {
            showEquationModal.set(true);
        });

        document.getElementById('equationModalClose').addEventListener('click', () => {
            showEquationModal.set(false);
        });

        document.getElementById('equationModalCancel').addEventListener('click', () => {
            showEquationModal.set(false);
        });

        document.getElementById('equationModalUpdate').addEventListener('click', () => {
            if (!equationModalTextarea) return;
            equation.set(equationModalTextarea.value);
            unmodifiedCymaticsEquation.set(false);
            showEquationModal.set(false);
        });

        showEquationHelpModal.listen((visible) => { document.getElementById('equationHelpModal').classList.toggle('hidden', !visible); });
        document.getElementById('equationHelpButton').addEventListener('click', () => { showEquationHelpModal.set(!showEquationHelpModal.get()); });
        document.getElementById('equationHelpModalX').addEventListener('click', () => { showEquationHelpModal.set(false); });

        // CONTROL PANEL / Fuzzy
        fuzzyLevel.subscribe((fuzzyVal) => {
            document.getElementById('fuzzyLevelDisplay').textContent = parseInt(fuzzyVal) + '%';
            document.getElementById('fuzzyInput').value = fuzzyVal;
            scheduleRepaint();
        });
        document.getElementById('fuzzyInput').addEventListener('input', (event) => {
            fuzzyLevel.set(event.target.value);
        });

        // CONTROL PANEL / Controls Help
        showControlsHelpModal.listen((visible) => { document.getElementById('controlsHelpModal').classList.toggle('hidden', !visible); });
        document.getElementById('controlsHelpButton').addEventListener('click', () => { showControlsHelpModal.set(!showControlsHelpModal.get()); });
        document.getElementById('controlsHelpModalX').addEventListener('click', () => { showControlsHelpModal.set(false); });

        // CONTROL PANEL / Show Axes
        showAxes.subscribe((show) => {
            const slider = document.getElementById('axesOnSlider');
            const toggleEl = document.getElementById('axesToggle');

            slider.classList.remove('translate-x-1', 'translate-x-7');
            slider.classList.add(show ? 'translate-x-7' : 'translate-x-1');

            toggleEl.classList.remove('bg-gray-500', 'bg-gray-800', 'bg-blue-600', 'bg-gray-200');
            toggleEl.classList.add(show ? 'bg-gray-800' : 'bg-gray-500');

            toggleEl.setAttribute('aria-checked', show);
        });

        document.getElementById('axesToggle').addEventListener('click', () => {
            showAxes.set(!showAxes.get());
            scheduleRepaint();
        });

        // CONTROL PANEL / Color map
        function getColorMapList() {
            // TODO: CUSTOM item which opens a textarea for js code function color(value, min, max)
            var colorMapList = Object.keys(js_colormaps_data);
            return colorMapList;
        }

        const colorMapSelect = document.getElementById('colorMapSelect');
        function renderOptions(selectedValue) {
            const colorMaps = getColorMapList();
            colorMapSelect.innerHTML = '';
            colorMaps.forEach((color) => {
                const option = document.createElement('option');
                option.value = color;
                option.textContent = color;
                option.selected = color === selectedValue;
                colorMapSelect.appendChild(option);
            });
        }
        colorMap.subscribe((value) => {
            renderOptions(value);
            scheduleRepaint();
        });
        colorMapSelect.addEventListener('change', (event) => {
            colorMap.set(event.target.value);
            scheduleRepaint();
        });

        // CONTROL PANEL / Invert color
        invertColor.subscribe((show) => {
            const slider = document.getElementById('invertColorSlider');
            const toggleEl = document.getElementById('invertColorButton');

            slider.classList.remove('translate-x-1', 'translate-x-7');
            slider.classList.add(show ? 'translate-x-7' : 'translate-x-1');

            toggleEl.classList.remove('bg-gray-500', 'bg-gray-800', 'bg-blue-600', 'bg-gray-200');
            toggleEl.classList.add(show ? 'bg-gray-800' : 'bg-gray-500');

            toggleEl.setAttribute('aria-checked', show);
        });

        document.getElementById('invertColorButton').addEventListener('click', () => {
            invertColor.set(!invertColor.get());
            scheduleRepaint();
        });

        // CONTROL PANEL / Color Map Help
        showColorMapHelpModal.listen((visible) => { document.getElementById('colorMapHelpModal').classList.toggle('hidden', !visible); });
        document.getElementById('colorMapHelpButton').addEventListener('click', () => { showColorMapHelpModal.set(!showColorMapHelpModal.get()); });
        document.getElementById('colorMapHelpModalX').addEventListener('click', () => { showColorMapHelpModal.set(false); });

        // CONTROL PANEL / Advanced Help
        showAdvancedHelpModal.listen((visible) => { document.getElementById('advancedHelpModal').classList.toggle('hidden', !visible); });
        document.getElementById('advancedHelpButton').addEventListener('click', () => { showAdvancedHelpModal.set(!showAdvancedHelpModal.get()); });
        document.getElementById('advancedHelpModalX').addEventListener('click', () => { showAdvancedHelpModal.set(false); });

        // Zoom In
        document.getElementById('zoomInButton').addEventListener('click', () => {
            yHeight.set(yHeight.get() * (1 / ZOOM_RATE));

            // If not in advancedMode, clear min and max overrides on zoom. The reason is because
            // the window changes, so the min and max values can change drastically.
            if (!advancedMode.get()) {
                clearMinAndMaxOverrides();
            }

            scheduleRepaint();
        });
        // Zoom Out
        document.getElementById('zoomOutButton').addEventListener('click', () => {
            yHeight.set(yHeight.get() * ZOOM_RATE);

            // If not in advancedMode, clear min and max overrides on zoom. The reason is because
            // the window changes, so the min and max values can change drastically.
            if (!advancedMode.get()) {
                clearMinAndMaxOverrides();
            }

            scheduleRepaint();
        });
        // Home
        document.getElementById('homeButton').addEventListener('click', () => {
            yHeight.set(yHeightAtZoom1);
            xCenter.set(0);
            yCenter.set(0);
            scheduleRepaint();
        });

        // Goto
        document.getElementById('gotoButton').addEventListener('click', () => {
            showGotoModal.set(true);
        });

        // // // // // // // Drag and drop to pan

        const canvas = document.getElementById('mainCanvas');
        const ctx = canvas.getContext('2d');
        let dragState = {
            isDragging: false,
            startX: 0,
            startY: 0,
            endX: 0,
            endY: 0
        };

        function drawArrow() {
            ctx.beginPath();
            ctx.moveTo(dragState.startX, dragState.startY);
            ctx.lineTo(dragState.endX, dragState.endY);
            ctx.strokeStyle = 'red';
            ctx.lineWidth = 2;
            ctx.stroke();

            // Draw arrowhead
            const angle = Math.atan2(dragState.endY - dragState.startY, dragState.endX - dragState.startX);
            const arrowSize = 10;
            ctx.beginPath();
            ctx.moveTo(dragState.endX, dragState.endY);
            ctx.lineTo(
                dragState.endX - arrowSize * Math.cos(angle - Math.PI / 6),
                dragState.endY - arrowSize * Math.sin(angle - Math.PI / 6)
            );
            ctx.moveTo(dragState.endX, dragState.endY);
            ctx.lineTo(
                dragState.endX - arrowSize * Math.cos(angle + Math.PI / 6),
                dragState.endY - arrowSize * Math.sin(angle + Math.PI / 6)
            );
            ctx.stroke();
        }

        function updatePosition(event) {
            const canvas = event.target;
            var xWidth = getXWidth(yHeight.get(), canvas.width, canvas.height);

            var xOffsetPixels = event.x - dragState.startX;
            var yOffsetPixels = event.y - dragState.startY;

            // First, we have to convert the offset in pixels into the offset in our graphing window
            var xOffset = xOffsetPixels * (xWidth / canvas.clientWidth);
            var yOffset = yOffsetPixels * (yHeight.get() / canvas.clientHeight);

            // Then we need to move the center of our graphing window accordingly
            xCenter.set(xCenter.get() - xOffset);
            yCenter.set(yCenter.get() + yOffset);  // Due to flipped y, negate yOffset (and -1*-1 = 1)

            dragState.isDragging = false;

            // TODO: No need for nanostores if we call directly
            scheduleRepaint();
        }

        // Get mouse position relative to canvas
        function getMousePos(event) {
            const rect = canvas.getBoundingClientRect();
            return {
                x: event.clientX - rect.left,
                y: event.clientY - rect.top
            };
        }

        // Mouse down event
        canvas.addEventListener('mousedown', (event) => {
            dragState.startX = event.x;
            dragState.startY = event.y;
            dragState.isDragging = true;
        });

        // Mouse up event
        canvas.addEventListener('mouseup', (event) => {
            dragState.isDragging = false;
            updatePosition(event)
        });

        // Mouse out event to stop dragging if mouse leaves canvas
        canvas.addEventListener('mouseout', () => {
            dragState.isDragging = false;
        });

        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Prevent scrolling
            const touch = e.touches[0];
            dragState.startX = touch.clientX;
            dragState.startY = touch.clientY;
            dragState.isDragging = true;
        });

        canvas.addEventListener('touchend', (e) => {
            dragState.isDragging = false;
            const touch = event.changedTouches[0];
            // Make event look like destktop so updatePosition(e) works
            e.x = touch.clientX;
            e.y = touch.clientY;
            updatePosition(e);
        });

        function countLeadingZeros(str) {
            const match = str.match(/^0*/);
            return match ? match[0].length : 0;
        }

        function getDecimalPart(str) {
            const parts = str.split('.');
            return parts.length > 1 ? parts[1] : '';
        }

        function getPrecision() {
            const errorRange = maxVal.get() - minVal.get();
            const errorRangeLeadingZeros = countLeadingZeros(getDecimalPart(errorRange.toString()));
            const yHeightVal = yHeight.get();
            const heightLeadingZeros = countLeadingZeros(getDecimalPart(yHeightVal.toString()));
            if (yHeightVal >= 0.01) {
                return 7;
            } else {
                return max(errorRangeLeadingZeros, heightLeadingZeros) + 3;
            }
        }

        // Show (x, y) = error when the mouse moves over the canvas
        // Mouse move event
        hoverMsg.listen((value) => {
            document.getElementById('hoverMsg').textContent = value;
        });

        canvas.addEventListener('mousemove', (event) => {
            // Don't overwrite the "Loading..." message
            if (isLoading.get()) return;

            const precision = getPrecision();

            const r = canvas.getBoundingClientRect();
            const sx = canvas.width / r.width, sy = canvas.height / r.height;
            const windowBounds = calcWindowBounds(xCenter.get(), yCenter.get(), yHeight.get(), canvas.width, canvas.height);
            var pixelToXMapper = makeLinearMapper([0, canvas.width], [windowBounds['xMin'], windowBounds['xMax']], false);
            var pixelToYMapper = makeLinearMapper([canvas.height, 0], [windowBounds['yMin'], windowBounds['yMax']], false);
            const xPixel = (event.clientX - r.left) * sx;
            const yPixel = (event.clientY - r.top) * sy;
            const x = pixelToXMapper(xPixel);
            const y = pixelToYMapper(yPixel);
            const xStr = x.toFixed(precision);
            const yStr = y.toFixed(precision);
            document.getElementById('hoverMsgDiv').style.display = 'block';

            const pixelValuesTemp = pixelValuesStore.get();
            if (pixelValuesTemp) {
                const errorVal = pixelValuesTemp[yPixel * canvas.width + xPixel]
                if (errorVal) {
                    const errorValStr = errorVal.toFixed(precision);
                    hoverMsg.set(`(${xStr}, ${yStr}): error = ${errorValStr}`);
                }
            }
        });

        canvas.addEventListener('mouseleave', (event) => {
            if (isLoading.get()) return;  // Don't overwrite "Loading..." message
            document.getElementById('hoverMsgDiv').style.display = 'none';
        });

        document.getElementById('clearEquationBtn').addEventListener('click', () => {
            equation.set('');
        });

        // // // // // // // Math Input logic
        const ta = document.getElementById('equationInput');
        const btn = document.getElementById('mathBtn');
        const pop = document.getElementById('mathPopover');
        const grid = document.getElementById('fnGrid');
        const filter = document.getElementById('mathFilter');
        const closeBtn = document.getElementById('closePopover');

        // Style function buttons
        function styleFnButtons() {
            grid.querySelectorAll('.fn').forEach(b => {
            Object.assign(b.style, {
                padding: '8px 10px',
                border: '1px solid #ddd',
                borderRadius: '8px',
                background: '#fafafa',
                cursor: 'pointer',
                fontSize: '13px',
                textAlign: 'center'
            });
            b.addEventListener('keydown', (e) => {
                if ((e.key === 'Enter' || e.key === ' ') && !e.repeat) {
                e.preventDefault();
                b.click();
                }
            });
            });
        }
        styleFnButtons();

          /** Utility: position popover near button */
      function positionPopover() {
        const rect = btn.getBoundingClientRect();
        const popWidth = pop.offsetWidth;
        const popHeight = pop.offsetHeight;

        // Try to align bottom-right of button with popover top-left
        let left = rect.right - popWidth;
        let top = rect.bottom + 6; // 6px gap

        // Ensure it doesn't overflow viewport
        left = Math.max(6, Math.min(left, window.innerWidth - popWidth - 6));
        top = Math.max(6, Math.min(top, window.innerHeight - popHeight - 6));

        pop.style.left = `${left}px`;
        pop.style.top = `${top}px`;
    }

    function isOpen() { return pop.style.display === 'block'; }
    function openPopover() {
        pop.style.display = 'block';
        pop.setAttribute('aria-hidden', 'false');
        btn.setAttribute('aria-expanded', 'true');
        positionPopover();
        requestAnimationFrame(() => filter.focus());
        window.addEventListener('resize', positionPopover);
        window.addEventListener('scroll', positionPopover, true);
        document.addEventListener('click', onClickOutside, { capture: true });
    }

    function closePopover() {
        pop.style.display = 'none';
        btn.setAttribute('aria-expanded', 'false');
        document.removeEventListener('click', onClickOutside, { capture: true });
        window.removeEventListener('resize', positionPopover);
        window.removeEventListener('scroll', positionPopover, true);
    }

    function onClickOutside(e) {
        if (!pop.contains(e.target) && e.target !== btn) closePopover();
    }

    // Toggle open/close
    btn.addEventListener('click', () => (isOpen() ? closePopover() : openPopover()));
    closeBtn.addEventListener('click', closePopover);

    // Keyboard shortcut: Ctrl/⌘+K
    document.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key.toLowerCase() === 'k') {
        e.preventDefault();
        isOpen() ? closePopover() : openPopover();
        }
    });

    // Filter search
    filter.addEventListener('input', () => {
        const q = filter.value.trim().toLowerCase();
        grid.querySelectorAll('.fn').forEach(b => {
        const t = (b.textContent + ' ' + (b.title || '')).toLowerCase();
        b.style.display = t.includes(q) ? '' : 'none';
        });
    });

    // Insert logic
    function insertOrWrap({ insert, wrapStart, wrapEnd }) {
        const start = ta.selectionStart ?? 0;
        const end = ta.selectionEnd ?? 0;
        const hasSelection = start !== end;
        let before = ta.value.slice(0, start);
        let selected = ta.value.slice(start, end);
        let after = ta.value.slice(end);

        if (wrapStart != null && wrapEnd != null) {
        const content = hasSelection ? selected : ' ';
        ta.value = before + wrapStart + content + wrapEnd + after;
        const cursorPos = before.length + wrapStart.length + (hasSelection ? content.length : 1);
        ta.focus();
        ta.setSelectionRange(cursorPos, cursorPos);
        } else if (insert != null) {
        ta.value = before + insert + after;
        const cursorPos = before.length + insert.length;
        ta.focus();
        ta.setSelectionRange(cursorPos, cursorPos);
        }
        ta.dispatchEvent(new Event('input', { bubbles: true }));
    }

    grid.addEventListener('click', (e) => {
        const b = e.target.closest('.fn');
        if (!b) return;
        insertOrWrap({
        insert: b.getAttribute('data-insert'),
        wrapStart: b.getAttribute('data-wrap-start'),
        wrapEnd: b.getAttribute('data-wrap-end')
        });
        ta.focus();
        });

        // // // // // // // Initialization

        function fitCanvasToDisplay(canvas) {
            const dpr = window.devicePixelRatio || 1;
            const rect = canvas.getBoundingClientRect();

            // Only touch backing store if it actually changed
            const newW = Math.max(1, Math.round(rect.width * dpr));
            const newH = Math.max(1, Math.round(rect.height * dpr));
            if (canvas.width !== newW || canvas.height !== newH) {
                canvas.width = newW;
                canvas.height = newH;
            }

            // Always draw in CSS pixels; map 1 unit = 1 CSS px
            const ctx = canvas.getContext('2d');
            ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
        }

        // Set canvas size to match its display size
        function resizeCanvas() {
            fitCanvasToDisplay(canvas);
            scheduleRepaint();
        }

        // Resize canvas when window is resized
        // window.addEventListener('resize', resizeCanvas);

        /////////////////////////////////////////////////////////////////////////////////////// URL Handling

        function getAppConfig() {
            var graphConfig = {
                equation: getStrippedEquation(),
                fuzzyLevel: fuzzyLevel.get(),
                colorMap: colorMap.get(),
                invertColor: invertColor.get(),
                xCenter: xCenter.get(),
                yCenter: yCenter.get(),
                yHeight: yHeight.get(),
                showAxes: showAxes.get(),
                advancedMode: advancedMode.get(),
                minOverride: minOverride.get(),
                maxOverride: maxOverride.get(),
                version: version
            };

            if (unmodifiedCymaticsEquation.get()) {
                graphConfig['cymaticsConfig'] = cymaticsConfig.get();
                // NOTE: No need to include a long equation if we can just load it from the cymaticsConfig
                delete graphConfig.equation;
            }

            return graphConfig;
        }

        function getParameterByName(name, url) {
            if (!url) url = window.location.href;
            name = name.replace(/[\[\]]/g, "\\$&");
            var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
            var results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, " "));
        }

        function isBooleanString(str) {
            return /^(true|false)$/i.test(str);
        }

        function parseUrlParam(param, value) {
            if (value === null || value === '') return undefined;

            // Handle JSON arrays (e.g., for equations)
            if (value.startsWith('[') && value.endsWith(']')) {
                try {
                    return JSON.parse(value);
                } catch (e) {
                    console.warn(`Failed to parse JSON for param ${param}: ${value}`);
                    return value;
                }
            }

            // Handle booleans
            if (isBooleanString(value)) {
                return JSON.parse(value.toLowerCase());
            }

            // Handle numbers
            if (!isNaN(value) && value.trim() !== '') {
                return parseFloat(value);
            }

            // Return as string for other cases
            return value;
        }

        function setConfigFromObj(configObj) {
            // Update stores
            if (configObj['equation'] !== null && typeof configObj['equation'] !== 'undefined') {
                equation.set(configObj['equation']);
            }
            if (configObj['fuzzyLevel'] !== null && typeof configObj['fuzzyLevel'] !== 'undefined') {
                fuzzyLevel.set(configObj['fuzzyLevel']);
            }
            if (configObj['showAxes'] !== null && typeof configObj['showAxes'] !== 'undefined') {
                showAxes.set(configObj['showAxes']);
            }
            if (configObj['colorMap'] !== null && typeof configObj['colorMap'] !== 'undefined') {
                colorMap.set(configObj['colorMap']);
            }
            if (configObj['invertColor'] !== null && typeof configObj['invertColor'] !== 'undefined') {
                invertColor.set(configObj['invertColor']);
            }
            if (configObj['xCenter'] !== null && typeof configObj['xCenter'] !== 'undefined') {
                xCenter.set(configObj['xCenter']);
            }
            if (configObj['yCenter'] !== null && typeof configObj['yCenter'] !== 'undefined') {
                yCenter.set(configObj['yCenter']);
            }
            if (configObj['yHeight'] !== null && typeof configObj['yHeight'] !== 'undefined') {
                yHeight.set(configObj['yHeight']);
            }
            if (configObj['advancedMode'] != null && typeof configObj['advancedMode'] !== 'undefined') {
                advancedMode.set(configObj['advancedMode']);
            }
            if (configObj['minOverride'] != null && typeof configObj['minOverride'] !== 'undefined') {
                minOverride.set(configObj['minOverride']);
            }
            if (configObj['maxOverride'] != null && typeof configObj['maxOverride'] !== 'undefined') {
                maxOverride.set(configObj['maxOverride']);
            }
            if (configObj['cymaticsConfig'] != null && typeof configObj['cymaticsConfig'] !== 'undefined') {
                cymaticsConfig.set(configObj['cymaticsConfig']);
                // If this was a cymatics equation, load the equation from the cymatics config
                const cymaticsEqStr = get_cymatics_equation_generator(cymaticsConfig.get());
                equation.set(cymaticsEqStr);
            }

        }

        function setParamsFromUrl() {
            const urlFragmentId = window.location.hash.substr(1);
            const appConfig = getAppConfig();
            const configFromUrl = {};

            // Parse each parameter from the URL
            for (const param in appConfig) {
                if (appConfig.hasOwnProperty(param)) {
                    const paramValue = getParameterByName(param, urlFragmentId);
                    if (paramValue !== null && paramValue != '') {
                        configFromUrl[param] = parseUrlParam(param, paramValue);
                    }
                }
            }

            const raw = getParameterByName("cymaticsConfig", urlFragmentId);
            let cymaticsConfigObj = null;
            if (raw) {
                try {
                    cymaticsConfigObj = JSON.parse(decodeURIComponent(raw));
                } catch (e) {
                    console.warn("Invalid cymaticsConfig JSON");
                }
            }

            configFromUrl.cymaticsConfig = cymaticsConfigObj;

            setConfigFromObj(configFromUrl);

            if (getParameterByName('download', urlFragmentId) != null) {
                const w = getParameterByName('w');
                const h = getParameterByName('h');
                const cX = getParameterByName('cx');
                const cY = getParameterByName('cy');
                const yH = getParameterByName('yh');
                saveImage(w, h, cX, cY, yH);
            }
        }

        function getShareUrl() {
            var appConfig = getAppConfig();

            if (appConfig.cymaticsConfig) {
                const cymaticsConfStr = encodeURIComponent(JSON.stringify(appConfig.cymaticsConfig));
                appConfig.cymaticsConfig = cymaticsConfStr;
            }

            if (appConfig['minOverride'] == null || appConfig['minOverride'] == '') {
                appConfig['minOverride'] = minVal.get();
            }
            if (appConfig['maxOverride'] == null || appConfig['maxOverride'] == '') {
                appConfig['maxOverride'] = maxVal.get();
            }

            const params = new URLSearchParams();
            for (const [key, value] of Object.entries(appConfig)) {
                const paramValue = Array.isArray(value) ? JSON.stringify(value) : value;
                params.append(key, paramValue);
            }
            const paramStr = `?${params.toString()}`;
            return `https://fuzzygraph.com/v${version}.html${paramStr}`;
        }

        setParamsFromUrl();

        const ro = new ResizeObserver(() => resizeCanvas());
        ro.observe(document.getElementById('overCanvasControls'));
        ro.observe(document.getElementById('mainCanvas'));

        function removeResizeObserver() {
            ro.unobserve(document.getElementById('overCanvasControls'));
            ro.unobserve(document.getElementById('mainCanvas'));
            ro.disconnect();
        }

        window.addEventListener('load', () => {
            requestAnimationFrame(() => {
                resizeCanvas();
                if (document.fonts && document.fonts.ready) {
                    document.fonts.ready.then(resizeCanvas);
                }
            });
        });


        // Cymatics
        function drawResonatorPointsOnCanvas(canvasId, cfg) {
        const canvas = document.getElementById(canvasId);
        if (!canvas) return;

        const ctx = canvas.getContext('2d');
        const width = canvas.width;
        const height = canvas.height;

        // Clear canvas
        ctx.clearRect(0, 0, width, height);

        // Background
        ctx.fillStyle = '#f9fafb'; // gray-50-ish
        ctx.fillRect(0, 0, width, height);

        const centerX = width / 2;
        const centerY = height / 2;

        const points = uniformly_distributed_points(
            cfg.numResonators,
            cfg.distance,
            cfg.rotateRadians
        );

        let maxRadius = Math.abs(cfg.distance);
        if (maxRadius === 0) maxRadius = 1;
        const scale = (Math.min(width, height) * 0.4) / maxRadius;

        // Axes
        ctx.strokeStyle = '#e5e7eb'; // gray-200
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(centerX, 0);
        ctx.lineTo(centerX, height);
        ctx.moveTo(0, centerY);
        ctx.lineTo(width, centerY);
        ctx.stroke();

        // Origin
        ctx.fillStyle = '#9ca3af'; // gray-400
        ctx.beginPath();
        ctx.arc(centerX, centerY, 3, 0, 2 * Math.PI);
        ctx.fill();

        // Points
        ctx.fillStyle = '#111827'; // gray-900
        points.forEach((p) => {
            const cx = centerX + p.x * scale;
            const cy = centerY - p.y * scale;
            ctx.beginPath();
            ctx.arc(cx, cy, 4, 0, 2 * Math.PI);
            ctx.fill();
        });
    }

    function get_cymatics_equation_generator(cfg) {
        const eqStr = cymatics_equation_generator(
            cfg.numResonators,
            cfg.distance,
            cfg.amplitude,
            cfg.frequency,
            cfg.phase,
            cfg.combineOperator,
            cfg.rotateRadians
        );

        return eqStr;
    }

    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('cymaticsModal');
        const openBtn = document.getElementById('openCymaticsModal');
        const closeBtn = document.getElementById('cymaticsModalClose');
        const insertBtn = document.getElementById('insertCymaticsEquationButton');

        const numInput = document.getElementById('numResonatorsInput');
        const distanceInput = document.getElementById('distanceInput');
        const amplitudeInput = document.getElementById('amplitudeInput');
        const frequencyInput = document.getElementById('frequencyInput');
        const phaseInput = document.getElementById('phaseInput');
        const combineInput = document.getElementById('combineOperatorInput');
        const rotateInput = document.getElementById('rotateRadiansInput');

        // Initialize inputs from store
        const initial = cymaticsConfig.get();
        numInput.value = initial.numResonators;
        distanceInput.value = initial.distance;
        amplitudeInput.value = initial.amplitude;
        frequencyInput.value = initial.frequency;
        phaseInput.value = initial.phase;
        combineInput.value = initial.combineOperator;
        rotateInput.value = initial.rotateRadians;

        // Sync modal visibility with store
        showCymaticsModal.subscribe((isOpen) => {
            if (!modal) return;
            if (isOpen) {
                modal.classList.remove('hidden');
                drawResonatorPointsOnCanvas('resonatorCanvas', cymaticsConfig.get());
            } else {
                modal.classList.add('hidden');
            }
        });

        // Open / close via buttons
        if (openBtn) {
            openBtn.addEventListener('click', () => {
                closePopover();
                showCymaticsModal.set(true);
            });
        }
        if (closeBtn) closeBtn.addEventListener('click', () => showCymaticsModal.set(false));

        // Click on overlay closes modal
        // if (modal) {
        //     modal.addEventListener('click', (e) => {
        //         if (e.target === modal) {
        //             e.preventDefault();
        //             e.stopPropagation();
        //             showCymaticsModal.set(false);
        //         }
        //     });
        // }

        // On each input change, update store
        numInput.addEventListener('input', (e) => {
            cymaticsConfig.setKey('numResonators', Number(e.target.value || 0));
        });
        distanceInput.addEventListener('input', (e) => {
            cymaticsConfig.setKey('distance', Number(e.target.value || 0));
        });
        amplitudeInput.addEventListener('input', (e) => {
            cymaticsConfig.setKey('amplitude', Number(e.target.value || 0));
        });
        frequencyInput.addEventListener('input', (e) => {
            cymaticsConfig.setKey('frequency', Number(e.target.value || 0));
        });
        phaseInput.addEventListener('input', (e) => {
            cymaticsConfig.setKey('phase', Number(e.target.value || 0));
        });
        combineInput.addEventListener('change', (e) => {
            cymaticsConfig.setKey('combineOperator', e.target.value);
        });
        rotateInput.addEventListener('input', (e) => {
            cymaticsConfig.setKey('rotateRadians', Number(e.target.value || 0));
        });

        // Whenever layout-related config changes, redraw canvas
        cymaticsConfig.subscribe((cfg) => {
            drawResonatorPointsOnCanvas('resonatorCanvas', cfg);
        });

        // Insert equation button: use store-backed function, then close modal
        if (insertBtn) {
            insertBtn.addEventListener('click', () => {
                const cfg = cymaticsConfig.get();
                const cymaticsEqStr = get_cymatics_equation_generator(cfg);
                equation.set(cymaticsEqStr);
                unmodifiedCymaticsEquation.set(true);
                showCymaticsModal.set(false);
            });
        }
    });

    </script>
</body>

</html>
